<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SettleUp - Split Bills in USDC</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f8fa; color: #222; }
    input, button { margin: 6px 0; padding: 8px; font-size: 15px; width: 100%; }
    .card { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
    h2 { color: #2d6cdf; }
    button { background: #2d6cdf; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { background: #1f4fa3; }
    pre { background: #f1f1f1; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>üí∏ SettleUp ‚Äì Split Bills in USDC</h1>
  
  <div class="card">
    <h2>1Ô∏è‚É£ Connect Wallet</h2>
    <button id="connectBtn">Connect MetaMask</button>
    <p id="account"></p>
  </div>

  <div class="card">
    <h2>2Ô∏è‚É£ Add Expense</h2>
    <input type="text" id="amount" placeholder="Amount (USDC)" />
    <input type="text" id="friends" placeholder="Friends (comma-separated addresses)" />
    <button id="addExpenseBtn">Add Expense</button>
  </div>

  <div class="card">
    <h2>3Ô∏è‚É£ Balances</h2>
    <button id="refreshBalancesBtn">Refresh Balances</button>
    <pre id="balances"></pre>
  </div>

  <script>
    const contractAddress = "0xdfA5b290290762bb84082Da7Fd7cEc94fbe97E54";

    const contractABI = [
      {"inputs":[{"internalType":"address","name":"usdcAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"address[]","name":"participants","type":"address[]"}],"name":"ExpenseAdded","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"member","type":"address"}],"name":"MemberAdded","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"PotWithdrawn","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Settled","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"finalizer","type":"address"}],"name":"TripFinalized","type":"event"},
      {"inputs":[],"name":"MAX_MEMBERS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"USDC","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"address","name":"payer","type":"address"},{"internalType":"address[]","name":"participants","type":"address[]"}],"name":"addExpense","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"creator","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"finalizeTrip","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"finalized","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"getFinalSummary","outputs":[{"internalType":"address[]","name":"who","type":"address[]"},{"internalType":"int256[]","name":"netAmount","type":"int256[]"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"getMyBalances","outputs":[{"internalType":"address[]","name":"creditors","type":"address[]"},{"internalType":"int256[]","name":"amounts","type":"int256[]"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"members","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"creditor","type":"address"}],"name":"settle","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"withdrawPot","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"stateMutability":"payable","type":"receive"}
    ];

    let provider, signer, contract, account;

    async function connectWallet() {
      if (!window.ethereum) {
        alert("MetaMask not detected.");
        return;
      }
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      account = await signer.getAddress();
      document.getElementById("account").textContent = `Connected: ${account}`;
      contract = new ethers.Contract(contractAddress, contractABI, signer);
    }

    async function addExpense() {
      const amountInput = document.getElementById("amount").value.trim();
      const friendInput = document.getElementById("friends").value.trim();

      if (!amountInput || !friendInput) {
        alert("Enter amount and at least one friend address.");
        return;
      }

      const amount = ethers.utils.parseUnits(amountInput, 6); // USDC has 6 decimals
      const friends = friendInput.split(",").map(a => a.trim()).filter(a => a);

      // üîÅ Temporary Frontend Fix ‚Äî invert logic direction
      const fakePayer = friends[0];
      const participants = [account, ...friends.slice(1)];

      try {
        const tx = await contract.addExpense(amount, fakePayer, participants);
        await tx.wait();
        alert("‚úÖ Expense added (frontend fix applied)");
      } catch (err) {
        console.error(err);
        alert("Transaction failed: " + (err.message || err));
      }
    }

    async function refreshBalances() {
      try {
        const [creditors, amounts] = await contract.getMyBalances();
        let out = "";
        for (let i = 0; i < creditors.length; i++) {
          const val = ethers.utils.formatUnits(amounts[i], 6);
          if (parseFloat(val) > 0)
            out += `üü¢ You are owed ${val} USDC by ${creditors[i]}\n`;
          else if (parseFloat(val) < 0)
            out += `üî¥ You owe ${Math.abs(val)} USDC to ${creditors[i]}\n`;
        }
        document.getElementById("balances").textContent = out || "No balances yet.";
      } catch (err) {
        console.error(err);
        alert("Failed to fetch balances");
      }
    }

    document.getElementById("connectBtn").onclick = connectWallet;
    document.getElementById("addExpenseBtn").onclick = addExpense;
    document.getElementById("refreshBalancesBtn").onclick = refreshBalances;
  </script>
</body>
</html>
