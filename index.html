<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SettleUp - Split Bills in USDC</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .glass { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(12px); border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.2); }
    .gradient-btn { background: linear-gradient(45deg, #ff6b6b, #feca57); transition: all 0.3s; }
    .gradient-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    .avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(45deg, #a8edea, #fed6e3); display: flex; align-items: center; justify-content: center; font-weight: bold; color: #333; }
  </style>
</head>
<body class="text-white">

  <div class="container mx-auto p-4 max-w-2xl">

    <!-- HEADER -->
    <div class="text-center mb-8 mt-8">
      <h1 class="text-5xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-pink-500">SettleUp</h1>
      <p class="text-lg opacity-90">Split bills. Pay in USDC. Settle instantly.</p>
    </div>

    <!-- CONNECT WALLET -->
    <div id="connectCard" class="glass p-6 text-center mb-6">
      <button id="connectBtn" class="gradient-btn text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg">
        Connect Wallet
      </button>
      <p id="wallet" class="mt-4 text-sm opacity-80"></p>
    </div>

    <!-- TRIP INFO -->
    <div id="tripCard" class="glass p-6 mb-6" style="display:none;">
      <h2 class="text-2xl font-bold mb-4 flex items-center">
        <span class="mr-2">Trip</span>
        <span id="creatorBadge" class="text-xs bg-green-500 text-white px-2 py-1 rounded-full" style="display:none;">Creator</span>
      </h2>
      <p class="text-sm opacity-80">Contract: <span id="contractAddr" class="font-mono text-xs"></span></p>
    </div>

    <!-- ADD EXPENSE -->
    <div id="expenseCard" class="glass p-6 mb-6" style="display:none;">
      <h3 class="text-xl font-bold mb-4">Add Expense</h3>
      <input id="amount" type="number" step="0.01" placeholder="45.00" class="w-full p-3 rounded-lg bg-white/20 backdrop-blur text-white placeholder-white/60 mb-3">
      
      <div class="mb-4">
        <p class="text-sm mb-2">Whoâ€™s in?</p>
        <div id="friendsList" class="flex flex-wrap gap-2"></div>
      </div>

      <button id="addExpenseBtn" class="w-full gradient-btn text-white font-bold py-3 rounded-lg">
        Record Expense
      </button>
    </div>

    <!-- BALANCES -->
    <div id="balancesCard" class="glass p-6 mb-6" style="display:none;">
      <h3 class="text-xl font-bold mb-4">Your Balances</h3>
      <div id="balances" class="space-y-3"></div>
    </div>

    <!-- FINALIZE -->
    <div id="finalizeCard" class="glass p-6 mb-6" style="display:none;">
      <button id="finalizeBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg">
        End Trip (Creator Only)
      </button>
    </div>

    <!-- FINAL SUMMARY -->
    <div id="summaryCard" class="glass p-6" style="display:none;">
      <h3 class="text-xl font-bold mb-4">Final Summary</h3>
      <div id="summary" class="space-y-3"></div>
      <button id="settleAllBtn" class="w-full gradient-btn text-white font-bold py-3 rounded-lg mt-4">
        Settle All My Debts
      </button>
    </div>

  </div>

  <script>
    const CONTRACT_ADDR = "0x56F7f5e5A69b7Bae270355A731fD7DAcE8B09aDB";
    const USDC_ADDR = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";

    // PASTE FULL ABI FROM REMIX HERE
    const ABI = [
      "constructor(address usdcAddress)",
      "function addExpense(uint256 amount, address payer, address[] participants)",
      "function settle(address creditor)",
      "function finalizeTrip()",
      "function getFinalSummary() view returns (address[], int256[])",
      "function creator() view returns (address)",
      "function finalized() view returns (bool)",
      "function members() view returns (address[])",
      "event ExpenseAdded(address indexed payer, uint256 amount, address[] participants)",
      "event Settled(address indexed from, address indexed to, uint256 amount)",
      "event TripFinalized(address indexed finalizer)"
    ];

    let provider, signer, contract, account, isCreator = false;
    const friends = JSON.parse(localStorage.getItem("settleup_friends") || "{}");

    async function connect() {
      if (!window.ethereum) return alert("Install MetaMask!");
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      const network = await provider.getNetwork();
      if (network.chainId !== 8453) return alert("Switch to Base Mainnet");
      
      signer = provider.getSigner();
      account = await signer.getAddress();
      contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);

      document.getElementById("wallet").innerHTML = `<strong>${account.slice(0,6)}...${account.slice(-4)}</strong>`;
      document.getElementById("contractAddr").textContent = CONTRACT_ADDR;
      document.getElementById("connectCard").style.display = "none";

      const creator = await contract.creator();
      isCreator = creator.toLowerCase() === account.toLowerCase();
      if (isCreator) document.getElementById("creatorBadge").style.display = "inline";

      showSection("tripCard");
      loadFriends();
      loadBalances();
      checkFinalized();
    }

    function showSection(id) {
      document.getElementById(id).style.display = "block";
    }

    function loadFriends() {
      const list = document.getElementById("friendsList");
      list.innerHTML = Object.keys(friends).map(name => {
        const addr = friends[name];
        return `<label class="flex items-center bg-white/10 px-3 py-2 rounded-lg cursor-pointer">
          <input type="checkbox" value="${addr}" class="mr-2">
          <span class="text-sm">${name}</span>
        </label>`;
      }).join('');
      if (Object.keys(friends).length < 10) {
        list.innerHTML += `<button onclick="addFriend()" class="bg-white/20 px-3 py-2 rounded-lg text-sm">+</button>`;
      }
    }

    window.addFriend = () => {
      const name = prompt("Name:");
      const addr = prompt("Address:");
      if (name && ethers.utils.isAddress(addr)) {
        friends[name] = addr;
        localStorage.setItem("settleup_friends", JSON.stringify(friends));
        loadFriends();
      }
    };

    document.getElementById("addExpenseBtn").onclick = async () => {
      const amount = document.getElementById("amount").value;
      const selected = Array.from(document.querySelectorAll("#friendsList input:checked")).map(cb => cb.value);
      if (!amount || selected.length === 0) return alert("Fill all!");
      const tx = await contract.addExpense(ethers.utils.parseUnits(amount, 6), account, selected);
      await tx.wait();
      confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
      document.getElementById("amount").value = "";
      loadBalances();
    };

    async function loadBalances() {
      try {
        const [addrs, bals] = await contract.getMyBalances();
        const div = document.getElementById("balances");
        div.innerHTML = addrs.map((a, i) => {
          const amt = ethers.utils.formatUnits(bals[i].abs(), 6);
          const sign = bals[i].gt(0) ? "owe" : "owed by";
          return `<div class="flex justify-between items-center p-3 bg-white/10 rounded-lg">
            <span class="font-mono text-sm">${a.slice(0,6)}...</span>
            <span class="${bals[i].gt(0) ? 'text-red-400' : 'text-green-400'} font-bold">$${amt} ${sign}</span>
          </div>`;
        }).join('');
        showSection("balancesCard");
      } catch (e) {
        console.log("No balances yet");
      }
    }

    async function checkFinalized() {
      const finalized = await contract.finalized();
      if (finalized) {
        document.getElementById("expenseCard").style.display = "none";
        document.getElementById("finalizeCard").style.display = "none";
        loadSummary();
      } else {
        showSection("expenseCard");
        if (isCreator) {
          showSection("finalizeCard");
          document.getElementById("finalizeBtn").onclick = async () => {
            const tx = await contract.finalizeTrip();
            await tx.wait();
            confetti();
            loadSummary();
          };
        }
      }
    }

    async function loadSummary() {
      const [who, net] = await contract.getFinalSummary();
      const div = document.getElementById("summary");
      div.innerHTML = who.map((w, i) => {
        const amt = ethers.utils.formatUnits(net[i].abs(), 6);
        const sign = net[i].gt(0) ? "Pay" : "Receive";
        return `<div class="flex justify-between items-center p-3 bg-white/10 rounded-lg">
          <span class="font-mono text-sm">${w.slice(0,6)}...</span>
          <span class="${net[i].gt(0) ? 'text-red-400' : 'text-green-400'} font-bold">$${amt} ${sign}</span>
        </div>`;
      }).join('');
      showSection("summaryCard");

      document.getElementById("settleAllBtn").onclick = async () => {
        const [addrs, bals] = await contract.getMyBalances();
        for (let i = 0; i < bals.length; i++) {
          if (bals[i].gt(0)) {
            const tx = await contract.settle(addrs[i]);
            await tx.wait();
          }
        }
        confetti({ particleCount: 200, spread: 100 });
        alert("All settled!");
      };
    }

    document.getElementById("connectBtn").onclick = connect;
  </script>
</body>
</html>
