<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SettleUp - Split Bills in USDC</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 500px; margin: 0 auto; }
    .card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 { text-align: center; color: white; margin-bottom: 20px; font-size: 28px; }
    h2 { font-size: 18px; margin-bottom: 16px; color: #333; }
    .form-group { margin-bottom: 16px; }
    label { display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 6px; text-transform: uppercase; }
    .label-hint { font-size: 11px; color: #999; font-weight: normal; text-transform: none; }
    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
    }
    input:focus, select:focus { outline: none; border-color: #667eea; }
    button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background: #f0f0f0; color: #333; }
    .btn-green { background: #10b981; color: white; }
    .status { padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 14px; }
    .status.success { background: #d1fae5; color: #065f46; }
    .status.error { background: #fee2e2; color: #991b1b; }
    .status.info { background: #dbeafe; color: #1e40af; }
    .balance-card {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .balance-amount { font-size: 20px; font-weight: 700; }
    .balance-amount.positive { color: #059669; }
    .balance-amount.negative { color: #dc2626; }
    .balance-details { font-size: 14px; color: #6b7280; margin-top: 4px; }
    .contact-chip {
      display: inline-block;
      padding: 8px 14px;
      background: #f3f4f6;
      border: 2px solid #e5e7eb;
      border-radius: 20px;
      margin: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .contact-chip:hover { border-color: #667eea; background: #ede9fe; }
    .contact-chip.selected { background: #667eea; color: white; border-color: #667eea; }
    .info-box {
      background: #fef3c7;
      border: 2px solid #fcd34d;
      border-radius: 10px;
      padding: 12px;
      font-size: 13px;
      color: #92400e;
      margin-bottom: 16px;
    }
    #log { 
      background: #1f2937; 
      color: #10b981; 
      padding: 12px; 
      border-radius: 8px; 
      font-family: monospace; 
      font-size: 12px; 
      max-height: 200px; 
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 10px;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üí∞ SettleUp</h1>

    <!-- Connect Wallet -->
    <div class="card" id="connectCard">
      <h2>üîó Connect Wallet</h2>
      <button class="btn-primary" id="connectBtn">Connect MetaMask</button>
      <div id="connectStatus"></div>
    </div>

    <!-- Wallet Info -->
    <div class="card hidden" id="walletCard">
      <h2>üëõ Wallet Connected</h2>
      <div id="walletInfo"></div>
    </div>

    <!-- Add Expense -->
    <div class="card hidden" id="expenseCard">
      <h2>üìù Add Expense</h2>

      <div class="info-box">
        <strong>How it works:</strong> Enter the total bill. Select who paid. Select everyone who shared the meal/expense (including the payer). The cost is split equally.
      </div>

      <div class="form-group">
        <label>Total Amount (USDC)</label>
        <input type="number" id="expenseAmount" placeholder="100.00" step="0.01" />
      </div>

      <div class="form-group">
        <label>Category</label>
        <select id="expenseCategory">
          <option value="Food">üçï Food</option>
          <option value="Transport">üöó Transport</option>
          <option value="Entertainment">üé¨ Entertainment</option>
          <option value="Utilities">üí° Utilities</option>
          <option value="Other">üì¶ Other</option>
        </select>
      </div>

      <div class="form-group">
        <label>Who Paid? <span class="label-hint">(click one)</span></label>
        <div id="payerChips"></div>
      </div>

      <div class="form-group">
        <label>Who Shared the Bill? <span class="label-hint">(click all who participated, including payer)</span></label>
        <div id="participantChips"></div>
      </div>

      <div id="splitPreview" style="background:#f0fdf4;border:2px solid #86efac;border-radius:10px;padding:12px;margin-bottom:16px;font-size:14px;display:none;"></div>

      <button class="btn-primary" id="addExpenseBtn">üí≥ Record Expense</button>
      <div id="expenseStatus"></div>
    </div>

    <!-- Balances -->
    <div class="card hidden" id="balancesCard">
      <h2>üíµ Balances <button class="btn-secondary" id="refreshBtn" style="width:auto;float:right;padding:8px 16px;margin:0;">üîÑ Refresh</button></h2>
      <div style="clear:both;"></div>
      <div id="balancesList" style="margin-top:16px;"></div>
    </div>

    <!-- Contacts -->
    <div class="card hidden" id="contactsCard">
      <h2>üë• Contacts</h2>
      <div id="contactsList"></div>
      <div class="form-group" style="margin-top:16px;">
        <input type="text" id="newContactAddr" placeholder="Address (0x...)" />
        <input type="text" id="newContactName" placeholder="Name" style="margin-top:8px;" />
        <button class="btn-green" id="addContactBtn" style="margin-top:8px;">+ Add Contact</button>
      </div>
    </div>

    <!-- Debug Log -->
    <div class="card">
      <h2>üîç Debug Log</h2>
      <div id="log">Waiting for connection...</div>
    </div>
  </div>

  <script>
    // ========== CONFIGURATION ==========
    const CONTRACT_ADDRESS = "0x29197Af93e19dFF75e439aC6f79f3bb7dE7845CD";
    const USDC_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
    const BASE_RPC = "https://mainnet.base.org";
    const CATEGORIES = ["Food", "Transport", "Entertainment", "Utilities", "Other"];

    // ========== COMPLETE ABI ==========
    const CONTRACT_ABI = [
      {
        "inputs": [{"internalType": "address", "name": "usdcAddress", "type": "address"}],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true, "internalType": "address", "name": "creditor", "type": "address"},
          {"indexed": true, "internalType": "address", "name": "debtor", "type": "address"},
          {"indexed": false, "internalType": "uint256", "name": "newAmount", "type": "uint256"},
          {"indexed": false, "internalType": "string", "name": "category", "type": "string"}
        ],
        "name": "BalanceAdjusted",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true, "internalType": "address", "name": "payer", "type": "address"},
          {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"},
          {"indexed": false, "internalType": "address[]", "name": "participants", "type": "address[]"},
          {"indexed": false, "internalType": "string", "name": "category", "type": "string"}
        ],
        "name": "ExpenseAdded",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": true, "internalType": "address", "name": "debtor", "type": "address"},
          {"indexed": true, "internalType": "address", "name": "creditor", "type": "address"},
          {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"},
          {"indexed": false, "internalType": "string", "name": "category", "type": "string"}
        ],
        "name": "Settled",
        "type": "event"
      },
      {
        "inputs": [
          {"internalType": "uint256", "name": "amount", "type": "uint256"},
          {"internalType": "address", "name": "payer", "type": "address"},
          {"internalType": "address[]", "name": "participants", "type": "address[]"},
          {"internalType": "string", "name": "category", "type": "string"}
        ],
        "name": "addExpense",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "address", "name": "debtor", "type": "address"},
          {"internalType": "uint256", "name": "newAmount", "type": "uint256"},
          {"internalType": "string", "name": "category", "type": "string"}
        ],
        "name": "adjustBalance",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "address", "name": "", "type": "address"},
          {"internalType": "address", "name": "", "type": "address"},
          {"internalType": "string", "name": "", "type": "string"}
        ],
        "name": "balances",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "address", "name": "debtor", "type": "address"},
          {"internalType": "string", "name": "category", "type": "string"}
        ],
        "name": "creditFrom",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "address", "name": "creditor", "type": "address"},
          {"internalType": "string", "name": "category", "type": "string"}
        ],
        "name": "debtTo",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "address", "name": "debtor", "type": "address"},
          {"internalType": "address", "name": "creditor", "type": "address"},
          {"internalType": "string", "name": "category", "type": "string"}
        ],
        "name": "getBalance",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {"internalType": "address", "name": "creditor", "type": "address"},
          {"internalType": "string", "name": "category", "type": "string"}
        ],
        "name": "settle",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "usdc",
        "outputs": [{"internalType": "contract IERC20", "name": "", "type": "address"}],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    const USDC_ABI = [
      "function balanceOf(address) view returns (uint256)",
      "function allowance(address,address) view returns (uint256)",
      "function approve(address,uint256) returns (bool)"
    ];

    // ========== STATE ==========
    let readProvider, writeProvider, signer, readContract, writeContract, usdcContract;
    let account = null;
    let contacts = {};
    let selectedPayer = null;
    let selectedSplitters = [];

    // ========== LOGGING ==========
    function log(msg) {
      const logEl = document.getElementById("log");
      const time = new Date().toLocaleTimeString();
      logEl.textContent = `[${time}] ${msg}\n` + logEl.textContent;
      console.log(msg);
    }

    // ========== UTILITIES ==========
    function shortAddr(addr) {
      return addr ? addr.slice(0, 6) + "..." + addr.slice(-4) : "";
    }

    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.className = `status ${type}`;
      el.textContent = message;
    }

    function getContactName(addr) {
      return contacts[addr.toLowerCase()] || shortAddr(addr);
    }

    // ========== CONTACTS ==========
    function loadContacts() {
      const stored = localStorage.getItem("settleup_contacts_v3");
      if (stored) {
        try {
          contacts = JSON.parse(stored);
        } catch (e) {
          contacts = {};
        }
      }
    }

    function saveContacts() {
      localStorage.setItem("settleup_contacts_v3", JSON.stringify(contacts));
    }

    function addContact(addr, name) {
      if (!ethers.utils.isAddress(addr)) {
        alert("Invalid address");
        return;
      }
      const normalized = addr.toLowerCase();
      contacts[normalized] = name || shortAddr(addr);
      saveContacts();
      renderAll();
      log(`Added contact: ${name} (${shortAddr(addr)})`);
    }

    function renderContacts() {
      const list = document.getElementById("contactsList");
      list.innerHTML = "";

      Object.entries(contacts).forEach(([addr, name]) => {
        if (addr === account?.toLowerCase()) return;
        const div = document.createElement("div");
        div.style.cssText = "display:flex;justify-content:space-between;align-items:center;padding:8px;background:#f9fafb;border-radius:8px;margin-bottom:8px;";
        div.innerHTML = `
          <span><strong>${name}</strong><br><small style="color:#888;">${shortAddr(addr)}</small></span>
          <button onclick="deleteContact('${addr}')" style="background:#ef4444;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">‚úï</button>
        `;
        list.appendChild(div);
      });

      if (Object.keys(contacts).filter(a => a !== account?.toLowerCase()).length === 0) {
        list.innerHTML = "<p style='color:#888;font-size:14px;'>No contacts yet. Add friends to split bills with!</p>";
      }
    }

    function deleteContact(addr) {
      delete contacts[addr.toLowerCase()];
      saveContacts();
      renderAll();
    }

    // ========== CHIPS ==========
    function renderPayerChips() {
      const container = document.getElementById("payerChips");
      container.innerHTML = "";

      if (account) {
        const meChip = document.createElement("span");
        meChip.className = "contact-chip" + (selectedPayer === account.toLowerCase() ? " selected" : "");
        meChip.textContent = "üë§ Me";
        meChip.onclick = () => {
          selectedPayer = account.toLowerCase();
          renderAll();
        };
        container.appendChild(meChip);
      }

      Object.entries(contacts).forEach(([addr, name]) => {
        if (addr === account?.toLowerCase()) return;
        const chip = document.createElement("span");
        chip.className = "contact-chip" + (selectedPayer === addr ? " selected" : "");
        chip.textContent = name;
        chip.onclick = () => {
          selectedPayer = addr;
          renderAll();
        };
        container.appendChild(chip);
      });
    }

    function renderSplitterChips() {
      const container = document.getElementById("participantChips");
      container.innerHTML = "";

      if (account) {
        const meChip = document.createElement("span");
        meChip.className = "contact-chip" + (selectedSplitters.includes(account.toLowerCase()) ? " selected" : "");
        meChip.textContent = "üë§ Me";
        meChip.onclick = () => toggleSplitter(account.toLowerCase());
        container.appendChild(meChip);
      }

      Object.entries(contacts).forEach(([addr, name]) => {
        if (addr === account?.toLowerCase()) return;
        const chip = document.createElement("span");
        chip.className = "contact-chip" + (selectedSplitters.includes(addr) ? " selected" : "");
        chip.textContent = name;
        chip.onclick = () => toggleSplitter(addr);
        container.appendChild(chip);
      });
    }

    function toggleSplitter(addr) {
      const idx = selectedSplitters.indexOf(addr);
      if (idx >= 0) {
        selectedSplitters.splice(idx, 1);
      } else {
        selectedSplitters.push(addr);
      }
      renderAll();
    }

    function updateSplitPreview() {
      const preview = document.getElementById("splitPreview");
      const amountInput = document.getElementById("expenseAmount").value;
      const amount = parseFloat(amountInput) || 0;

      if (amount <= 0 || !selectedPayer || selectedSplitters.length === 0) {
        preview.style.display = "none";
        return;
      }

      const share = amount / selectedSplitters.length;
      const payerName = getContactName(selectedPayer);

      const debtors = selectedSplitters.filter(addr => addr !== selectedPayer);

      if (debtors.length === 0) {
        preview.innerHTML = `<strong>‚ö†Ô∏è No one owes anything</strong><br>Select at least one other person who shared the bill.`;
        preview.style.display = "block";
        return;
      }

      let html = `<strong>üí° Split Preview:</strong><br>`;
      html += `Total: $${amount.toFixed(2)} √∑ ${selectedSplitters.length} people = $${share.toFixed(2)} each<br><br>`;

      debtors.forEach(addr => {
        html += `‚Ä¢ ${getContactName(addr)} owes ${payerName}: <strong>$${share.toFixed(2)}</strong><br>`;
      });

      preview.innerHTML = html;
      preview.style.display = "block";
    }

    function renderAll() {
      renderContacts();
      renderPayerChips();
      renderSplitterChips();
      updateSplitPreview();
    }

    // ========== WALLET CONNECTION ==========
    async function connectWallet() {
      log("Connecting wallet...");

      if (!window.ethereum) {
        showStatus("connectStatus", "MetaMask not found!", "error");
        return;
      }

      try {
        readProvider = new ethers.providers.JsonRpcProvider(BASE_RPC);
        log("Read provider connected to Base RPC");

        writeProvider = new ethers.providers.Web3Provider(window.ethereum);
        await writeProvider.send("eth_requestAccounts", []);
        signer = writeProvider.getSigner();
        account = await signer.getAddress();
        log(`Wallet connected: ${shortAddr(account)}`);

        const network = await writeProvider.getNetwork();
        if (network.chainId !== 8453) {
          log("Wrong network, switching to Base...");
          try {
            await window.ethereum.request({
              method: "wallet_switchEthereumChain",
              params: [{ chainId: "0x2105" }]
            });
            location.reload();
            return;
          } catch (e) {
            showStatus("connectStatus", "Please switch to Base Mainnet!", "error");
            return;
          }
        }

        readContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);
        writeContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        usdcContract = new ethers.Contract(USDC_ADDRESS, USDC_ABI, signer);
        log("Contracts initialized");

        loadContacts();

        if (!contacts[account.toLowerCase()]) {
          contacts[account.toLowerCase()] = "Me";
          saveContacts();
        }

        selectedPayer = account.toLowerCase();
        selectedSplitters = [account.toLowerCase()];

        document.getElementById("connectCard").classList.add("hidden");
        document.getElementById("walletCard").classList.remove("hidden");
        document.getElementById("expenseCard").classList.remove("hidden");
        document.getElementById("balancesCard").classList.remove("hidden");
        document.getElementById("contactsCard").classList.remove("hidden");

        const usdcBal = await usdcContract.balanceOf(account);
        document.getElementById("walletInfo").innerHTML = `
          <p><strong>Address:</strong> ${shortAddr(account)}</p>
          <p><strong>USDC Balance:</strong> ${parseFloat(ethers.utils.formatUnits(usdcBal, 6)).toFixed(2)} USDC</p>
        `;

        renderAll();
        await refreshBalances();

        log("‚úÖ Ready! Add contacts and record expenses.");

      } catch (e) {
        log(`Error: ${e.message}`);
        showStatus("connectStatus", e.message, "error");
      }
    }

    // ========== ADD EXPENSE ==========
    async function addExpense() {
      const amountInput = document.getElementById("expenseAmount").value;
      const category = document.getElementById("expenseCategory").value;

      log("=== ADDING EXPENSE ===");

      if (!amountInput || parseFloat(amountInput) <= 0) {
        showStatus("expenseStatus", "Enter a valid amount", "error");
        return;
      }

      if (!selectedPayer) {
        showStatus("expenseStatus", "Select who paid", "error");
        return;
      }

      if (selectedSplitters.length < 2) {
        showStatus("expenseStatus", "Select at least 2 people who shared the bill", "error");
        return;
      }

      const participants = selectedSplitters.filter(addr => addr !== selectedPayer);

      if (participants.length === 0) {
        showStatus("expenseStatus", "No one owes the payer! Select others who shared the bill.", "error");
        return;
      }

      const amount = ethers.utils.parseUnits(amountInput, 6);
      const payerChecksum = ethers.utils.getAddress(selectedPayer);
      const participantsChecksum = participants.map(p => ethers.utils.getAddress(p));

      log(`Amount: ${amountInput} USDC`);
      log(`Category: ${category}`);
      log(`Payer: ${getContactName(selectedPayer)} (${shortAddr(selectedPayer)})`);
      log(`Participants (who owe): ${participants.map(p => getContactName(p)).join(", ")}`);

      const btn = document.getElementById("addExpenseBtn");
      btn.disabled = true;
      showStatus("expenseStatus", "Sending transaction...", "info");

      try {
        log("Calling contract.addExpense()...");
        const tx = await writeContract.addExpense(amount, payerChecksum, participantsChecksum, category);
        log(`TX sent: ${tx.hash}`);
        showStatus("expenseStatus", "Waiting for confirmation...", "info");

        const receipt = await tx.wait();
        log(`‚úÖ Confirmed in block ${receipt.blockNumber}`);

        showStatus("expenseStatus", `‚úÖ Expense recorded!`, "success");

        document.getElementById("expenseAmount").value = "";
        selectedSplitters = [account.toLowerCase()];
        renderAll();

        for (const p of participants) {
          if (!contacts[p.toLowerCase()] || contacts[p.toLowerCase()] === shortAddr(p)) {
            const name = prompt(`Save ${shortAddr(p)} as contact:`, shortAddr(p));
            if (name && name.trim()) {
              addContact(p, name.trim());
            }
          }
        }

        log("Waiting 3s for blockchain state update...");
        await new Promise(r => setTimeout(r, 3000));
        await refreshBalances();

      } catch (e) {
        log(`‚ùå Error: ${e.reason || e.message}`);
        showStatus("expenseStatus", `Error: ${e.reason || e.message}`, "error");
      } finally {
        btn.disabled = false;
      }
    }

    // ========== REFRESH BALANCES ==========
    async function refreshBalances() {
      log("=== REFRESHING BALANCES ===");
      const list = document.getElementById("balancesList");
      list.innerHTML = "<p>Loading...</p>";

      const balances = [];
      const contactAddrs = Object.keys(contacts).filter(a => a !== account.toLowerCase());

      if (contactAddrs.length === 0) {
        list.innerHTML = "<p style='color:#888;'>Add contacts to see balances with them.</p>";
        log("No contacts to check");
        return;
      }

      log(`Checking ${contactAddrs.length} contacts √ó ${CATEGORIES.length} categories...`);

      for (const contactAddr of contactAddrs) {
        for (const category of CATEGORIES) {
          try {
            await new Promise(r => setTimeout(r, 80));

            const contactChecksum = ethers.utils.getAddress(contactAddr);
            const accountChecksum = ethers.utils.getAddress(account);

            const theyOweUs = await readContract.getBalance(contactChecksum, accountChecksum, category);
            const weOweThem = await readContract.getBalance(accountChecksum, contactChecksum, category);

            if (!theyOweUs.isZero()) {
              const amt = ethers.utils.formatUnits(theyOweUs, 6);
              log(`‚úì ${getContactName(contactAddr)} owes you ${amt} USDC (${category})`);
              balances.push({ contact: contactAddr, category, type: "credit", amount: theyOweUs });
            }

            if (!weOweThem.isZero()) {
              const amt = ethers.utils.formatUnits(weOweThem, 6);
              log(`‚úì You owe ${getContactName(contactAddr)} ${amt} USDC (${category})`);
              balances.push({ contact: contactAddr, category, type: "debt", amount: weOweThem });
            }

          } catch (e) {
            log(`‚ö† Error ${shortAddr(contactAddr)}/${category}: ${e.message}`);
          }
        }
      }

      log(`Found ${balances.length} active balances`);

      if (balances.length === 0) {
        list.innerHTML = "<p style='color:#888;'>‚ú® All settled up! No outstanding balances.</p>";
        return;
      }

      list.innerHTML = "";
      for (const b of balances) {
        const contactName = getContactName(b.contact);
        const amountStr = parseFloat(ethers.utils.formatUnits(b.amount, 6)).toFixed(2);

        const card = document.createElement("div");
        card.className = "balance-card";

        if (b.type === "credit") {
          card.innerHTML = `
            <div class="balance-amount positive">+ ${amountStr} USDC</div>
            <div class="balance-details">${contactName} owes you ‚Ä¢ ${b.category}</div>
          `;
        } else {
          card.innerHTML = `
            <div class="balance-amount negative">- ${amountStr} USDC</div>
            <div class="balance-details">You owe ${contactName} ‚Ä¢ ${b.category}</div>
            <button class="btn-green" style="margin-top:10px;width:auto;padding:8px 16px;" onclick="settleBalance('${b.contact}', '${b.category}')">Pay Now</button>
          `;
        }

        list.appendChild(card);
      }
    }

    // ========== SETTLE ==========
    async function settleBalance(creditor, category) {
      const name = getContactName(creditor);
      if (!confirm(`Pay your ${category} balance to ${name}?`)) return;

      log(`Settling ${category} with ${name}...`);

      try {
        const creditorChecksum = ethers.utils.getAddress(creditor);
        const balance = await readContract.getBalance(account, creditorChecksum, category);
        const allowance = await usdcContract.allowance(account, CONTRACT_ADDRESS);

        if (allowance.lt(balance)) {
          log("Approving USDC...");
          const approveTx = await usdcContract.approve(CONTRACT_ADDRESS, ethers.constants.MaxUint256);
          await approveTx.wait();
          log("USDC approved");
        }

        const tx = await writeContract.settle(creditorChecksum, category);
        log(`TX sent: ${tx.hash}`);
        await tx.wait();
        log("‚úÖ Settled!");

        await new Promise(r => setTimeout(r, 2000));
        await refreshBalances();

        const usdcBal = await usdcContract.balanceOf(account);
        document.getElementById("walletInfo").innerHTML = `
          <p><strong>Address:</strong> ${shortAddr(account)}</p>
          <p><strong>USDC Balance:</strong> ${parseFloat(ethers.utils.formatUnits(usdcBal, 6)).toFixed(2)} USDC</p>
        `;

      } catch (e) {
        log(`‚ùå Error: ${e.reason || e.message}`);
        alert("Settlement failed: " + (e.reason || e.message));
      }
    }

    // ========== EVENT LISTENERS ==========
    document.getElementById("connectBtn").onclick = connectWallet;
    document.getElementById("addExpenseBtn").onclick = addExpense;
    document.getElementById("refreshBtn").onclick = refreshBalances;
    document.getElementById("expenseAmount").oninput = updateSplitPreview;

    document.getElementById("addContactBtn").onclick = () => {
      const addr = document.getElementById("newContactAddr").value.trim();
      const name = document.getElementById("newContactName").value.trim();
      if (addr) {
        addContact(addr, name || shortAddr(addr));
        document.getElementById("newContactAddr").value = "";
        document.getElementById("newContactName").value = "";
      } else {
        alert("Enter an address");
      }
    };

    window.onload = () => {
      if (window.ethereum) {
        log("MetaMask detected. Click Connect to start.");
      }
    };
  </script>
</body>
</html>
