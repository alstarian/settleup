<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SettleUp - Split Bills in USDC</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #1f2937;
    }
    
    .container {
      max-width: 480px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 32px;
      animation: fadeIn 0.6s ease-out;
    }
    
    .logo {
      font-size: 48px;
      margin-bottom: 8px;
    }
    
    h1 {
      color: white;
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .subtitle {
      color: rgba(255,255,255,0.9);
      font-size: 14px;
    }
    
    .card {
      background: white;
      border-radius: 24px;
      padding: 28px;
      margin-bottom: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.6s ease-out;
      animation-fill-mode: backwards;
    }
    
    .card:nth-child(2) { animation-delay: 0.1s; }
    .card:nth-child(3) { animation-delay: 0.2s; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .wallet-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border-radius: 16px;
      margin-bottom: 24px;
      border: 2px solid #86efac;
    }
    
    .wallet-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .wallet-address {
      font-weight: 600;
      color: #15803d;
      font-size: 14px;
    }
    
    .usdc-balance {
      font-size: 12px;
      color: #16a34a;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .input-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
      transition: all 0.2s;
      background: #f9fafb;
    }
    
    input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    
    input::placeholder {
      color: #9ca3af;
    }
    
    button {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }
    
    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: #e5e7eb;
    }
    
    .btn-approve {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      margin-bottom: 16px;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .loading {
      pointer-events: none;
    }
    
    .loading::after {
      content: '';
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-left: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .status-message {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .status-message.success {
      background: #f0fdf4;
      color: #15803d;
      border: 2px solid #86efac;
    }
    
    .status-message.error {
      background: #fef2f2;
      color: #dc2626;
      border: 2px solid #fca5a5;
    }
    
    .status-message a {
      color: #667eea;
      font-weight: 600;
      text-decoration: none;
    }
    
    .balance-list {
      margin-top: 20px;
    }
    
    .balance-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }
    
    .balance-item:hover {
      border-color: #d1d5db;
      background: white;
    }
    
    .balance-info {
      flex: 1;
    }
    
    .balance-amount {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .balance-amount.positive {
      color: #15803d;
    }
    
    .balance-amount.negative {
      color: #dc2626;
    }
    
    .balance-address {
      font-size: 12px;
      color: #6b7280;
      font-family: 'Courier New', monospace;
    }
    
    .balance-tag {
      font-size: 11px;
      color: #9ca3af;
      font-style: italic;
      margin-top: 4px;
    }
    
    .btn-settle {
      padding: 10px 20px;
      background: #10b981;
      color: white;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      min-width: 80px;
    }
    
    .btn-settle:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards;
      max-width: 90%;
    }
    
    @keyframes toastIn {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    @keyframes toastOut {
      to { opacity: 0; transform: translateX(-50%) translateY(20px); }
    }
    
    .info-banner {
      background: #eff6ff;
      border: 2px solid #bfdbfe;
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #1e40af;
      line-height: 1.5;
    }
    
    .info-banner strong {
      font-weight: 600;
    }
    
    @media (max-width: 480px) {
      body { padding: 12px; }
      .card { padding: 20px; }
      h1 { font-size: 28px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">üí∞</div>
      <h1>SettleUp</h1>
      <p class="subtitle">Split bills seamlessly on Base</p>
    </div>

    <div class="card">
      <button id="connectWallet" class="btn-primary">
        üîó Connect Wallet
      </button>
      
      <div id="walletStatus" style="display:none;">
        <div class="wallet-status">
          <div class="wallet-info">
            <div class="wallet-address" id="walletAddress"></div>
            <div class="usdc-balance" id="usdcBalance"></div>
          </div>
          <div class="status-dot"></div>
        </div>
        
        <button id="approveUSDC" class="btn-approve" style="display:none;">
          ‚ö° Approve USDC
        </button>
      </div>
    </div>

    <div class="card" id="addExpenseCard" style="display:none;">
      <h2 class="section-title">
        <span>üìù</span> Add Expense
      </h2>
      
      <div class="info-banner">
        <strong>Note:</strong> Only add participants who owe money. Don't include the payer.
      </div>

      <div class="input-group">
        <label>Amount (USDC)</label>
        <input type="number" inputmode="decimal" step="0.01" id="amount" placeholder="30.00" />
      </div>

      <div class="input-group">
        <label>Payer (Who Paid)</label>
        <input type="text" id="payer" placeholder="0x..." readonly style="background: #f3f4f6;" />
      </div>

      <div class="input-group">
        <label>Participants (Who Owe)</label>
        <input type="text" id="participants" placeholder="0x123..., 0x456..., 0x789..." />
      </div>

      <div class="input-group">
        <label>Description (Optional)</label>
        <input type="text" id="expenseDesc" placeholder="Dinner, Movie tickets, etc." />
      </div>

      <button id="addExpense" class="btn-primary">
        üí≥ Record Expense
      </button>
      
      <div id="addExpenseStatus"></div>
    </div>

    <div class="card" id="balancesCard" style="display:none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 class="section-title" style="margin: 0;">
          <span>üíµ</span> Balances
        </h2>
        <button id="refreshBalances" class="btn-secondary" style="width: auto; padding: 10px 16px;">
          üîÑ
        </button>
      </div>
      
      <div id="balances">
        <div class="empty-state">
          <div class="empty-state-icon">üìä</div>
          <p>Connect wallet to view balances</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const contractAddress = "0xe96cE1AcEF0DCe364a9e7e751D46e1B6Da0cce40";
    const USDC = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";

    const contractABI = [
      { "inputs": [{ "internalType": "address", "name": "usdcAddress", "type": "address" }], "stateMutability": "nonpayable", "type": "constructor" },
      { "anonymous": false, "inputs": [
          { "indexed": true, "internalType": "address", "name": "payer", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" },
          { "indexed": false, "internalType": "address[]", "name": "participants", "type": "address[]" }
        ], "name": "ExpenseAdded", "type": "event" },
      { "anonymous": false, "inputs": [
          { "indexed": true, "internalType": "address", "name": "debtor", "type": "address" },
          { "indexed": true, "internalType": "address", "name": "creditor", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
        ], "name": "Settled", "type": "event" },
      { "inputs": [
          { "internalType": "uint256", "name": "amount", "type": "uint256" },
          { "internalType": "address", "name": "payer", "type": "address" },
          { "internalType": "address[]", "name": "participants", "type": "address[]" }
        ], "name": "addExpense", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
      { "inputs": [{ "internalType": "address", "name": "creditor", "type": "address" }], "name": "settle", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
      { "inputs": [], "name": "getMyBalances", "outputs": [
          { "internalType": "address[]", "name": "creditors", "type": "address[]" },
          { "internalType": "int256[]", "name": "amounts", "type": "int256[]" }
        ], "stateMutability": "view", "type": "function" }
    ];

    let provider, signer, contract, account, usdcContract;

    function shortAddr(addr) { return addr.slice(0,6) + '...' + addr.slice(-4); }
    
    function setLoading(el, loading) { 
      if (loading) {
        el.classList.add('loading');
        el.disabled = true;
      } else {
        el.classList.remove('loading');
        el.disabled = false;
      }
    }
    
    function toast(msg) { 
      const el = document.createElement('div'); 
      el.className = 'toast'; 
      el.textContent = msg; 
      document.body.appendChild(el); 
      setTimeout(() => el.remove(), 3000); 
    }

    async function connectWallet() {
      if (!window.ethereum) return toast("‚ö†Ô∏è Please install MetaMask!");
      
      const btn = document.getElementById("connectWallet");
      setLoading(btn, true);
      
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        account = await signer.getAddress();
        contract = new ethers.Contract(contractAddress, contractABI, signer);

        const net = await provider.getNetwork();
        if (net.chainId !== 8453) {
          toast("‚ö†Ô∏è Switching to Base Mainnet...");
          try {
            await window.ethereum.request({ 
              method: 'wallet_switchEthereumChain', 
              params: [{ chainId: '0x2105' }] 
            });
            location.reload();
            return;
          } catch (e) {
            toast("‚ùå Please switch to Base Mainnet manually");
            setLoading(btn, false);
            return;
          }
        }

        // Update UI
        document.getElementById("walletAddress").textContent = shortAddr(account);
        document.getElementById("payer").value = account;
        document.getElementById("walletStatus").style.display = "block";
        document.getElementById("addExpenseCard").style.display = "block";
        document.getElementById("balancesCard").style.display = "block";
        btn.style.display = "none";

        await initUSDC();
        refreshBalances();

        window.ethereum.on('accountsChanged', () => location.reload());
        window.ethereum.on('chainChanged', () => location.reload());
        
        toast("‚úÖ Connected successfully!");
      } catch (e) { 
        toast("‚ùå Connection failed");
        console.error(e);
      } finally { 
        setLoading(btn, false); 
      }
    }

    async function initUSDC() {
      usdcContract = new ethers.Contract(USDC, [
        "function balanceOf(address) view returns (uint256)",
        "function allowance(address,address) view returns (uint256)",
        "function approve(address,uint256) returns (bool)"
      ], signer);
      
      const bal = await usdcContract.balanceOf(account);
      document.getElementById("usdcBalance").textContent = `üíµ ${ethers.utils.formatUnits(bal, 6)} USDC`;
      
      const allowance = await usdcContract.allowance(account, contractAddress);
      if (allowance.lt(ethers.utils.parseUnits("1000", 6))) {
        document.getElementById("approveUSDC").style.display = "block";
      }
    }

    document.getElementById("approveUSDC").onclick = async () => {
      const btn = document.getElementById("approveUSDC");
      setLoading(btn, true);
      
      try {
        const tx = await usdcContract.approve(contractAddress, ethers.constants.MaxUint256);
        toast("‚è≥ Approving USDC...");
        await tx.wait();
        btn.style.display = "none";
        toast("‚úÖ USDC approved!");
        await initUSDC();
      } catch (e) { 
        toast("‚ùå Approval failed");
        console.error(e);
      } finally { 
        setLoading(btn, false); 
      }
    };

    async function addExpense() {
      const amountInput = document.getElementById("amount").value.trim();
      const payer = document.getElementById("payer").value.trim();
      const participantsInput = document.getElementById("participants").value.trim();
      const desc = document.getElementById("expenseDesc").value.trim() || "Expense";
      const statusEl = document.getElementById("addExpenseStatus");

      if (!amountInput || !payer || !participantsInput) {
        return toast("‚ö†Ô∏è Please fill all required fields");
      }
      
      if (!ethers.utils.isAddress(payer)) {
        return toast("‚ö†Ô∏è Invalid payer address");
      }

      const amountFloat = parseFloat(amountInput);
      if (isNaN(amountFloat) || amountFloat <= 0) {
        return toast("‚ö†Ô∏è Invalid amount");
      }

      const amount = ethers.utils.parseUnits(amountInput, 6);

      // Remove duplicates and filter out payer
      const participants = [...new Set(
        participantsInput
          .split(",")
          .map(a => a.trim())
          .filter(a => ethers.utils.isAddress(a) && a.toLowerCase() !== payer.toLowerCase())
      )];

      if (participants.length === 0) {
        return toast("‚ö†Ô∏è Add at least one participant");
      }

      const btn = document.getElementById("addExpense");
      setLoading(btn, true);
      statusEl.textContent = "";
      statusEl.className = "";

      try {
        const tx = await contract.addExpense(amount, payer, participants);
        
        statusEl.textContent = "‚è≥ Confirming transaction...";
        statusEl.className = "status-message success";

        const receipt = await tx.wait();

        statusEl.innerHTML = `‚úÖ Expense recorded! <a href="https://basescan.org/tx/${receipt.transactionHash}" target="_blank">View Transaction</a>`;
        statusEl.className = "status-message success";

        document.getElementById("amount").value = "";
        document.getElementById("participants").value = "";
        document.getElementById("expenseDesc").value = "";

        window.lastExpenseDesc = desc;
        toast(`‚úÖ "${desc}" recorded!`);
        
        setTimeout(refreshBalances, 1500);
      } catch (e) {
        statusEl.textContent = "‚ùå Failed: " + (e.reason || e.message);
        statusEl.className = "status-message error";
        toast("‚ùå Transaction failed");
      } finally {
        setLoading(btn, false);
      }
    }

    async function settleWith(creditor) {
      if (!confirm(`Settle with ${shortAddr(creditor)}?`)) return;
      
      try {
        const tx = await contract.settle(creditor);
        toast("‚è≥ Settling...");
        await tx.wait();
        toast("‚úÖ Settled successfully!");
        await initUSDC();
        refreshBalances();
      } catch (e) { 
        toast("‚ùå Settlement failed");
        console.error(e);
      }
    }

    async function refreshBalances() {
      const el = document.getElementById("balances");
      const btn = document.getElementById("refreshBalances");

      if (!contract || !account) {
        el.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <p>Connect wallet to view balances</p>
          </div>
        `;
        return;
      }

      setLoading(btn, true);
      el.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚è≥</div>
          <p>Loading balances...</p>
        </div>
      `;

      let creditors = [], amounts = [];
      try {
        [creditors, amounts] = await contract.getMyBalances();
      } catch (e) {
        console.error("getMyBalances failed", e);
        el.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <p>Failed to load balances</p>
          </div>
        `;
        setLoading(btn, false);
        return;
      }

      if (!creditors || creditors.length === 0) {
        el.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ú®</div>
            <p>No balances yet</p>
          </div>
        `;
        setLoading(btn, false);
        return;
      }

      let html = '<div class="balance-list">';
      const desc = window.lastExpenseDesc || "Expense";
      let hasBalances = false;

      for (let i = 0; i < creditors.length; i++) {
        const addr = creditors[i];
        if (addr.toLowerCase() === account.toLowerCase()) continue;

        const raw = amounts[i].toString();
        const positive = !raw.startsWith("-");
        const absRaw = positive ? raw : raw.slice(1);
        const absBN = ethers.BigNumber.from(absRaw);
        const val = parseFloat(ethers.utils.formatUnits(absBN, 6)).toFixed(2);

        if (absBN.isZero()) continue;
        hasBalances = true;

        html += `
          <div class="balance-item">
            <div class="balance-info">
              <div class="balance-amount ${positive ? 'positive' : 'negative'}">
                ${positive ? '+' : '-'}$${val}
              </div>
              <div class="balance-address">${shortAddr(addr)}</div>
              <div class="balance-tag">${desc}</div>
            </div>
            ${!positive ? `<button class="btn-settle" onclick="settleWith('${addr}')">Settle</button>` : ''}
          </div>
        `;
      }

      html += '</div>';

      if (!hasBalances) {
        el.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ú®</div>
            <p>No active balances</p>
          </div>
        `;
      } else {
        el.innerHTML = html;
      }

      setLoading(btn, false);
    }

    // Event Listeners
    document.getElementById("connectWallet").onclick = connectWallet;
    document.getElementById("addExpense").onclick = addExpense;
    document.getElementById("refreshBalances").onclick = refreshBalances;

    document.getElementById("participants").addEventListener("blur", function () {
      const vals = this.value.split(",").map(a => a.trim()).filter(Boolean);
      const valid = vals.filter(a => ethers.utils.isAddress(a));
      if (valid.length !== vals.length && vals.length > 0) {
        toast("‚ö†Ô∏è Invalid addresses removed");
        this.value = valid.join(", ");
      }
    });
  </script>
</body>
</html>
