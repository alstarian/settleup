<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SettleUp - Split Bills in USDC</title>
  <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .glass { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(12px); border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.2); }
    .gradient-btn { background: linear-gradient(45deg, #ff6b6b, #feca57); transition: all 0.3s; }
    .gradient-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
  </style>
</head>
<body class="text-white">

  <div class="container mx-auto p-4 max-w-2xl">
    <div class="text-center mb-8 mt-8">
      <h1 class="text-5xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-pink-500">SettleUp</h1>
      <p class="text-lg opacity-90">Split bills. Pay in USDC. Settle instantly.</p>
    </div>

    <!-- QR CODE -->
    <div class="text-center mt-8 mb-4">
      <p class="text-sm opacity-80 mb-2">Share with friends</p>
      <img id="qrCode" src="" alt="QR Code" class="mx-auto w-32 h-32 rounded-lg shadow-lg">
    </div>

    <!-- CONNECT WALLET -->
    <div id="connectCard" class="glass p-6 text-center mb-6">
      <button id="connectBtn" class="gradient-btn text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg">
        Connect Wallet
      </button>
      <p id="wallet" class="mt-4 text-sm opacity-80"></p>
      <p id="error" class="mt-2 text-red-300 text-xs"></p>
    </div>

    <!-- TRIP INFO -->
    <div id="tripCard" class="glass p-6 mb-6" style="display:none;">
      <h2 class="text-2xl font-bold mb-4 flex items-center">
        <span class="mr-2">Trip</span>
        <span id="creatorBadge" class="text-xs bg-green-500 text-white px-2 py-1 rounded-full" style="display:none;">Creator</span>
      </h2>
      <p class="text-sm opacity-80">Contract: <span id="contractAddr" class="font-mono text-xs break-all"></span></p>
    </div>

    <!-- ADD EXPENSE -->
    <div id="expenseCard" class="glass p-6 mb-6" style="display:none;">
      <h3 class="text-xl font-bold mb-4">Add Expense</h3>
      <input id="amount" type="number" step="0.01" placeholder="45.00" class="w-full p-3 rounded-lg bg-white/20 backdrop-blur text-white placeholder-white/60 mb-3">
      <div class="mb-4">
        <p class="text-sm mb-2">Whoâ€™s in?</p>
        <div id="friendsList" class="flex flex-wrap gap-2"></div>
      </div>
      <button id="addExpenseBtn" class="w-full gradient-btn text-white font-bold py-3 rounded-lg">
        Record Expense
      </button>
    </div>

    <!-- BALANCES -->
    <div id="balancesCard" class="glass p-6 mb-6" style="display:none;">
      <h3 class="text-xl font-bold mb-4">Your Balances</h3>
      <div id="balances" class="space-y-3"></div>
    </div>

    <!-- FINALIZE -->
    <div id="finalizeCard" class="glass p-6 mb-6" style="display:none;">
      <button id="finalizeBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg">
        End Trip (Creator Only)
      </button>
    </div>

    <!-- FINAL SUMMARY -->
    <div id="summaryCard" class="glass p-6" style="display:none;">
      <h3 class="text-xl font-bold mb-4">Final Summary</h3>
      <div id="summary" class="space-y-3"></div>
      <button id="settleAllBtn" class="w-full gradient-btn text-white font-bold py-3 rounded-lg mt-4">
        Settle All My Debts
      </button>
    </div>
  </div>

  <script>
    const CONTRACT_ADDR = "0xdfA5b290290762bb84082Da7Fd7cEc94fbe97E54";

    const ABI = [ /* YOUR ABI - ALREADY CORRECT */ ];

    let provider, signer, contract, account, isCreator = false;
    const friends = JSON.parse(localStorage.getItem("settleup_friends") || "{}");

    // GENERATE QR CODE
    function generateQR() {
      const url = window.location.href;
      const qrEl = document.getElementById("qrCode");
      if (qrEl) {
        qrEl.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      generateQR();
      const btn = document.getElementById("connectBtn");
      if (btn) btn.onclick = connect;
    });

    async function connect() {
      const errorEl = document.getElementById("error");
      if (errorEl) errorEl.textContent = "";

      if (!window.ethereum) {
        if (errorEl) errorEl.textContent = "Install MetaMask!";
        return;
      }

      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        const network = await provider.getNetwork();
        if (network.chainId !== 8453) {
          if (errorEl) errorEl.textContent = "Switch to Base Mainnet";
          return;
        }

        signer = provider.getSigner();
        account = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);

        const walletEl = document.getElementById("wallet");
        const addrEl = document.getElementById("contractAddr");
        const connectCard = document.getElementById("connectCard");

        if (walletEl) walletEl.innerHTML = `<strong>${account.slice(0,6)}...${account.slice(-4)}</strong>`;
        if (addrEl) addrEl.textContent = CONTRACT_ADDR;
        if (connectCard) connectCard.style.display = "none";

        const creator = await contract.creator();
        isCreator = creator.toLowerCase() === account.toLowerCase();
        const badge = document.getElementById("creatorBadge");
        if (badge && isCreator) badge.style.display = "inline";

        showSection("tripCard");
        loadFriends();
        loadBalances();
        checkFinalized();
      } catch (err) {
        if (errorEl) errorEl.textContent = err.message || "Connection failed";
      }
    }

    function showSection(id) {
      const el = document.getElementById(id);
      if (el) el.style.display = "block";
    }

    function loadFriends() {
      const list = document.getElementById("friendsList");
      if (!list) return;
      list.innerHTML = Object.keys(friends).map(name => {
        const addr = friends[name];
        return `<label class="flex items-center bg-white/10 px-3 py-2 rounded-lg cursor-pointer">
          <input type="checkbox" value="${addr}" class="mr-2">
          <span class="text-sm">${name}</span>
        </label>`;
      }).join('');
      if (Object.keys(friends).length < 10) {
        list.innerHTML += `<button onclick="addFriend()" class="bg-white/20 px-3 py-2 rounded-lg text-sm">+</button>`;
      }
    }

    window.addFriend = () => {
      const name = prompt("Name:");
      const addr = prompt("Address:");
      if (name && ethers.utils.isAddress(addr)) {
        friends[name] = addr;
        localStorage.setItem("settleup_friends", JSON.stringify(friends));
        loadFriends();
      }
    };

    document.addEventListener("click", (e) => {
      if (e.target.id === "addExpenseBtn") {
        const amount = document.getElementById("amount")?.value;
        const selected = Array.from(document.querySelectorAll("#friendsList input:checked")).map(cb => cb.value);
        if (!amount || selected.length === 0) return alert("Fill all!");
        contract.addExpense(ethers.utils.parseUnits(amount, 6), account, selected)
          .then(tx => tx.wait())
          .then(() => {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            document.getElementById("amount").value = "";
            loadBalances();
          })
          .catch(e => alert("Error: " + e.message));
      }
    });

    async function loadBalances() {
      try {
        const [creditors, amounts] = await contract.getMyBalances();
        const div = document.getElementById("balances");
        if (!div) return;
        div.innerHTML = creditors.map((a, i) => {
          const amt = ethers.utils.formatUnits(Math.abs(amounts[i]), 6);
          const owe = amounts[i] > 0;
          return `<div class="flex justify-between items-center p-3 bg-white/10 rounded-lg">
            <span class="font-mono text-sm">${a.slice(0,6)}...</span>
            <span class="${owe ? 'text-red-400' : 'text-green-400'} font-bold">$${amt} ${owe ? 'owe' : 'owed by'}</span>
          </div>`;
        }).join('');
        showSection("balancesCard");
      } catch (e) {
        console.log("No balances yet");
      }
    }

    async function checkFinalized() {
      try {
        const finalized = await contract.finalized();
        if (finalized) {
          document.getElementById("expenseCard")?.style.setProperty("display", "none");
          document.getElementById("finalizeCard")?.style.setProperty("display", "none");
          loadSummary();
        } else {
          showSection("expenseCard");
          if (isCreator) {
            showSection("finalizeCard");
            const btn = document.getElementById("finalizeBtn");
            if (btn) btn.onclick = async () => {
              try {
                const tx = await contract.finalizeTrip();
                await tx.wait();
                confetti();
                loadSummary();
              } catch (e) {
                alert("Finalize failed: " + e.message);
              }
            };
          }
        }
      } catch (e) {
        console.log("Not connected yet");
      }
    }

    async function loadSummary() {
      try {
        const [who, net] = await contract.getFinalSummary();
        const div = document.getElementById("summary");
        if (!div) return;
        div.innerHTML = who.map((w, i) => {
          const amt = ethers.utils.formatUnits(Math.abs(net[i]), 6);
          const pay = net[i] > 0;
          return `<div class="flex justify-between items-center p-3 bg-white/10 rounded-lg">
            <span class="font-mono text-sm">${w.slice(0,6)}...</span>
            <span class="${pay ? 'text-red-400' : 'text-green-400'} font-bold">$${amt} ${pay ? 'Pay' : 'Receive'}</span>
          </div>`;
        }).join('');
        showSection("summaryCard");

        const settleBtn = document.getElementById("settleAllBtn");
        if (settleBtn) settleBtn.onclick = async () => {
          try {
            const [creditors, amounts] = await contract.getMyBalances();
            for (let i = 0; i < amounts.length; i++) {
              if (amounts[i] > 0) {
                const tx = await contract.settle(creditors[i]);
                await tx.wait();
              }
            }
            confetti({ particleCount: 200, spread: 100 });
            alert("All settled!");
          } catch (e) {
            alert("Settle failed: " + e.message);
          }
        };
      } catch (e) {
        alert("Summary error: " + e.message);
      }
    }
  </script>
</body>
</html>
