<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SettleUp - Split Bills in USDC</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      padding-bottom: 60px;
    }
    .container { max-width: 500px; margin: 0 auto; }
    
    /* Sticky Header */
    .app-header {
      position: sticky;
      top: -5px;
      z-index: 100;
      text-align: center;
      padding: 15px 0;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .app-header h1 {
      color: white;
      font-size: 28px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      position: relative;
    }
    
    h2 { 
      font-size: 18px; 
      margin-bottom: 16px; 
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Badge for pending items */
    .badge {
      background: #ef4444;
      color: white;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 999px;
      margin-left: 6px;
    }
    
    .form-group { margin-bottom: 16px; }
    label { 
      display: block; 
      font-size: 12px; 
      font-weight: 600; 
      color: #666; 
      margin-bottom: 6px; 
      text-transform: uppercase;
    }
    .label-hint { 
      font-size: 11px; 
      color: #999; 
      font-weight: normal; 
      text-transform: none; 
    }
    
    input, select {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.2s ease;
    }
    
    /* Mobile-friendly touch targets */
    @media (max-width: 640px) {
      input, select, button {
        min-height: 48px;
        font-size: 16px;
      }
    }
    
    input:focus, select:focus { 
      outline: none; 
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    
    .btn-primary { 
      background: linear-gradient(135deg, #667eea, #764ba2); 
      color: white; 
    }
    .btn-primary:hover { 
      opacity: 0.9; 
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .btn-primary:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
      transform: none; 
    }
    
    .btn-secondary { 
      background: #f0f0f0; 
      color: #333; 
    }
    .btn-secondary:hover { 
      background: #e0e0e0; 
    }
    
    .btn-green { 
      background: #10b981; 
      color: white; 
    }
    .btn-green:hover { 
      opacity: 0.9;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .status { 
      padding: 12px; 
      border-radius: 8px; 
      margin-top: 10px; 
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status.success { 
      background: #d1fae5; 
      color: #065f46; 
    }
    .status.error { 
      background: #fee2e2; 
      color: #991b1b; 
    }
    .status.info { 
      background: #dbeafe; 
      color: #1e40af; 
    }
    
    /* Toast Notifications */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
      max-width: 400px;
    }
    
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .toast.success { border-left: 4px solid #10b981; }
    .toast.error { border-left: 4px solid #ef4444; }
    .toast.info { border-left: 4px solid #3b82f6; }
    
    .balance-card {
      background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }
    .balance-card:hover {
      border-color: #d1d5db;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      transform: translateY(-1px);
    }
    
    .balance-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .category-icon {
      font-size: 24px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      background: #f3f4f6;
    }
    
    .balance-amount { 
      font-size: 22px; 
      font-weight: 700;
      flex: 1;
    }
    .balance-amount.positive { color: #059669; }
    .balance-amount.negative { color: #dc2626; }
    .balance-details { 
      font-size: 14px; 
      color: #6b7280; 
      margin-top: 4px; 
    }
    
    .contact-chip {
      display: inline-block;
      padding: 10px 16px;
      background: #f3f4f6;
      border: 2px solid #e5e7eb;
      border-radius: 20px;
      margin: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
    }
    .contact-chip:hover { 
      border-color: #667eea; 
      background: #ede9fe;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
    }
    .contact-chip.selected { 
      background: #667eea; 
      color: white; 
      border-color: #667eea; 
    }
    
    .info-box {
      background: #fef3c7;
      border: 2px solid #fcd34d;
      border-radius: 10px;
      padding: 12px;
      font-size: 13px;
      color: #92400e;
      margin-bottom: 16px;
    }
    
    .hidden { display: none; }

    /* Welcome Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }
    
    .modal {
      background: white;
      border-radius: 20px;
      padding: 32px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalPop 0.3s ease;
    }
    
    @keyframes modalPop {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    .modal h2 {
      font-size: 24px;
      margin-bottom: 16px;
      color: #111827;
    }
    
    .modal-content {
      color: #4b5563;
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 24px;
    }
    
    .modal-content ul {
      margin: 12px 0;
      padding-left: 20px;
    }
    
    .modal-content li {
      margin: 8px 0;
    }

    /* CONTACTS ‚Äì improved UI/UX */
    .contact-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 10px;
      transition: all 0.25s ease;
      position: relative;
    }

    .contact-item:hover {
      border-color: #6366f1;
      box-shadow: 0 6px 14px rgba(99, 102, 241, 0.12);
      transform: translateY(-2px);
    }

    .contact-info {
      flex: 1;
      min-width: 0;
    }

    .contact-name-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .contact-name {
      font-size: 15px;
      font-weight: 600;
      color: #111827;
    }

    .contact-address {
      font-size: 12px;
      color: #6b7280;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      margin-top: 3px;
      word-break: break-all;
    }

    /* Actions appear on hover only */
    .contact-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      opacity: 0;
      transform: translateX(4px);
      transition: all 0.2s ease;
    }

    .contact-item:hover .contact-actions {
      opacity: 1;
      transform: translateX(0);
    }

    /* Icon buttons (edit + delete) */
    .icon-btn {
      border: none;
      background: #f3f4f6;
      color: #4b5563;
      border-radius: 999px;
      width: 36px;
      height: 36px;
      min-height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 0;
    }

    .icon-btn:hover {
      background: #e5e7eb;
      color: #111827;
      transform: scale(1.1);
    }

    /* Softer delete (no aggressive red) */
    .icon-btn.delete-btn {
      background: #fef2f2;
      color: #b91c1c;
    }

    .icon-btn.delete-btn:hover {
      background: #fee2e2;
      color: #7f1d1d;
    }

    /* Inline edit input */
    .contact-edit-input {
      border-radius: 999px;
      border: 2px solid #d1d5db;
      padding: 4px 10px;
      font-size: 14px;
      font-weight: 600;
      width: 160px;
      transition: all 0.2s ease;
    }

    .contact-edit-input:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }
    
    .empty-state-text {
      font-size: 14px;
      color: #6b7280;
    }
    
    /* Skeleton Loader */
    .skeleton {
      background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
      background-size: 200% 100%;
      animation: loading 1.5s ease-in-out infinite;
      border-radius: 8px;
      height: 20px;
      margin: 8px 0;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    /* Tooltip */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #1f2937;
      color: white;
      text-align: center;
      border-radius: 8px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    /* Confetti for celebration */
    @keyframes confetti-fall {
      to { transform: translateY(100vh) rotate(360deg); }
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: #667eea;
      top: -10px;
      animation: confetti-fall 3s linear;
      z-index: 9999;
    }
    
    /* Responsive improvements */
    @media (max-width: 640px) {
      body { padding: 10px; padding-bottom: 40px; }
      .container { padding: 0; }
      .card { padding: 20px; border-radius: 16px; }
      .app-header h1 { font-size: 24px; }
      .toast { right: 10px; bottom: 10px; max-width: calc(100vw - 20px); }
    }
  </style>
</head>
<body>
  <!-- Welcome Modal -->
  <div id="welcomeModal" class="modal-overlay hidden">
    <div class="modal">
      <h2>üëã Welcome to SettleUp!</h2>
      <div class="modal-content">
        <p><strong>Split bills fairly with friends using USDC on Base blockchain.</strong></p>
        <ul>
          <li>üí∞ <strong>Add Expenses:</strong> Enter the total, select who paid, and who shared the bill</li>
          <li>üìä <strong>Track Balances:</strong> See who owes what, organized by category</li>
          <li>üí≥ <strong>Settle Up:</strong> Pay directly with USDC in one click</li>
          <li>‚úèÔ∏è <strong>Adjust Anytime:</strong> Made a mistake? Edit balances easily</li>
        </ul>
        <p style="margin-top: 16px; font-size: 13px; color: #6b7280;">Your data is stored locally. Transactions are secured on Base blockchain.</p>
      </div>
      <button class="btn-primary" onclick="closeWelcome()">Get Started</button>
    </div>
  </div>

  <div class="container">
    <div class="app-header">
      <h1>üí∞ SettleUp</h1>
    </div>

    <!-- Connect Wallet -->
    <div class="card" id="connectCard">
      <h2>üîó Connect Wallet</h2>
      <button class="btn-primary" id="connectBtn">Connect MetaMask</button>
      <div id="connectStatus"></div>
    </div>

    <!-- Wallet Info -->
    <div class="card hidden" id="walletCard">
      <h2>üëõ Wallet Connected</h2>
      <div id="walletInfo"></div>
    </div>

    <!-- Add Expense -->
    <div class="card hidden" id="expenseCard">
      <h2>üìù Add Expense</h2>
      
      <div class="info-box">
        <strong>How it works:</strong> Enter the total bill. Select who paid. Select everyone who shared the expense (including the payer). The cost is split equally.
      </div>
      
      <div class="form-group">
        <label>Total Amount (USDC)</label>
        <input type="number" id="expenseAmount" placeholder="100.00" step="0.01" max="1000000" />
      </div>
      
      <div class="form-group">
        <label>Category</label>
        <select id="expenseCategory">
          <option value="Food">üçï Food</option>
          <option value="Transport">üöó Transport</option>
          <option value="Entertainment">üé¨ Entertainment</option>
          <option value="Utilities">üí° Utilities</option>
          <option value="Other">üì¶ Other</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>
          Who Paid? 
          <span class="label-hint">(click one)</span>
        </label>
        <div id="payerChips"></div>
      </div>
      
      <div class="form-group">
        <label>
          Who Shared the Bill? 
          <span class="label-hint">(click all who participated, including payer)</span>
        </label>
        <div id="participantChips"></div>
      </div>
      
      <div id="splitPreview" style="background:#f0fdf4;border:2px solid #86efac;border-radius:10px;padding:12px;margin-bottom:16px;font-size:14px;display:none;"></div>
      
      <button class="btn-primary" id="addExpenseBtn">üí≥ Record Expense</button>
      <div id="expenseStatus"></div>
    </div>

    <!-- Balances -->
    <div class="card hidden" id="balancesCard">
      <h2>
        üíµ Balances
        <span id="balanceBadge" class="badge hidden">0</span>
        <button class="btn-secondary" id="refreshBtn" style="width:auto;margin-left:auto;padding:8px 16px;margin-top:0;">üîÑ Refresh</button>
      </h2>
      <div style="clear:both;"></div>
      <div id="balancesList" style="margin-top:16px;"></div>
    </div>

    <!-- Contacts -->
    <div class="card hidden" id="contactsCard">
      <h2>üë• Contacts</h2>
      <div id="contactsList"></div>
      <div class="form-group" style="margin-top:16px;">
        <input type="text" id="newContactAddr" placeholder="Address (0x...)" />
        <input type="text" id="newContactName" placeholder="Name" style="margin-top:8px;" />
        <button class="btn-green" id="addContactBtn" style="margin-top:8px;">+ Add Contact</button>
      </div>
    </div>
  </div>

  <script>
    // ========== CONFIGURATION ==========
    const CONTRACT_ADDRESS = "0x87DE5D58F0d25Db2A7F3E8af264AFCd82e9e87dC";
    const USDC_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
    const CATEGORIES = ["Food", "Transport", "Entertainment", "Utilities", "Other"];
    
    const CATEGORY_ICONS = {
      "Food": "üçï",
      "Transport": "üöó",
      "Entertainment": "üé¨",
      "Utilities": "üí°",
      "Other": "üì¶"
    };

    // ========== CONTRACT ABI ==========
    const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"usdcAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"creditor","type":"address"},{"indexed":true,"internalType":"address","name":"debtor","type":"address"},{"indexed":false,"internalType":"uint256","name":"oldAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"newAmount","type":"uint256"},{"indexed":false,"internalType":"string","name":"category","type":"string"}],"name":"BalanceAdjusted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"totalAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"sharePerPerson","type":"uint256"},{"indexed":false,"internalType":"address[]","name":"participants","type":"address[]"},{"indexed":false,"internalType":"string","name":"category","type":"string"}],"name":"ExpenseAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"debtor","type":"address"},{"indexed":true,"internalType":"address","name":"creditor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"category","type":"string"}],"name":"Settled","type":"event"},{"inputs":[],"name":"MAX_BALANCE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_PARTICIPANTS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"address","name":"payer","type":"address"},{"internalType":"address[]","name":"participants","type":"address[]"},{"internalType":"string","name":"category","type":"string"}],"name":"addExpense","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"debtor","type":"address"},{"internalType":"uint256","name":"newAmount","type":"uint256"},{"internalType":"string","name":"category","type":"string"}],"name":"adjustBalance","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"},{"internalType":"string","name":"","type":"string"}],"name":"balances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"debtor","type":"address"},{"internalType":"string","name":"category","type":"string"}],"name":"creditFrom","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"creditor","type":"address"},{"internalType":"string","name":"category","type":"string"}],"name":"debtTo","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"debtor","type":"address"},{"internalType":"address","name":"creditor","type":"address"},{"internalType":"string","name":"category","type":"string"}],"name":"getBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getConstants","outputs":[{"internalType":"uint256","name":"maxBalance","type":"uint256"},{"internalType":"uint256","name":"maxParticipants","type":"uint256"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"address","name":"creditor","type":"address"},{"internalType":"string","name":"category","type":"string"}],"name":"settle","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"usdc","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"}];

    const USDC_ABI = ["function balanceOf(address) view returns (uint256)","function allowance(address,address) view returns (uint256)","function approve(address,uint256) returns (bool)"];

    // ========== STATE ==========
    let provider, signer, contract, usdcContract;
    let account = null;
    let contacts = {};
    let selectedPayer = null;
    let selectedSplitters = [];

    // ========== UTILITIES ==========
    function shortAddr(addr) {
      return addr ? addr.slice(0, 6) + "..." + addr.slice(-4) : "";
    }

    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.className = `status ${type}`;
      el.innerHTML = `${type === 'info' ? '<span class="spinner"></span>' : ''}${message}`;
    }
    
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
      toast.innerHTML = `<span style="font-size:24px;">${icon}</span><span>${message}</span>`;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }
    
    function triggerConfetti() {
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.background = ['#667eea', '#764ba2', '#10b981', '#ef4444', '#f59e0b'][Math.floor(Math.random() * 5)];
          confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 5000);
        }, i * 30);
      }
    }

    function getContactName(addr) {
      const normalized = addr.toLowerCase();
      if (normalized === account?.toLowerCase()) return "Me";
      return contacts[normalized] || shortAddr(addr);
    }
    
    function closeWelcome() {
      document.getElementById('welcomeModal').classList.add('hidden');
      localStorage.setItem('settleup_welcome_seen', 'true');
    }
    
    function showWelcomeIfNeeded() {
      if (!localStorage.getItem('settleup_welcome_seen')) {
        document.getElementById('welcomeModal').classList.remove('hidden');
      }
    }

    // ========== CONTACTS ==========
    function loadContacts() {
      const stored = localStorage.getItem("settleup_contacts_v6");
      if (stored) {
        try { contacts = JSON.parse(stored); }
        catch (e) { contacts = {}; }
      }
    }

    function saveContacts() {
      localStorage.setItem("settleup_contacts_v6", JSON.stringify(contacts));
    }

    function addContact(addr, name) {
      if (!ethers.utils.isAddress(addr)) {
        showToast("Invalid address", "error");
        return;
      }
      const normalized = addr.toLowerCase();
      if (normalized === account?.toLowerCase()) {
        showToast("You can't add yourself as a contact!", "error");
        return;
      }
      contacts[normalized] = name || shortAddr(addr);
      saveContacts();
      renderAll();
      showToast(`Added ${name || shortAddr(addr)}`, "success");
    }

    function renderContacts() {
      const list = document.getElementById("contactsList");
      list.innerHTML = "";
      const otherContacts = Object.entries(contacts).filter(
        ([addr]) => addr !== account?.toLowerCase()
      );

      if (otherContacts.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üë•</div>
            <div class="empty-state-title">No contacts yet</div>
            <div class="empty-state-text">Add friends to start splitting bills!</div>
          </div>
        `;
        return;
      }

      otherContacts.forEach(([addr, name]) => {
        const wrapper = document.createElement("div");
        wrapper.className = "contact-item";

        const info = document.createElement("div");
        info.className = "contact-info";

        const nameRow = document.createElement("div");
        nameRow.className = "contact-name-row";

        const nameEl = document.createElement("span");
        nameEl.className = "contact-name";
        nameEl.textContent = name;

        nameRow.appendChild(nameEl);

        const addrEl = document.createElement("div");
        addrEl.className = "contact-address";
        addrEl.textContent = shortAddr(addr);

        info.appendChild(nameRow);
        info.appendChild(addrEl);

        const actions = document.createElement("div");
        actions.className = "contact-actions";

        const editBtn = document.createElement("button");
        editBtn.className = "icon-btn";
        editBtn.type = "button";
        editBtn.title = "Edit name";
        editBtn.innerHTML = "‚úèÔ∏è";
        editBtn.onclick = () => startEditContact(addr, nameEl);

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "icon-btn delete-btn";
        deleteBtn.type = "button";
        deleteBtn.title = "Remove contact";
        deleteBtn.innerHTML = "üóë";
        deleteBtn.onclick = () => deleteContact(addr);

        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);

        wrapper.appendChild(info);
        wrapper.appendChild(actions);
        list.appendChild(wrapper);
      });
    }

    function startEditContact(addr, nameElement) {
      const currentName = contacts[addr.toLowerCase()] || nameElement.textContent;
      const input = document.createElement("input");
      input.type = "text";
      input.value = currentName;
      input.className = "contact-edit-input";

      const parent = nameElement.parentNode;
      parent.replaceChild(input, nameElement);
      input.focus();
      input.select();

      const finish = () => finishEditContact(addr, input, nameElement);

      input.addEventListener("blur", finish);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") finish();
        if (e.key === "Escape") {
          input.value = currentName;
          finish();
        }
      });
    }

    function finishEditContact(addr, input, nameElement) {
      const newName = input.value.trim() || shortAddr(addr);
      contacts[addr.toLowerCase()] = newName;
      saveContacts();

      nameElement.textContent = newName;
      const parent = input.parentNode;
      parent.replaceChild(nameElement, input);
      
      showToast(`Updated to ${newName}`, "success");
    }

    function deleteContact(addr) {
      const name = contacts[addr.toLowerCase()] || shortAddr(addr);
      const confirmed = confirm(
        `Remove ${name} from your contacts?\n\nThis does NOT affect any on-chain balances or debts.`
      );
      if (!confirmed) return;

      delete contacts[addr.toLowerCase()];
      saveContacts();
      renderAll();
      showToast(`Removed ${name}`, "info");
    }

    // ========== CHIPS ==========
    function renderPayerChips() {
      const container = document.getElementById("payerChips");
      container.innerHTML = "";
      if (account) {
        const meChip = document.createElement("span");
        meChip.className = "contact-chip" + (selectedPayer === account.toLowerCase() ? " selected" : "");
        meChip.textContent = "üë§ Me";
        meChip.onclick = () => { selectedPayer = account.toLowerCase(); renderAll(); };
        container.appendChild(meChip);
      }
      Object.entries(contacts).forEach(([addr, name]) => {
        if (addr === account?.toLowerCase()) return;
        const chip = document.createElement("span");
        chip.className = "contact-chip" + (selectedPayer === addr ? " selected" : "");
        chip.textContent = name;
        chip.onclick = () => { selectedPayer = addr; renderAll(); };
        container.appendChild(chip);
      });
    }

    function renderSplitterChips() {
      const container = document.getElementById("participantChips");
      container.innerHTML = "";
      if (account) {
        const meChip = document.createElement("span");
        meChip.className = "contact-chip" + (selectedSplitters.includes(account.toLowerCase()) ? " selected" : "");
        meChip.textContent = "üë§ Me";
        meChip.onclick = () => toggleSplitter(account.toLowerCase());
        container.appendChild(meChip);
      }
      Object.entries(contacts).forEach(([addr, name]) => {
        if (addr === account?.toLowerCase()) return;
        const chip = document.createElement("span");
        chip.className = "contact-chip" + (selectedSplitters.includes(addr) ? " selected" : "");
        chip.textContent = name;
        chip.onclick = () => toggleSplitter(addr);
        container.appendChild(chip);
      });
    }

    function toggleSplitter(addr) {
      const idx = selectedSplitters.indexOf(addr);
      if (idx >= 0) selectedSplitters.splice(idx, 1);
      else selectedSplitters.push(addr);
      renderAll();
    }

    function updateSplitPreview() {
      const preview = document.getElementById("splitPreview");
      const amountInput = document.getElementById("expenseAmount").value;
      const amount = parseFloat(amountInput) || 0;
      if (amount <= 0 || !selectedPayer || selectedSplitters.length === 0) {
        preview.style.display = "none";
        return;
      }
      if (amount > 1000000) {
        preview.innerHTML = `<strong>‚ö†Ô∏è Amount exceeds 1M USDC limit</strong>`;
        preview.style.display = "block";
        return;
      }
      const share = amount / selectedSplitters.length;
      const payerName = getContactName(selectedPayer);
      const debtors = selectedSplitters.filter(addr => addr !== selectedPayer);
      if (debtors.length === 0) {
        preview.innerHTML = `<strong>‚ö†Ô∏è No one owes anything</strong><br>Select at least one other person who shared the bill.`;
        preview.style.display = "block";
        return;
      }
      let html = `<strong>üí° Split Preview:</strong><br>Total: $${amount.toFixed(2)} √∑ ${selectedSplitters.length} people = $${share.toFixed(2)} each<br><br>`;
      debtors.forEach(addr => {
        html += `‚Ä¢ ${getContactName(addr)} owes ${payerName}: <strong>$${share.toFixed(2)}</strong><br>`;
      });
      preview.innerHTML = html;
      preview.style.display = "block";
    }

    function renderAll() {
      renderContacts();
      renderPayerChips();
      renderSplitterChips();
      updateSplitPreview();
    }

    // ========== WALLET CONNECTION ==========
    async function connectWallet() {
      if (!window.ethereum) {
        showStatus("connectStatus", "MetaMask not found!", "error");
        showToast("Please install MetaMask", "error");
        return;
      }
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        account = await signer.getAddress();
        const network = await provider.getNetwork();
        if (network.chainId !== 8453) {
          try {
            await window.ethereum.request({
              method: "wallet_switchEthereumChain",
              params: [{ chainId: "0x2105" }]
            });
            location.reload();
            return;
          } catch (e) {
            showStatus("connectStatus", "Please switch to Base Mainnet!", "error");
            return;
          }
        }
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        usdcContract = new ethers.Contract(USDC_ADDRESS, USDC_ABI, signer);
        loadContacts();
        const myAddr = account.toLowerCase();
        if (contacts[myAddr]) {
          delete contacts[myAddr];
          saveContacts();
        }
        selectedPayer = account.toLowerCase();
        selectedSplitters = [account.toLowerCase()];
        document.getElementById("connectCard").classList.add("hidden");
        document.getElementById("walletCard").classList.remove("hidden");
        document.getElementById("expenseCard").classList.remove("hidden");
        document.getElementById("balancesCard").classList.remove("hidden");
        document.getElementById("contactsCard").classList.remove("hidden");
        const usdcBal = await usdcContract.balanceOf(account);
        document.getElementById("walletInfo").innerHTML = `<p><strong>Address:</strong> ${shortAddr(account)}</p><p><strong>USDC Balance:</strong> ${parseFloat(ethers.utils.formatUnits(usdcBal, 6)).toFixed(2)} USDC</p>`;
        renderAll();
        await refreshBalances();
        showToast("Wallet connected successfully!", "success");
      } catch (e) {
        showStatus("connectStatus", e.message, "error");
      }
    }

    // ========== ADD EXPENSE ==========
    async function addExpense() {
      const amountInput = document.getElementById("expenseAmount").value;
      const category = document.getElementById("expenseCategory").value;
      if (!amountInput || parseFloat(amountInput) <= 0) {
        showStatus("expenseStatus", "Enter a valid amount", "error");
        return;
      }
      if (parseFloat(amountInput) > 1000000) {
        showStatus("expenseStatus", "Amount exceeds 1M USDC limit", "error");
        return;
      }
      if (!selectedPayer) {
        showStatus("expenseStatus", "Select who paid", "error");
        return;
      }
      if (selectedSplitters.length < 2) {
        showStatus("expenseStatus", "Select at least 2 people who shared the bill", "error");
        return;
      }
      if (selectedSplitters.length > 50) {
        showStatus("expenseStatus", "Maximum 50 participants allowed", "error");
        return;
      }
      const participants = selectedSplitters.filter(addr => addr !== selectedPayer);
      if (participants.length === 0) {
        showStatus("expenseStatus", "No one owes the payer! Select others who shared the bill.", "error");
        return;
      }
      const amount = ethers.utils.parseUnits(amountInput, 6);
      const payerChecksum = ethers.utils.getAddress(selectedPayer);
      const participantsChecksum = participants.map(p => ethers.utils.getAddress(p));
      const btn = document.getElementById("addExpenseBtn");
      btn.disabled = true;
      showStatus("expenseStatus", "Sending transaction...", "info");
      try {
        const tx = await contract.addExpense(amount, payerChecksum, participantsChecksum, category);
        showStatus("expenseStatus", "Waiting for confirmation...", "info");
        showToast("Transaction sent! Waiting for confirmation...", "info");
        await tx.wait();
        showStatus("expenseStatus", `‚úÖ Expense recorded!`, "success");
        showToast(`Expense recorded successfully!`, "success");
        document.getElementById("expenseAmount").value = "";
        selectedSplitters = [account.toLowerCase()];
        renderAll();
        for (const p of participants) {
          if (!contacts[p.toLowerCase()]) {
            const name = prompt(`Save ${shortAddr(p)} as contact:`, shortAddr(p));
            if (name && name.trim()) addContact(p, name.trim());
          }
        }
        await new Promise(r => setTimeout(r, 3000));
        await refreshBalances();
      } catch (e) {
        showStatus("expenseStatus", `Error: ${e.reason || e.message}`, "error");
        showToast(`Transaction failed: ${e.reason || e.message}`, "error");
      } finally {
        btn.disabled = false;
      }
    }

    // ========== REFRESH BALANCES ==========
    async function refreshBalances() {
      const list = document.getElementById("balancesList");
      list.innerHTML = `
        <div class="skeleton" style="height:60px;margin:8px 0;"></div>
        <div class="skeleton" style="height:60px;margin:8px 0;"></div>
        <div class="skeleton" style="height:60px;margin:8px 0;"></div>
      `;
      
      const balances = [];
      const contactAddrs = Object.keys(contacts).filter(a => a !== account.toLowerCase());
      
      if (contactAddrs.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üí∏</div>
            <div class="empty-state-title">No contacts added</div>
            <div class="empty-state-text">Add contacts to see balances with them</div>
          </div>
        `;
        return;
      }
      
      for (const contactAddr of contactAddrs) {
        for (const category of CATEGORIES) {
          try {
            await new Promise(r => setTimeout(r, 100));
            const contactChecksum = ethers.utils.getAddress(contactAddr);
            const accountChecksum = ethers.utils.getAddress(account);
            const theyOweUs = await contract.getBalance(contactChecksum, accountChecksum, category);
            const weOweThem = await contract.getBalance(accountChecksum, contactChecksum, category);
            if (!theyOweUs.isZero()) {
              balances.push({ contact: contactAddr, category, type: "credit", amount: theyOweUs });
            }
            if (!weOweThem.isZero()) {
              balances.push({ contact: contactAddr, category, type: "debt", amount: weOweThem });
            }
          } catch (e) {
            console.error(`Error checking ${contactAddr}/${category}:`, e);
          }
        }
      }
      
      // Update badge
      const badge = document.getElementById('balanceBadge');
      if (balances.length > 0) {
        badge.textContent = balances.length;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
      
      if (balances.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ú®</div>
            <div class="empty-state-title">All settled up!</div>
            <div class="empty-state-text">No outstanding balances</div>
          </div>
        `;
        triggerConfetti();
        return;
      }
      
      list.innerHTML = "";
      for (const b of balances) {
        const contactName = getContactName(b.contact);
        const amountStr = parseFloat(ethers.utils.formatUnits(b.amount, 6)).toFixed(2);
        const card = document.createElement("div");
        card.className = "balance-card";
        
        const icon = CATEGORY_ICONS[b.category] || "üì¶";
        
        if (b.type === "credit") {
          card.innerHTML = `
            <div class="balance-header">
              <div class="category-icon">${icon}</div>
              <div class="balance-amount positive">+${amountStr} USDC</div>
            </div>
            <div class="balance-details">${contactName} owes you ‚Ä¢ ${b.category}</div>
            <button class="btn-secondary" style="margin-top:10px;width:auto;padding:8px 16px;" onclick="adjustBalancePrompt('${b.contact}', '${b.category}', '${amountStr}')">‚úèÔ∏è Adjust</button>
          `;
        } else {
          card.innerHTML = `
            <div class="balance-header">
              <div class="category-icon">${icon}</div>
              <div class="balance-amount negative">-${amountStr} USDC</div>
            </div>
            <div class="balance-details">You owe ${contactName} ‚Ä¢ ${b.category}</div>
            <button class="btn-green" style="margin-top:10px;width:auto;padding:8px 16px;" onclick="settleBalance('${b.contact}', '${b.category}')">üí≥ Pay Now</button>
          `;
        }
        list.appendChild(card);
      }
    }

    // ========== ADJUST BALANCE ==========
    async function adjustBalancePrompt(debtor, category, currentAmountStr) {
      const name = getContactName(debtor);
      const input = prompt(`Set new amount that ${name} owes you for ${category}.\n(Current: ${currentAmountStr} USDC)\nEnter 0 to clear:`, currentAmountStr);
      if (input === null) return;
      const value = parseFloat(input);
      if (isNaN(value) || value < 0) {
        showToast("Enter a non-negative number", "error");
        return;
      }
      if (value > 1000000) {
        showToast("Amount exceeds 1M USDC limit", "error");
        return;
      }
      try {
        const debtorChecksum = ethers.utils.getAddress(debtor);
        const newAmount = ethers.utils.parseUnits(value.toString(), 6);
        showToast("Sending adjustment...", "info");
        const tx = await contract.adjustBalance(debtorChecksum, newAmount, category);
        await tx.wait();
        showToast("Balance adjusted successfully!", "success");
        await new Promise(r => setTimeout(r, 2000));
        await refreshBalances();
      } catch (e) {
        showToast("Adjust failed: " + (e.reason || e.message), "error");
      }
    }

    // ========== SETTLE ==========
    async function settleBalance(creditor, category) {
      const name = getContactName(creditor);
      if (!confirm(`Pay your ${category} balance to ${name}?`)) return;
      try {
        const creditorChecksum = ethers.utils.getAddress(creditor);
        const balance = await contract.getBalance(account, creditorChecksum, category);
        if (balance.isZero()) {
          showToast("No balance to settle!", "error");
          return;
        }
        
        showToast("Checking USDC allowance...", "info");
        const allowance = await usdcContract.allowance(account, CONTRACT_ADDRESS);
        if (allowance.lt(balance)) {
          showToast("Approving USDC...", "info");
          const approveTx = await usdcContract.approve(CONTRACT_ADDRESS, balance);
          await approveTx.wait();
        }
        
        showToast("Settling payment...", "info");
        const tx = await contract.settle(creditorChecksum, category);
        await tx.wait();
        
        showToast("Payment settled successfully! üéâ", "success");
        await new Promise(r => setTimeout(r, 2000));
        await refreshBalances();
        
        const usdcBal = await usdcContract.balanceOf(account);
        document.getElementById("walletInfo").innerHTML = `<p><strong>Address:</strong> ${shortAddr(account)}</p><p><strong>USDC Balance:</strong> ${parseFloat(ethers.utils.formatUnits(usdcBal, 6)).toFixed(2)} USDC</p>`;
      } catch (e) {
        showToast("Settlement failed: " + (e.reason || e.message), "error");
      }
    }

    // ========== EVENT LISTENERS ==========
    document.getElementById("connectBtn").onclick = connectWallet;
    document.getElementById("addExpenseBtn").onclick = addExpense;
    document.getElementById("refreshBtn").onclick = refreshBalances;
    document.getElementById("expenseAmount").oninput = updateSplitPreview;
    document.getElementById("addContactBtn").onclick = () => {
      const addr = document.getElementById("newContactAddr").value.trim();
      const name = document.getElementById("newContactName").value.trim();
      if (addr) {
        addContact(addr, name || shortAddr(addr));
        document.getElementById("newContactAddr").value = "";
        document.getElementById("newContactName").value = "";
      } else {
        showToast("Enter an address", "error");
      }
    };
    
    // Show welcome modal on first visit
    window.addEventListener('load', showWelcomeIfNeeded);
  </script>
</body>
</html>
