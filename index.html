<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SettleUp - Split Bills in USDC</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8fafc;
      color: #111827;
      padding: 20px;
      margin: 0;
    }
    h1 {
      color: #2563eb;
      text-align: center;
      margin-bottom: 30px;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 24px;
      margin: 20px auto;
      max-width: 600px;
    }
    input, button, select {
      display: block;
      width: 100%;
      margin: 12px 0;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 16px;
    }
    button {
      background: #2563eb;
      color: white;
      cursor: pointer;
      border: none;
      font-weight: bold;
      transition: background 0.2s;
    }
    button:hover {
      background: #1d4ed8;
    }
    button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }
    .success { color: #16a34a; font-weight: bold; }
    .error { color: #dc2626; }
    pre { 
      white-space: pre-line; 
      background: #f1f5f9;
      padding: 16px;
      border-radius: 8px;
      margin: 10px 0;
      font-family: monospace;
    }
    .balance-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #e2e8f0;
    }
    .balance-item:last-child {
      border-bottom: none;
    }
    .settle-btn {
      background: #10b981;
      color: white;
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .settle-btn:hover {
      background: #059669;
    }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #2563eb;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      animation: fade 3s forwards;
      z-index: 1000;
    }
    @keyframes fade {
      0%, 70% { opacity: 1; }
      100% { opacity: 0; }
    }
  </style>
</head>
<body>
  <h1>SettleUp - Split Bills in USDC</h1>

  <div class="card">
    <button id="connectWallet">Connect Wallet</button>
    <p id="walletAddress" class="success"></p>
    <p id="usdcBalance"></p>
    <button id="approveUSDC" style="display:none; margin:10px 0;">Approve USDC for SettleUp</button>

    <h3>Add Expense</h3>
    <input type="tel" inputmode="decimal" step="0.01" id="amount" placeholder="Amount in USDC (e.g. 30.00)" />
    <input type="text" id="participants" placeholder="Participants (comma-separated addresses)" />
    <label for="payer">Payer (who paid with card)</label>
    <input type="text" id="payer" placeholder="Enter address of who paid" />
    <button id="addExpense" disabled>Record Expense</button>
    <p id="addExpenseStatus"></p>
  </div>

  <div class="card">
    <h3>Your Balances</h3>
    <button id="refreshBalances" disabled>Refresh Balances</button>
    <div id="balances">Connect wallet first...</div>
  </div>

  <script>
    // === CONFIG ===
    const contractAddress = "0xb316D7803E40B2D2f144e61FdDF59adb9D48B67B";
    const USDC = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";

    const contractABI = [
      {
        "inputs": [{ "internalType": "address", "name": "usdcAddress", "type": "address" }],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "payer", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" },
          { "indexed": false, "internalType": "address[]", "name": "participants", "type": "address[]" }
        ],
        "name": "ExpenseAdded",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "debtor", "type": "address" },
          { "indexed": true, "internalType": "address", "name": "creditor", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
        ],
        "name": "Settled",
        "type": "event"
      },
      {
        "inputs": [
          { "internalType": "uint256", "name": "amount", "type": "uint256" },
          { "internalType": "address", "name": "payer", "type": "address" },
          { "internalType": "address[]", "name": "participants", "type": "address[]" }
        ],
        "name": "addExpense",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [{ "internalType": "address", "name": "creditor", "type": "address" }],
        "name": "settle",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getMyBalances",
        "outputs": [
          { "internalType": "address[]", "name": "creditors", "type": "address[]" },
          { "internalType": "int256[]", "name": "amounts", "type": "int256[]" }
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    let provider, signer, contract, account, usdcContract;

    function shortAddr(addr) {
      return addr.slice(0,6) + '...' + addr.slice(-4);
    }

    function setLoading(el, loading) {
      if (loading) {
        el.classList.add('loading');
        el.disabled = true;
      } else {
        el.classList.remove('loading');
        el.disabled = false;
      }
    }

    function toast(msg) {
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    async function connectWallet() {
      if (!window.ethereum) return toast("Install MetaMask!");

      const connectBtn = document.getElementById("connectWallet");
      setLoading(connectBtn, true);

      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        account = await signer.getAddress();
        contract = new ethers.Contract(contractAddress, contractABI, signer);

        const network = await provider.getNetwork();
        if (network.chainId !== 8453) {
          toast("Switch to Base Mainnet (8453)");
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0x2105' }],
            });
          } catch (e) {
            toast("Failed to switch network");
          }
          setLoading(connectBtn, false);
          return;
        }

        document.getElementById("walletAddress").innerText = `Connected: ${shortAddr(account)}`;
        document.getElementById("payer").value = account;

        // Enable buttons
        document.getElementById("addExpense").disabled = false;
        document.getElementById("refreshBalances").disabled = false;

        await initUSDC();
        refreshBalances();

        window.ethereum.on('accountsChanged', () => location.reload());
        window.ethereum.on('chainChanged', () => location.reload());

      } catch (err) {
        toast("Connection failed: " + err.message);
      } finally {
        setLoading(connectBtn, false);
      }
    }

    async function initUSDC() {
      usdcContract = new ethers.Contract(USDC, [
        "function balanceOf(address) view returns (uint256)",
        "function allowance(address owner,address spender) view returns (uint256)",
        "function approve(address spender,uint256 amount) returns (bool)"
      ], signer);

      const bal = await usdcContract.balanceOf(account);
      document.getElementById("usdcBalance").textContent = `USDC: ${ethers.utils.formatUnits(bal, 6)}`;

      const allowance = await usdcContract.allowance(account, contractAddress);
      if (allowance.lt(ethers.utils.parseUnits("1000", 6))) {
        document.getElementById("approveUSDC").style.display = "block";
      }
    }

    document.getElementById("approveUSDC").onclick = async () => {
      const btn = document.getElementById("approveUSDC");
      setLoading(btn, true);
      try {
        const tx = await usdcContract.approve(contractAddress, ethers.constants.MaxUint256);
        toast("Approving USDC...");
        await tx.wait();
        btn.style.display = "none";
        toast("USDC approved! You can settle.");
        document.getElementById("usdcBalance").textContent = `USDC: ${ethers.utils.formatUnits(await usdcContract.balanceOf(account), 6)}`;
      } catch (e) {
        toast("Approval failed: " + (e.reason || e.message));
      } finally {
        setLoading(btn, false);
      }
    };

    async function addExpense() {
      const amountInput = document.getElementById("amount").value.trim();
      const payerAddr = document.getElementById("payer").value.trim();
      const participantsInput = document.getElementById("participants").value.trim();
      const statusEl = document.getElementById("addExpenseStatus");

      if (!amountInput || !payerAddr || !participantsInput) {
        return toast("Fill all fields.");
      }
      if (!ethers.utils.isAddress(payerAddr)) {
        return toast("Invalid payer address.");
      }

      const amount = ethers.utils.parseUnits(amountInput, 6);
      let participants = participantsInput
        .split(",")
        .map(a => a.trim())
        .filter(a => ethers.utils.isAddress(a));

      if (participants.length === 0) return toast("Add valid participants.");

      if (!participants.some(p => p.toLowerCase() === payerAddr.toLowerCase())) {
        participants.push(payerAddr);
      }

      const addBtn = document.getElementById("addExpense");
      setLoading(addBtn, true);
      statusEl.textContent = "";
      statusEl.className = "";

      try {
        const tx = await contract.addExpense(amount, payerAddr, participants);
        statusEl.textContent = "Confirming...";
        statusEl.className = "success";
        await tx.wait();
        
        statusEl.innerHTML = `Recorded! <a href="https://basescan.org/tx/${tx.hash}" target="_blank">View</a>`;
        statusEl.className = "success";

        document.getElementById("amount").value = "";
        document.getElementById("participants").value = "";
        refreshBalances();
      } catch (err) {
        statusEl.textContent = "Failed: " + (err.reason || err.message);
        statusEl.className = "error";
      } finally {
        setLoading(addBtn, false);
      }
    }

    async function settleWith(creditor) {
      if (!confirm(`Settle with ${shortAddr(creditor)}?`)) return;

      try {
        const tx = await contract.settle(creditor);
        toast("Settling...");
        await tx.wait();
        toast(`Settled! https://basescan.org/tx/${tx.hash}`);
        refreshBalances();
      } catch (err) {
        toast("Settle failed: " + (err.reason || err.message));
      }
    }

    async function refreshBalances() {
      const balancesEl = document.getElementById("balances");
      const refreshBtn = document.getElementById("refreshBalances");

      if (!contract || !account) {
        balancesEl.innerHTML = "Connect wallet first...";
        return;
      }

      setLoading(refreshBtn, true);
      balancesEl.innerHTML = "Loading...";

      try {
        const [creditors, amounts] = await contract.getMyBalances();

        if (!creditors || creditors.length === 0) {
          balancesEl.innerHTML = "<em>No balances.</em>";
          setLoading(refreshBtn, false);
          return;
        }

        let output = "";
        for (let i = 0; i < creditors.length; i++) {
          const addr = creditors[i];
          if (addr.toLowerCase() === account.toLowerCase()) continue;

          const raw = amounts[i].toString();
          const isPositive = !raw.startsWith("-");
          const absRaw = isPositive ? raw : raw.slice(1);
          const absBN = ethers.BigNumber.from(absRaw);
          const val = parseFloat(ethers.utils.formatUnits(absBN, 6)).toFixed(2);

          if (absBN.isZero()) continue;

          if (isPositive) {
            output += `
              <div class="balance-item">
                <span style="color:#16a34a;">$${val} owed to you by</span> ${shortAddr(addr)}
              </div>`;
          } else {
            output += `
              <div class="balance-item">
                <span style="color:#dc2626;">You owe $${val} to</span> ${shortAddr(addr)}
                <button class="settle-btn" onclick="settleWith('${addr}')">Settle</button>
              </div>`;
          }
        }

        balancesEl.innerHTML = output || "<em>No balances.</em>";
      } catch (err) {
        console.error(err);
        balancesEl.innerHTML = "<span class='error'>Error loading balances.</span>";
      } finally {
        setLoading(refreshBtn, false);
      }
    }

    // Event Listeners
    document.getElementById("connectWallet").onclick = connectWallet;
    document.getElementById("addExpense").onclick = addExpense;
    document.getElementById("refreshBalances").onclick = refreshBalances;

    // Validate participants
    document.getElementById("participants").addEventListener("blur", function() {
      const vals = this.value.split(",").map(a => a.trim());
      const valid = vals.filter(a => ethers.utils.isAddress(a));
      if (valid.length !== vals.length) {
        toast("Invalid address(es) removed.");
        this.value = valid.join(", ");
      }
    });
  </script>
</body>
</html>
