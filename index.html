<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SettleUp - Split Bills in USDC</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 500px; margin: 0 auto; }
    .card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 { text-align: center; color: white; margin-bottom: 20px; font-size: 28px; }
    h2 { font-size: 18px; margin-bottom: 16px; color: #333; }
    .form-group { margin-bottom: 16px; }
    label { display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 6px; text-transform: uppercase; }
    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
    }
    input:focus, select:focus { outline: none; border-color: #667eea; }
    button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background: #f0f0f0; color: #333; }
    .btn-green { background: #10b981; color: white; }
    .status { padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 14px; }
    .status.success { background: #d1fae5; color: #065f46; }
    .status.error { background: #fee2e2; color: #991b1b; }
    .status.info { background: #dbeafe; color: #1e40af; }
    .balance-card {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .balance-amount { font-size: 20px; font-weight: 700; }
    .balance-amount.positive { color: #059669; }
    .balance-amount.negative { color: #dc2626; }
    .balance-details { font-size: 14px; color: #6b7280; margin-top: 4px; }
    .contact-chip {
      display: inline-block;
      padding: 8px 14px;
      background: #f3f4f6;
      border: 2px solid #e5e7eb;
      border-radius: 20px;
      margin: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .contact-chip:hover { border-color: #667eea; background: #ede9fe; }
    .contact-chip.selected { background: #667eea; color: white; border-color: #667eea; }
    #log { 
      background: #1f2937; 
      color: #10b981; 
      padding: 12px; 
      border-radius: 8px; 
      font-family: monospace; 
      font-size: 12px; 
      max-height: 200px; 
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 10px;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üí∞ SettleUp</h1>

    <!-- Connect Wallet -->
    <div class="card" id="connectCard">
      <h2>üîó Connect Wallet</h2>
      <button class="btn-primary" id="connectBtn">Connect MetaMask</button>
      <div id="connectStatus"></div>
    </div>

    <!-- Wallet Info -->
    <div class="card hidden" id="walletCard">
      <h2>üëõ Wallet Connected</h2>
      <div id="walletInfo"></div>
    </div>

    <!-- Add Expense -->
    <div class="card hidden" id="expenseCard">
      <h2>üìù Add Expense</h2>

      <div class="form-group">
        <label>Total Amount (USDC)</label>
        <input type="number" id="expenseAmount" placeholder="100.00" step="0.01" />
      </div>

      <div class="form-group">
        <label>Category</label>
        <select id="expenseCategory">
          <option value="Food">üçï Food</option>
          <option value="Transport">üöó Transport</option>
          <option value="Entertainment">üé¨ Entertainment</option>
          <option value="Utilities">üí° Utilities</option>
          <option value="Other">üì¶ Other</option>
        </select>
      </div>

      <div class="form-group">
        <label>Who Paid?</label>
        <div id="payerChips"></div>
        <input type="text" id="payerAddress" placeholder="Or paste address..." />
      </div>

      <div class="form-group">
        <label>Who Participated? (click to add)</label>
        <div id="participantChips"></div>
        <input type="text" id="participantAddresses" placeholder="Selected participants will appear here..." />
      </div>

      <button class="btn-primary" id="addExpenseBtn">üí≥ Record Expense</button>
      <div id="expenseStatus"></div>
    </div>

    <!-- Balances -->
    <div class="card hidden" id="balancesCard">
      <h2>üíµ Balances <button class="btn-secondary" id="refreshBtn" style="width:auto;float:right;padding:8px 16px;margin:0;">üîÑ Refresh</button></h2>
      <div style="clear:both;"></div>
      <div id="balancesList" style="margin-top:16px;"></div>
    </div>

    <!-- Contacts -->
    <div class="card hidden" id="contactsCard">
      <h2>üë• Contacts</h2>
      <div id="contactsList"></div>
      <div class="form-group" style="margin-top:16px;">
        <input type="text" id="newContactAddr" placeholder="Address (0x...)" />
        <input type="text" id="newContactName" placeholder="Name" style="margin-top:8px;" />
        <button class="btn-green" id="addContactBtn" style="margin-top:8px;">+ Add Contact</button>
      </div>
    </div>

    <!-- Debug Log -->
    <div class="card">
      <h2>üîç Debug Log</h2>
      <div id="log">Waiting for connection...</div>
    </div>
  </div>

  <script>
    // ========== CONFIGURATION ==========
    const CONTRACT_ADDRESS = "0xf6b491763ca2e099bb6c9d3e573524c426152aeb";
    const USDC_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
    const BASE_RPC = "https://mainnet.base.org";
    const CATEGORIES = ["Food", "Transport", "Entertainment", "Utilities", "Other"];

    // ========== ABI ==========
    const CONTRACT_ABI = [
      "function addExpense(uint256 amount, address payer, address[] participants, string category) external",
      "function getBalance(address debtor, address creditor, string category) external view returns (uint256)",
      "function settle(address creditor, string category) external",
      "function adjustBalance(address debtor, uint256 newAmount, string category) external",
      "function balances(address, address, bytes32) external view returns (uint256)"
    ];

    const USDC_ABI = [
      "function balanceOf(address) view returns (uint256)",
      "function allowance(address,address) view returns (uint256)",
      "function approve(address,uint256) returns (bool)"
    ];

    // ========== STATE ==========
    let readProvider, writeProvider, signer, readContract, writeContract, usdcContract;
    let account = null;
    let contacts = {};

    // ========== LOGGING ==========
    function log(msg) {
      const logEl = document.getElementById("log");
      const time = new Date().toLocaleTimeString();
      logEl.textContent = `[${time}] ${msg}\n` + logEl.textContent;
      console.log(msg);
    }

    // ========== UTILITIES ==========
    function shortAddr(addr) {
      return addr ? addr.slice(0, 6) + "..." + addr.slice(-4) : "";
    }

    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.className = `status ${type}`;
      el.textContent = message;
      el.classList.remove("hidden");
    }

    // ========== CONTACTS ==========
    function loadContacts() {
      const stored = localStorage.getItem("settleup_contacts_v2");
      if (stored) {
        try {
          contacts = JSON.parse(stored);
        } catch (e) {
          contacts = {};
        }
      }
    }

    function saveContacts() {
      localStorage.setItem("settleup_contacts_v2", JSON.stringify(contacts));
    }

    function addContact(addr, name) {
      if (!ethers.utils.isAddress(addr)) {
        alert("Invalid address");
        return;
      }
      const normalized = addr.toLowerCase();
      contacts[normalized] = name || shortAddr(addr);
      saveContacts();
      renderContacts();
      renderPayerChips();
      renderParticipantChips();
      log(`Added contact: ${name} (${shortAddr(addr)})`);
    }

    function renderContacts() {
      const list = document.getElementById("contactsList");
      list.innerHTML = "";

      Object.entries(contacts).forEach(([addr, name]) => {
        const div = document.createElement("div");
        div.style.cssText = "display:flex;justify-content:space-between;align-items:center;padding:8px;background:#f9fafb;border-radius:8px;margin-bottom:8px;";
        div.innerHTML = `
          <span><strong>${name}</strong><br><small style="color:#888;">${shortAddr(addr)}</small></span>
          <button onclick="deleteContact('${addr}')" style="background:#ef4444;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">Delete</button>
        `;
        list.appendChild(div);
      });
    }

    function deleteContact(addr) {
      delete contacts[addr.toLowerCase()];
      saveContacts();
      renderContacts();
      renderPayerChips();
      renderParticipantChips();
    }

    // ========== CHIPS ==========
    let selectedPayer = null;
    let selectedParticipants = [];

    function renderPayerChips() {
      const container = document.getElementById("payerChips");
      container.innerHTML = "";

      // Add "You" chip
      if (account) {
        const youChip = document.createElement("span");
        youChip.className = "contact-chip" + (selectedPayer === account.toLowerCase() ? " selected" : "");
        youChip.textContent = "üìç You";
        youChip.onclick = () => selectPayer(account);
        container.appendChild(youChip);
      }

      // Add contact chips
      Object.entries(contacts).forEach(([addr, name]) => {
        if (addr === account?.toLowerCase()) return;
        const chip = document.createElement("span");
        chip.className = "contact-chip" + (selectedPayer === addr ? " selected" : "");
        chip.textContent = name;
        chip.onclick = () => selectPayer(addr);
        container.appendChild(chip);
      });
    }

    function selectPayer(addr) {
      selectedPayer = addr.toLowerCase();
      document.getElementById("payerAddress").value = addr;
      renderPayerChips();
      log(`Selected payer: ${contacts[selectedPayer] || shortAddr(addr)}`);
    }

    function renderParticipantChips() {
      const container = document.getElementById("participantChips");
      container.innerHTML = "";

      // Add "You" chip
      if (account) {
        const youChip = document.createElement("span");
        youChip.className = "contact-chip" + (selectedParticipants.includes(account.toLowerCase()) ? " selected" : "");
        youChip.textContent = "üìç You";
        youChip.onclick = () => toggleParticipant(account);
        container.appendChild(youChip);
      }

      // Add contact chips
      Object.entries(contacts).forEach(([addr, name]) => {
        if (addr === account?.toLowerCase()) return;
        const chip = document.createElement("span");
        chip.className = "contact-chip" + (selectedParticipants.includes(addr) ? " selected" : "");
        chip.textContent = name;
        chip.onclick = () => toggleParticipant(addr);
        container.appendChild(chip);
      });

      updateParticipantsInput();
    }

    function toggleParticipant(addr) {
      const normalized = addr.toLowerCase();
      const idx = selectedParticipants.indexOf(normalized);
      if (idx >= 0) {
        selectedParticipants.splice(idx, 1);
      } else {
        selectedParticipants.push(normalized);
      }
      renderParticipantChips();
      log(`Participants: ${selectedParticipants.map(a => contacts[a] || shortAddr(a)).join(", ")}`);
    }

    function updateParticipantsInput() {
      document.getElementById("participantAddresses").value = selectedParticipants.join(", ");
    }

    // ========== WALLET CONNECTION ==========
    async function connectWallet() {
      log("Connecting wallet...");

      if (!window.ethereum) {
        showStatus("connectStatus", "MetaMask not found!", "error");
        return;
      }

      try {
        // Setup read provider (public RPC - no rate limits)
        readProvider = new ethers.providers.JsonRpcProvider(BASE_RPC);
        log("Read provider connected to Base RPC");

        // Setup write provider (MetaMask)
        writeProvider = new ethers.providers.Web3Provider(window.ethereum);
        await writeProvider.send("eth_requestAccounts", []);
        signer = writeProvider.getSigner();
        account = await signer.getAddress();
        log(`Wallet connected: ${shortAddr(account)}`);

        // Check network
        const network = await writeProvider.getNetwork();
        if (network.chainId !== 8453) {
          log("Wrong network, switching to Base...");
          try {
            await window.ethereum.request({
              method: "wallet_switchEthereumChain",
              params: [{ chainId: "0x2105" }]
            });
            location.reload();
            return;
          } catch (e) {
            showStatus("connectStatus", "Please switch to Base Mainnet!", "error");
            return;
          }
        }

        // Setup contracts
        readContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);
        writeContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        usdcContract = new ethers.Contract(USDC_ADDRESS, USDC_ABI, signer);
        log("Contracts initialized");

        // Load contacts
        loadContacts();

        // Add self to contacts if not exists
        if (!contacts[account.toLowerCase()]) {
          contacts[account.toLowerCase()] = "You";
          saveContacts();
        }

        // Update UI
        document.getElementById("connectCard").classList.add("hidden");
        document.getElementById("walletCard").classList.remove("hidden");
        document.getElementById("expenseCard").classList.remove("hidden");
        document.getElementById("balancesCard").classList.remove("hidden");
        document.getElementById("contactsCard").classList.remove("hidden");

        // Get USDC balance
        const usdcBal = await usdcContract.balanceOf(account);
        document.getElementById("walletInfo").innerHTML = `
          <p><strong>Address:</strong> ${shortAddr(account)}</p>
          <p><strong>USDC Balance:</strong> ${parseFloat(ethers.utils.formatUnits(usdcBal, 6)).toFixed(2)} USDC</p>
        `;

        // Render UI
        renderContacts();
        renderPayerChips();
        renderParticipantChips();
        selectPayer(account);

        // Load balances
        await refreshBalances();

        log("‚úÖ Ready!");

      } catch (e) {
        log(`Error: ${e.message}`);
        showStatus("connectStatus", e.message, "error");
      }
    }

    // ========== ADD EXPENSE ==========
    async function addExpense() {
      const amountInput = document.getElementById("expenseAmount").value;
      const category = document.getElementById("expenseCategory").value;
      const payerAddr = document.getElementById("payerAddress").value.trim();

      log(`Adding expense: ${amountInput} USDC, category=${category}`);

      if (!amountInput || parseFloat(amountInput) <= 0) {
        showStatus("expenseStatus", "Enter a valid amount", "error");
        return;
      }

      if (!ethers.utils.isAddress(payerAddr)) {
        showStatus("expenseStatus", "Invalid payer address", "error");
        return;
      }

      // Get participants (exclude payer)
      const participants = selectedParticipants.filter(p => p.toLowerCase() !== payerAddr.toLowerCase());

      if (participants.length === 0) {
        showStatus("expenseStatus", "Select at least one participant (other than payer)", "error");
        return;
      }

      const amount = ethers.utils.parseUnits(amountInput, 6);

      log(`Payer: ${shortAddr(payerAddr)}`);
      log(`Participants: ${participants.map(p => shortAddr(p)).join(", ")}`);
      log(`Category: ${category}`);
      log(`Amount: ${amountInput} USDC`);

      const btn = document.getElementById("addExpenseBtn");
      btn.disabled = true;
      showStatus("expenseStatus", "Sending transaction...", "info");

      try {
        const tx = await writeContract.addExpense(amount, payerAddr, participants, category);
        log(`Transaction sent: ${tx.hash}`);
        showStatus("expenseStatus", "Waiting for confirmation...", "info");

        const receipt = await tx.wait();
        log(`‚úÖ Confirmed in block ${receipt.blockNumber}`);

        showStatus("expenseStatus", `‚úÖ Expense recorded! TX: ${shortAddr(tx.hash)}`, "success");

        // Clear form
        document.getElementById("expenseAmount").value = "";
        selectedParticipants = [];
        renderParticipantChips();

        // Add participants to contacts if not already
        for (const p of participants) {
          if (!contacts[p.toLowerCase()]) {
            const name = prompt(`Add ${shortAddr(p)} to contacts as:`, shortAddr(p));
            if (name) addContact(p, name);
          }
        }

        // Wait and refresh
        log("Waiting 3 seconds for state update...");
        await new Promise(r => setTimeout(r, 3000));
        await refreshBalances();

      } catch (e) {
        log(`‚ùå Error: ${e.message}`);
        showStatus("expenseStatus", `Error: ${e.reason || e.message}`, "error");
      } finally {
        btn.disabled = false;
      }
    }

    // ========== REFRESH BALANCES ==========
    async function refreshBalances() {
      log("Refreshing balances...");
      const list = document.getElementById("balancesList");
      list.innerHTML = "<p>Loading...</p>";

      const balances = [];
      const contactAddrs = Object.keys(contacts).filter(a => a !== account.toLowerCase());

      if (contactAddrs.length === 0) {
        list.innerHTML = "<p>Add contacts to see balances</p>";
        return;
      }

      log(`Checking ${contactAddrs.length} contacts across ${CATEGORIES.length} categories...`);

      for (const contactAddr of contactAddrs) {
        for (const category of CATEGORIES) {
          try {
            // Small delay to avoid rate limiting
            await new Promise(r => setTimeout(r, 50));

            // They owe us (contact is debtor, we are creditor)
            const theyOweUs = await readContract.getBalance(contactAddr, account, category);

            // We owe them (we are debtor, contact is creditor)  
            const weOweThem = await readContract.getBalance(account, contactAddr, category);

            if (!theyOweUs.isZero()) {
              log(`‚úì ${contacts[contactAddr]} owes you ${ethers.utils.formatUnits(theyOweUs, 6)} USDC (${category})`);
              balances.push({
                contact: contactAddr,
                category,
                type: "credit",
                amount: theyOweUs
              });
            }

            if (!weOweThem.isZero()) {
              log(`‚úì You owe ${contacts[contactAddr]} ${ethers.utils.formatUnits(weOweThem, 6)} USDC (${category})`);
              balances.push({
                contact: contactAddr,
                category,
                type: "debt",
                amount: weOweThem
              });
            }

          } catch (e) {
            log(`‚ö† Error checking ${shortAddr(contactAddr)}/${category}: ${e.message}`);
          }
        }
      }

      log(`Found ${balances.length} active balances`);

      if (balances.length === 0) {
        list.innerHTML = "<p>‚ú® No active balances</p>";
        return;
      }

      list.innerHTML = "";
      for (const b of balances) {
        const contactName = contacts[b.contact] || shortAddr(b.contact);
        const amountStr = parseFloat(ethers.utils.formatUnits(b.amount, 6)).toFixed(2);

        const card = document.createElement("div");
        card.className = "balance-card";

        if (b.type === "credit") {
          card.innerHTML = `
            <div class="balance-amount positive">+ ${amountStr} USDC</div>
            <div class="balance-details">${contactName} owes you ‚Ä¢ ${b.category}</div>
          `;
        } else {
          card.innerHTML = `
            <div class="balance-amount negative">- ${amountStr} USDC</div>
            <div class="balance-details">You owe ${contactName} ‚Ä¢ ${b.category}</div>
            <button class="btn-green" style="margin-top:10px;width:auto;padding:8px 16px;" onclick="settleBalance('${b.contact}', '${b.category}')">Settle</button>
          `;
        }

        list.appendChild(card);
      }
    }

    // ========== SETTLE ==========
    async function settleBalance(creditor, category) {
      const name = contacts[creditor] || shortAddr(creditor);
      if (!confirm(`Settle ${category} balance with ${name}?`)) return;

      log(`Settling ${category} with ${name}...`);

      try {
        const tx = await writeContract.settle(creditor, category);
        log(`Transaction sent: ${tx.hash}`);
        await tx.wait();
        log("‚úÖ Settled!");
        await new Promise(r => setTimeout(r, 2000));
        await refreshBalances();
      } catch (e) {
        log(`‚ùå Error: ${e.message}`);
        alert("Settlement failed: " + (e.reason || e.message));
      }
    }

    // ========== EVENT LISTENERS ==========
    document.getElementById("connectBtn").onclick = connectWallet;
    document.getElementById("addExpenseBtn").onclick = addExpense;
    document.getElementById("refreshBtn").onclick = refreshBalances;
    document.getElementById("addContactBtn").onclick = () => {
      const addr = document.getElementById("newContactAddr").value.trim();
      const name = document.getElementById("newContactName").value.trim();
      if (addr && name) {
        addContact(addr, name);
        document.getElementById("newContactAddr").value = "";
        document.getElementById("newContactName").value = "";
      }
    };

    // Auto-connect if previously connected
    if (window.ethereum?.selectedAddress) {
      connectWallet();
    }
  </script>
</body>
</html>
