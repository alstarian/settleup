<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SettleUp - Split Bills in USDC</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {font-family:'Inter',sans-serif;background:#0f0f23;color:#e0e0ff;margin:0;padding:0;min-height:100vh;}
    .container {max-width:480px;margin:0 auto;padding:20px 16px;}
    .card {background:#1a1a2e;border-radius:24px;padding:28px;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid #2a2a4e;}
    .title {font-size:32px;font-weight:700;text-align:center;color:#ffffff;margin:20px 0 30px;background:linear-gradient(135deg,#ff6bcb,#6b7cff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .connect-btn,.action-btn {background:linear-gradient(135deg,#ff6bcb,#6b7cff);color:white;border:none;padding:18px;border-radius:18px;font-weight:600;font-size:17px;width:100%;cursor:pointer;transition:all .2s;margin:20px 0;}
    .connect-btn:hover,.action-btn:hover {transform:translateY(-2px);box-shadow:0 10px 20px rgba(107,124,255,0.4);}
    .action-btn:disabled {background:#3a3a6e;cursor:not-allowed;opacity:0.7;}
    .input-group {margin:24px 0;}
    .input-label {font-size:15px;color:#a0a0ff;margin-bottom:10px;display:block;font-weight:500;}
    input {width:100%;padding:18px 20px;background:#2a2a4e;border:1px solid #3a3a6e;border-radius:18px;color:white;font-size:18px;box-sizing:border-box;transition:all .2s;}
    input:focus {outline:none;border-color:#6b7cff;box-shadow:0 0 0 4px rgba(107,124,255,0.3);}
    .friend-list {display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:20px 0;}
    .friend-btn {background:#2a2a4e;color:#c0c0ff;padding:12px 20px;border-radius:16px;cursor:pointer;font-size:15px;font-weight:500;min-width:90px;text-align:center;transition:all .2s;border:1px solid #3a3a6e;}
    .friend-btn:hover {background:#3a3a6e;transform:translateY(-2px);}
    .friend-btn.you {background:#1e4d3a;border-color:#2e8b57;color:#90ee90;}
    .friend-btn.add {background:#1e3a3a;border-color:#008080;color:#40e0d0;}
    .settle-btn {background:#10b981;color:white;padding:10px 20px;border-radius:14px;font-size:15px;border:none;cursor:pointer;font-weight:600;}
    .balance-item {background:#2a2a4e;padding:20px;border-radius:18px;margin:14px 0;display:flex;justify-content:space-between;align-items:center;border:1px solid #3a3a6e;flex-wrap:wrap;gap:12px;}
    .tag {font-size:13px;color:#8888cc;font-style:italic;}
    .toast {position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1a1a2e;color:white;padding:16px 32px;border-radius:18px;font-size:16px;box-shadow:0 12px 30px rgba(0,0,0,0.6);z-index:1000;animation:fade 3s forwards;}
    @keyframes fade {0%,70%{opacity:1}100%{opacity:0}}
    h3 {text-align:center;color:#ffffff;margin:20px 0 10px;font-size:20px;}
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">SettleUp</h1>

    <div class="card">
      <button id="connectWallet" class="connect-btn">Connect Wallet</button>
      <p id="walletAddress" style="text-align:center;margin:16px 0;font-weight:600;font-size:16px;"></p>
      <p id="usdcBalance" style="text-align:center;color:#a0a0ff;font-size:16px;"></p>
      <button id="approveUSDC" class="action-btn" style="display:none;">Approve USDC</button>

      <div class="input-group">
        <div class="input-label">Your Contacts (long-press to delete)</div>
        <div class="friend-list" id="friendList"></div>
      </div>

      <div class="input-group">
        <div class="input-label">Amount (USDC)</div>
        <input type="tel" inputmode="decimal" step="0.01" id="amount" placeholder="30.00" />
      </div>

      <div class="input-group">
        <div class="input-label">Participants</div>
        <input type="text" id="participants" placeholder="Click names above" />
      </div>

      <div class="input-group">
        <div class="input-label">Payer</div>
        <input type="text" id="payer" placeholder="Click your name" />
      </div>

      <div class="input-group">
        <div class="input-label">Description (optional)</div>
        <input type="text" id="expenseDesc" placeholder="Dinner at Sushi Place" />
      </div>

      <button id="addExpense" class="action-btn" disabled>Record Expense</button>
      <p id="addExpenseStatus" style="text-align:center;margin-top:16px;font-size:15px;"></p>
    </div>

    <div class="card" style="margin-top:40px;">
      <h3>Your Balances</h3>
      <button id="refreshBalances" class="action-btn" disabled>Refresh Balances</button>
      <div id="balances" style="margin-top:24px;font-size:16px;">Connect wallet first...</div>
    </div>
  </div>

  <script>
    const contractAddress = "0xe96cE1AcEF0DCe364a9e7e751D46e1B6Da0cce40";
    const USDC = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";

    const contractABI = [
      {"inputs":[{"internalType":"address","name":"usdcAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"address[]","name":"participants","type":"address[]"}],"name":"ExpenseAdded","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"debtor","type":"address"},{"indexed":true,"internalType":"address","name":"creditor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Settled","type":"event"},
      {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"address","name":"payer","type":"address"},{"internalType":"address[]","name":"participants","type":"address[]"}],"name":"addExpense","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"creditor","type":"address"}],"name":"settle","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"getMyBalances","outputs":[{"internalType":"address[]","name":"creditors","type":"address[]"},{"internalType":"int256[]","name":"amounts","type":"int256[]"}],"stateMutability":"view","type":"function"}
    ];

    let provider, signer, contract, account, usdcContract;
    let contacts = {};

    function shortAddr(addr) { return addr.slice(0,6)+'...'+addr.slice(-4); }
    function toast(msg) { const el=document.createElement('div'); el.className='toast'; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),3000); }

    function loadContacts(){ const s=localStorage.getItem("settleup-contacts"); if(s) contacts=JSON.parse(s); }
    function saveContacts(){ localStorage.setItem("settleup-contacts",JSON.stringify(contacts)); }
    function addContact(addr,name){ if(!name||name===addr)return; contacts[addr.toLowerCase()]=name; saveContacts(); renderFriends(); }
    function deleteContact(addr){ if(addr===account?.toLowerCase())return toast("Can't delete yourself"); delete contacts[addr]; saveContacts(); renderFriends(); toast("Deleted"); }

    function renderFriends(){
      const list=document.getElementById("friendList"); list.innerHTML="";
      if(!account) return;
      Object.entries(contacts).forEach(([addr,name])=>{
        const btn=document.createElement("div"); btn.className="friend-btn";
        if(addr===account.toLowerCase()) btn.classList.add("you");
        btn.textContent=name;
        btn.onclick=e=>{e.stopPropagation();
          if(addr===account.toLowerCase()){document.getElementById("payer").value=account; toast(`Payer: ${name}`);}
          else{
            const cur=document.getElementById("participants").value;
            const arr=cur.split(",").map(a=>a.trim()).filter(Boolean);
            if(!arr.map(a=>a.toLowerCase()).includes(addr)){
              document.getElementById("participants").value=[...arr,addr].join(", ");
              toast(`Added: ${name}`);
            }
          }
        };
        let t; btn.onmousedown=btn.ontouchstart=()=>{t=setTimeout(()=>{if(confirm(`Delete ${name}?`))deleteContact(addr)},800);};
        btn.onmouseup=btn.ontouchend=btn.onmouseleave=btn.ontouchcancel=()=>{clearTimeout(t);};
        btn.oncontextmenu=e=>{e.preventDefault(); if(confirm(`Delete ${name}?`))deleteContact(addr);};
        list.appendChild(btn);
      });
      const add=document.createElement("div"); add.className="friend-btn add"; add.textContent="+ Add";
      add.onclick=()=>{const a=prompt("Address:"); if(!ethers.utils.isAddress(a))return toast("Invalid"); const n=prompt("Name:",shortAddr(a)); if(n)addContact(a,n);};
      list.appendChild(add);
    }

    async function connectWallet(){
      if(!window.ethereum)return toast("Install MetaMask!");
      const btn=document.getElementById("connectWallet"); btn.disabled=true; btn.textContent="Connecting...";
      try{
        provider=new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts",[]);
        signer=provider.getSigner(); account=await signer.getAddress();
        contract=new ethers.Contract(contractAddress,contractABI,signer);
        const net=await provider.getNetwork();
        if(net.chainId!==8453){
          toast("Switch to Base Mainnet");
          await window.ethereum.request({method:'wallet_switchEthereumChain',params:[{chainId:'0x2105'}]});
          btn.disabled=false; btn.textContent="Connect Wallet"; return;
        }
        document.getElementById("walletAddress").textContent=`Connected: ${shortAddr(account)}`;
        document.getElementById("payer").value=account;
        loadContacts();
        if(!contacts[account.toLowerCase()]){
          const n=prompt("Your name?","Me");
          if(n)addContact(account,n);
        }
        document.getElementById("addExpense").disabled=false;
        document.getElementById("refreshBalances").disabled=false;
        renderFriends(); await initUSDC(); refreshBalances();
        window.ethereum.on('accountsChanged',()=>location.reload());
        window.ethereum.on('chainChanged',()=>location.reload());
      }catch(e){toast("Connect failed — use MetaMask on Base");}
      finally{btn.disabled=false; btn.textContent="Connect Wallet";}
    }

    async function initUSDC(){
      usdcContract=new ethers.Contract(USDC,["function balanceOf(address) view returns(uint256)","function allowance(address,address) view returns(uint256)","function approve(address,uint256) returns(bool)"],signer);
      const bal=await usdcContract.balanceOf(account);
      document.getElementById("usdcBalance").textContent=`USDC Balance: ${ethers.utils.formatUnits(bal,6)}`;
      const allow=await usdcContract.allowance(account,contractAddress);
      if(allow.lt(ethers.utils.parseUnits("1000",6))) document.getElementById("approveUSDC").style.display="block";
    }

    document.getElementById("approveUSDC").onclick=async()=>{const b=document.getElementById("approveUSDC");b.disabled=true;
      try{const tx=await usdcContract.approve(contractAddress,ethers.constants.MaxUint256);toast("Approving USDC…");await tx.wait();b.style.display="none";toast("Approved!");}
      catch(e){toast("Approval failed");}finally{b.disabled=false;}
    };

    async function addExpense(){
      const amt=document.getElementById("amount").value.trim();
      const payer=document.getElementById("payer").value.trim();
      const parts=document.getElementById("participants").value.trim();
      const desc=document.getElementById("expenseDesc").value.trim()||"Expense";
      const status=document.getElementById("addExpenseStatus");
      if(!amt||!payer||!parts)return toast("Fill all fields");
      if(!ethers.utils.isAddress(payer))return toast("Invalid payer");
      const amount=ethers.utils.parseUnits(amt,6);
      const participants=parts.split(",").map(a=>a.trim()).filter(a=>ethers.utils.isAddress(a)&&a.toLowerCase()!==payer.toLowerCase());
      if(participants.length===0)return toast("Add at least one other participant");
      const full=[payer,...participants];
      const btn=document.getElementById("addExpense"); btn.disabled=true;
      try{
        const tx=await contract.addExpense(amount,payer,full);
        status.textContent="Confirming…"; status.style.color="#90ee90";
        await tx.wait();
        status.innerHTML=`Recorded! <a href="https://basescan.org/tx/${tx.hash}" target="_blank" style="color:#6b7cff;text-decoration:underline;">View Tx</a>`;
        document.getElementById("amount").value="";
        document.getElementById("participants").value="";
        document.getElementById("expenseDesc").value="";
        participants.forEach(a=>{if(!contacts[a.toLowerCase()]){const n=prompt(`Name for ${shortAddr(a)}?`,shortAddr(a));if(n&&n!==shortAddr(a))addContact(a,n);}});
        window.lastExpenseDesc=desc; toast(`Expense recorded: "${desc}"`);
        setTimeout(refreshBalances,1500);
      }catch(e){status.textContent="Failed: "+(e.reason||e.message); status.style.color="#ff6b6b";}
      finally{btn.disabled=false;}
    }

    async function settleWith(c){if(!confirm("Settle now?"))return;
      try{const tx=await contract.settle(c);toast("Settling…");await tx.wait();toast("Settled!");refreshBalances();}
      catch(e){toast("Failed");}
    }

    async function refreshBalances(){
      const el=document.getElementById("balances");
      const btn=document.getElementById("refreshBalances"); btn.disabled=true; el.innerHTML="Loading balances...";
      let creditors=[],amounts=[];
      try{[creditors,amounts]=await contract.getMyBalances();}
      catch(e){el.innerHTML="<span style='color:#ff6b6b'>Failed to load balances</span>"; btn.disabled=false; return;}
      if(creditors.length===0){el.innerHTML="<em>No balances yet.</em>"; btn.disabled=false; return;}
      let html=""; const desc=window.lastExpenseDesc||"Expense";
      for(let i=0;i<creditors.length;i++){
        const addr=creditors[i];
        if(addr.toLowerCase()===account.toLowerCase())continue;
        const raw=amounts[i].toString();
        const pos=!raw.startsWith("-");
        const val=parseFloat(ethers.utils.formatUnits(pos?raw:raw.slice(1),6)).toFixed(2);
        if(parseFloat(val)===0)continue;
        const name=contacts[addr.toLowerCase()]||shortAddr(addr);
        const tag=`<span class="tag">(${desc})</span>`;
        if(pos){
          html+=`<div class="balance-item"><div><span style="color:#4ade80;font-weight:600;">$${val}</span> owed to you by<br><strong>${name}</strong> ${tag}</div></div>`;
        }else{
          html+=`<div class="balance-item"><div><span style="color:#f87171;font-weight:600;">You owe $${val}</span> to<br><strong>${name}</strong> ${tag}</div><button class="settle-btn" onclick="settleWith('${addr}')">Settle</button></div>`;
        }
      }
      el.innerHTML=html||"<em>No balances.</em>";
      btn.disabled=false;
    }

    document.getElementById("connectWallet").onclick=connectWallet;
    document.getElementById("addExpense").onclick=addExpense;
    document.getElementById("refreshBalances").onclick=refreshBalances;
  </script>
</body>
</html>
