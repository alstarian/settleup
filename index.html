<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SettleUp - Split Bills in USDC</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8fafc;
      color: #111827;
      padding: 20px;
      margin: 0;
    }
    h1 {
      color: #2563eb;
      text-align: center;
      margin-bottom: 30px;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 24px;
      margin: 20px auto;
      max-width: 600px;
    }
    input, button, select {
      display: block;
      width: 100%;
      margin: 12px 0;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 16px;
    }
    button {
      background: #2563eb;
      color: white;
      cursor: pointer;
      border: none;
      font-weight: bold;
      transition: background 0.2s;
    }
    button:hover {
      background: #1d4ed8;
    }
    button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }
    .success { color: #16a34a; font-weight: bold; }
    .error { color: #dc2626; }
    pre { 
      white-space: pre-line; 
      background: #f1f5f9;
      padding: 16px;
      border-radius: 8px;
      margin: 10px 0;
      font-family: monospace;
    }
    .balance-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #e2e8f0;
    }
    .balance-item:last-child {
      border-bottom: none;
    }
    .settle-btn {
      background: #10b981;
      color: white;
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .settle-btn:hover {
      background: #059669;
    }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h1>SettleUp - Split Bills in USDC</h1>

  <div class="card">
    <button id="connectWallet">Connect Wallet</button>
    <p id="walletAddress" class="success"></p>

<h3>Add Expense</h3>
<input type="tel" inputmode="decimal" step="0.01" id="amount" placeholder="Amount in USDC (e.g. 30.00)" />
<input type="text" id="participants" placeholder="Participants (comma-separated addresses)" />
<label for="payer">Payer (who paid with card)</label>
<input type="text" id="payer" placeholder="Enter address of who paid" />
<button id="addExpense" disabled>Record Expense</button>
<p id="addExpenseStatus"></p>  </div>

  <div class="card">
    <h3>Your Balances</h3>
    <button id="refreshBalances" disabled>Refresh Balances</button>
    <div id="balances">Connect wallet first...</div>
  </div>

  <script>
    const contractAddress = "0xdfA5b290290762bb84082Da7Fd7cEc94fbe97E54";
    const contractABI = [
      {
        "inputs": [
          { "internalType": "address", "name": "usdcAddress", "type": "address" }
        ],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "payer", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" },
          { "indexed": false, "internalType": "address[]", "name": "participants", "type": "address[]" }
        ],
        "name": "ExpenseAdded",
        "type": "event"
      },
      {
        "inputs": [
          { "internalType": "uint256", "name": "amount", "type": "uint256" },
          { "internalType": "address", "name": "payer", "type": "address" },
          { "internalType": "address[]", "name": "participants", "type": "address[]" }
        ],
        "name": "addExpense",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getMyBalances",
        "outputs": [
          { "internalType": "address[]", "name": "creditors", "type": "address[]" },
          { "internalType": "int256[]", "name": "amounts", "type": "int256[]" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "creditor", "type": "address" }
        ],
        "name": "settle",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    let provider, signer, contract, account;

    function shortAddr(addr) {
      return addr.slice(0,6) + '...' + addr.slice(-4);
    }

    function setLoading(el, loading) {
      if (loading) {
        el.classList.add('loading');
        el.disabled = true;
      } else {
        el.classList.remove('loading');
        el.disabled = false;
      }
    }

    async function connectWallet() {
      if (!window.ethereum) return alert("Install MetaMask!");

      const connectBtn = document.getElementById("connectWallet");
      setLoading(connectBtn, true);

      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        account = await signer.getAddress();
        contract = new ethers.Contract(contractAddress, contractABI, signer);

        const network = await provider.getNetwork();
        if (network.chainId !== 8453) {
          alert("Please switch to Base Mainnet (chain ID: 8453).");
          setLoading(connectBtn, false);
          return;
        }

        document.getElementById("walletAddress").innerText = `Connected: ${shortAddr(account)}`;
        document.getElementById("payer").value = account;
        
        // Enable buttons
        document.getElementById("addExpense").disabled = false;
        document.getElementById("refreshBalances").disabled = false;

        refreshBalances();

        // Auto-reconnect on changes
        window.ethereum.on('accountsChanged', () => location.reload());
        window.ethereum.on('chainChanged', () => location.reload());

      } catch (err) {
        alert("Connection failed: " + err.message);
      } finally {
        setLoading(connectBtn, false);
      }
    }

    async function addExpense() {
      const amountInput = document.getElementById("amount").value.trim();
      const payerAddr = document.getElementById("payer").value.trim();
      const participantsInput = document.getElementById("participants").value.trim();
      const statusEl = document.getElementById("addExpenseStatus");

      if (!amountInput || !payerAddr || !participantsInput) {
        return alert("Please fill all fields.");
      }
      if (!ethers.utils.isAddress(payerAddr)) {
        return alert("Invalid payer address.");
      }

      const amount = ethers.utils.parseUnits(amountInput, 6);
      let participants = participantsInput
        .split(",")
        .map(a => a.trim())
        .filter(a => ethers.utils.isAddress(a));

      if (participants.length === 0) return alert("Add at least one valid participant.");

      // Auto-include payer if not in list
      if (!participants.some(p => p.toLowerCase() === payerAddr.toLowerCase())) {
        participants.push(payerAddr);
      }

      const addBtn = document.getElementById("addExpense");
      setLoading(addBtn, true);
      statusEl.textContent = "";
      statusEl.className = "";

      try {
        const tx = await contract.addExpense(amount, payerAddr, participants);
        statusEl.textContent = "Waiting for confirmation...";
        statusEl.className = "success";
        await tx.wait();
        
        statusEl.innerHTML = `Expense recorded! <a href="https://basescan.org/tx/${tx.hash}" target="_blank">View Tx</a>`;
        statusEl.className = "success";

        document.getElementById("amount").value = "";
        document.getElementById("participants").value = "";
        refreshBalances();
      } catch (err) {
        statusEl.textContent = "Failed: " + (err.reason || err.message);
        statusEl.className = "error";
      } finally {
        setLoading(addBtn, false);
      }
    }

    async function settleWith(creditor) {
      if (!contract || !account) return alert("Connect wallet first");

      if (!confirm(`Settle with ${shortAddr(creditor)}? This will send USDC on Base.`)) return;

      try {
        const tx = await contract.settle(creditor);
        alert("Settling... wait for confirmation");
        await tx.wait();
        alert(`Settled! Tx: https://basescan.org/tx/${tx.hash}`);
        refreshBalances();
      } catch (err) {
        alert("Settle failed: " + (err.reason || err.message));
      }
    }

    async function refreshBalances() {
      const balancesEl = document.getElementById("balances");
      const refreshBtn = document.getElementById("refreshBalances");

      if (!contract || !account) {
        balancesEl.innerHTML = "Connect wallet first...";
        return;
      }

      setLoading(refreshBtn, true);
      balancesEl.innerHTML = "Loading...";

      try {
        const [creditors, amounts] = await contract.getMyBalances();

        if (!creditors || creditors.length === 0) {
          balancesEl.innerHTML = "<em>No balances.</em>";
          setLoading(refreshBtn, false);
          return;
        }

        let output = "";
        for (let i = 0; i < creditors.length; i++) {
          const addr = creditors[i];
          
          // Skip self
          if (addr.toLowerCase() === account.toLowerCase()) continue;

          const raw = amounts[i].toString();
          const isNegative = raw.startsWith("-");
          const absRaw = isNegative ? raw.slice(1) : raw;
          const absBN = ethers.BigNumber.from(absRaw);
          const val = parseFloat(ethers.utils.formatUnits(absBN, 6)).toFixed(2);

          if (absBN.isZero()) continue;

          const action = isNegative 
            ? `<span style="color:#16a34a;">$${val} owed to you by</span> ${shortAddr(addr)}`
            : `<span style="color:#dc2626;">You owe $${val} to</span> ${shortAddr(addr)}`;

          output += `
            <div class="balance-item">
              <span>${action}</span>
              ${!isNegative ? `<button class="settle-btn" onclick="settleWith('${addr}')">Settle</button>` : ''}
            </div>`;
        }

        balancesEl.innerHTML = output || "<em>No balances.</em>";
      } catch (err) {
        console.error("refreshBalances error:", err);
        balancesEl.innerHTML = "<span class='error'>Error loading balances.</span>";
      } finally {
        setLoading(refreshBtn, false);
      }
    }

    // Event Listeners
    document.getElementById("connectWallet").onclick = connectWallet;
    document.getElementById("addExpense").onclick = addExpense;
    document.getElementById("refreshBalances").onclick = refreshBalances;

    // Auto-validate participants on blur
    document.getElementById("participants").addEventListener("blur", function() {
      const vals = this.value.split(",").map(a => a.trim());
      const valid = vals.filter(a => ethers.utils.isAddress(a));
      if (valid.length !== vals.length) {
        alert("Invalid address(es) removed.");
        this.value = valid.join(", ");
      }
    });
  </script>
</body>
</html>

