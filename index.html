<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settle Up - Split Bills in USDC</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #667eea;
      --primary-dark: #5568d3;
      --secondary: #764ba2;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --bg-light: #f9fafb;
      --text-dark: #111827;
      --text-medium: #6b7280;
      --text-light: #9ca3af;
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
    }
    
    [data-theme="dark"] {
      --bg-light: #1f2937;
      --text-dark: #f9fafb;
      --text-medium: #d1d5db;
      --text-light: #9ca3af;
      --glass-bg: rgba(0, 0, 0, 0.3);
      --glass-border: rgba(255, 255, 255, 0.1);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      padding-bottom: 60px;
      position: relative;
      overflow-x: hidden;
    }
    
    /* Animated gradient mesh background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(147, 51, 234, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(236, 72, 153, 0.2) 0%, transparent 50%);
      animation: gradientShift 15s ease infinite;
      z-index: -1;
    }
    
    @keyframes gradientShift {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.1); }
    }
    
    [data-theme="dark"] body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }
    
    .container { 
      max-width: 500px; 
      margin: 0 auto;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Header - NO STICKY, stays at top */
    .app-header {
      text-align: center;
      padding: 20px 0;
      margin-bottom: 30px;
      position: relative;
    }
    
    .app-header h1 {
  color: white;
  font-size: 36px;
  font-weight: 700;
  text-shadow: 0 4px 20px rgba(0,0,0,0.3);
  letter-spacing: -1px;
  display: inline-block;
}
    
    /* Dark mode toggle */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 999px;
      padding: 10px 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }
    
    /* Glassmorphism cards */
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 24px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
      position: relative;
      animation: cardEnter 0.4s ease;
      transition: all 0.3s ease;
    }
    
    @keyframes cardEnter {
      from { opacity: 0; transform: translateY(30px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    .card:hover {
      box-shadow: 
        0 12px 48px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }
    
    [data-theme="dark"] .card {
      background: rgba(31, 41, 55, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }
    
    h2 { 
      font-size: 20px; 
      margin-bottom: 20px; 
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    
    /* Badge with pulse animation */
    .badge {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      font-size: 11px;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 999px;
      margin-left: 8px;
      animation: pulse 2s ease infinite;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .form-group { margin-bottom: 20px; }
    
    label { 
      display: block; 
      font-size: 13px; 
      font-weight: 600; 
      color: var(--text-medium); 
      margin-bottom: 8px; 
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .label-hint { 
      font-size: 12px; 
      color: var(--text-light); 
      font-weight: normal; 
      text-transform: none; 
    }
    
    input, select {
      width: 100%;
      padding: 16px;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.5);
      color: var(--text-dark);
      font-weight: 500;
    }
    
    [data-theme="dark"] input,
    [data-theme="dark"] select {
      background: rgba(0, 0, 0, 0.2);
      border-color: rgba(255, 255, 255, 0.1);
      color: var(--text-dark);
    }
    
    input:focus, select:focus { 
      outline: none; 
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }
    
    button {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      letter-spacing: 0.3px;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    button:active::before {
      width: 300px;
      height: 300px;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    .btn-primary { 
      background: linear-gradient(135deg, var(--primary), var(--secondary)); 
      color: white;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:hover { 
      box-shadow: 0 6px 28px rgba(102, 126, 234, 0.5);
      transform: translateY(-2px);
    }
    
    .btn-primary:disabled { 
      opacity: 0.6; 
      cursor: not-allowed; 
      transform: none; 
      box-shadow: none;
    }
    
    .btn-secondary { 
      background: rgba(0, 0, 0, 0.05);
      color: var(--text-dark);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    [data-theme="dark"] .btn-secondary {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
    }
    
    .btn-secondary:hover { 
      background: rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }
    
    .btn-green { 
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
    }
    
    .btn-green:hover { 
      box-shadow: 0 6px 28px rgba(16, 185, 129, 0.5);
      transform: translateY(-2px);
    }
    
    /* Loading spinner with gradient */
    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .status { 
      padding: 14px; 
      border-radius: 12px; 
      margin-top: 12px; 
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .status.success { 
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    
    .status.error { 
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    
    .status.info { 
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      color: #1e40af;
      border: 1px solid #93c5fd;
    }
    
    /* Premium toast notifications */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      padding: 18px 24px;
      border-radius: 16px;
      box-shadow: 
        0 12px 48px rgba(0,0,0,0.2),
        inset 0 1px 0 rgba(255,255,255,0.6);
      display: flex;
      align-items: center;
      gap: 14px;
      z-index: 10000;
      animation: toastIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      max-width: 420px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    @keyframes toastIn {
      from { 
        opacity: 0; 
        transform: translateX(400px) scale(0.8); 
      }
      to { 
        opacity: 1; 
        transform: translateX(0) scale(1); 
      }
    }
    
    [data-theme="dark"] .toast {
      background: rgba(31, 41, 55, 0.98);
      border-color: rgba(255, 255, 255, 0.1);
    }
    
    .toast.success { 
      border-left: 4px solid #10b981;
      box-shadow: 
        0 12px 48px rgba(16, 185, 129, 0.2),
        inset 0 1px 0 rgba(255,255,255,0.6);
    }
    
    .toast.error { 
      border-left: 4px solid #ef4444;
      box-shadow: 
        0 12px 48px rgba(239, 68, 68, 0.2),
        inset 0 1px 0 rgba(255,255,255,0.6);
    }
    
    .toast.info { 
      border-left: 4px solid #3b82f6;
      box-shadow: 
        0 12px 48px rgba(59, 130, 246, 0.2),
        inset 0 1px 0 rgba(255,255,255,0.6);
    }
    
    /* Premium balance cards with gradient borders */
    .balance-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(249,250,251,0.9));
      border: 2px solid transparent;
      background-clip: padding-box;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .balance-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 16px;
      padding: 2px;
      background: linear-gradient(135deg, rgba(102,126,234,0.3), rgba(118,75,162,0.3));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .balance-card:hover::before {
      opacity: 1;
    }
    
    .balance-card:hover {
      box-shadow: 0 12px 40px rgba(0,0,0,0.12);
      transform: translateY(-4px);
    }
    
    [data-theme="dark"] .balance-card {
      background: linear-gradient(135deg, rgba(55,65,81,0.9), rgba(31,41,55,0.9));
    }
    
    .balance-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .category-icon {
      font-size: 28px;
      width: 52px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));
      transition: all 0.3s ease;
    }
    
    .balance-card:hover .category-icon {
      transform: scale(1.1) rotate(5deg);
    }
    
    .balance-amount { 
      font-size: 26px; 
      font-weight: 800;
      flex: 1;
      letter-spacing: -0.5px;
    }
    
    .balance-amount.positive { 
      background: linear-gradient(135deg, #059669, #10b981);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .balance-amount.negative { 
      background: linear-gradient(135deg, #dc2626, #ef4444);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .balance-details { 
      font-size: 14px; 
      color: var(--text-medium); 
      margin-top: 4px;
      font-weight: 500;
    }
    
    /* Premium chips with hover glow */
    .contact-chip {
      display: inline-block;
      padding: 12px 18px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(0,0,0,0.08);
      border-radius: 999px;
      margin: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 46px;
      display: inline-flex;
      align-items: center;
      position: relative;
    }
    
    [data-theme="dark"] .contact-chip {
      background: rgba(0, 0, 0, 0.3);
      border-color: rgba(255, 255, 255, 0.1);
    }
    
    .contact-chip:hover { 
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.1);
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    
    .contact-chip.selected { 
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border-color: transparent;
      box-shadow: 0 6px 24px rgba(102, 126, 234, 0.4);
      transform: translateY(-2px);
    }
    
    .info-box {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border: 2px solid #fbbf24;
      border-radius: 14px;
      padding: 14px;
      font-size: 13px;
      color: #92400e;
      margin-bottom: 20px;
      font-weight: 500;
      line-height: 1.6;
    }
    
    [data-theme="dark"] .info-box {
      background: linear-gradient(135deg, rgba(254, 243, 199, 0.2), rgba(253, 230, 138, 0.2));
      color: #fcd34d;
    }
    
    .hidden { display: none !important; }

    /* Welcome modal with backdrop blur */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20000;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }
    
    .modal {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 36px;
      max-width: 520px;
      width: 100%;
      box-shadow: 0 24px 80px rgba(0,0,0,0.3);
      animation: modalPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    @keyframes modalPop {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    [data-theme="dark"] .modal {
      background: rgba(31, 41, 55, 0.98);
      border-color: rgba(255, 255, 255, 0.1);
    }
    
    .modal h2 {
      font-size: 28px;
      margin-bottom: 18px;
      color: var(--text-dark);
      font-weight: 800;
      letter-spacing: -1px;
    }
    
    .modal-content {
      color: var(--text-medium);
      font-size: 15px;
      line-height: 1.7;
      margin-bottom: 28px;
    }
    
    .modal-content ul {
      margin: 14px 0;
      padding-left: 22px;
    }
    
    .modal-content li {
      margin: 10px 0;
    }

    /* Premium contact items */
    .contact-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 18px;
      background: linear-gradient(135deg, rgba(249,250,251,0.8), rgba(255,255,255,0.8));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 14px;
      margin-bottom: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    [data-theme="dark"] .contact-item {
      background: linear-gradient(135deg, rgba(55,65,81,0.6), rgba(31,41,55,0.6));
      border-color: rgba(255, 255, 255, 0.08);
    }

    .contact-item:hover {
      border-color: rgba(102, 126, 234, 0.4);
      box-shadow: 0 8px 28px rgba(102, 126, 234, 0.15);
      transform: translateY(-3px);
    }

    .contact-info {
      flex: 1;
      min-width: 0;
    }

    .contact-name-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .contact-name {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-dark);
      letter-spacing: -0.3px;
    }

    .contact-address {
      font-size: 12px;
      color: var(--text-light);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      margin-top: 4px;
      word-break: break-all;
    }

    .contact-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0;
      transform: translateX(6px);
      transition: all 0.3s ease;
    }

    .contact-item:hover .contact-actions {
      opacity: 1;
      transform: translateX(0);
    }

    .icon-btn {
      border: none;
      background: rgba(0, 0, 0, 0.05);
      color: var(--text-medium);
      border-radius: 999px;
      width: 40px;
      height: 40px;
      min-height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin: 0;
    }
    
    [data-theme="dark"] .icon-btn {
      background: rgba(255, 255, 255, 0.05);
    }

    .icon-btn:hover {
      background: rgba(102, 126, 234, 0.15);
      color: var(--primary);
      transform: scale(1.15) rotate(-5deg);
    }

    .icon-btn.delete-btn {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
    }

    .icon-btn.delete-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #b91c1c;
      transform: scale(1.15) rotate(5deg);
    }

    .contact-edit-input {
      border-radius: 999px;
      border: 2px solid var(--primary);
      padding: 6px 12px;
      font-size: 14px;
      font-weight: 600;
      width: 180px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
    }

    .contact-edit-input:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
      transform: scale(1.02);
    }

    /* Premium empty states */
    .empty-state {
      text-align: center;
      padding: 50px 24px;
      color: var(--text-medium);
    }
    
    .empty-state-icon {
      font-size: 72px;
      margin-bottom: 20px;
      opacity: 0.4;
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .empty-state-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 10px;
      letter-spacing: -0.5px;
    }
    
    .empty-state-text {
      font-size: 14px;
      color: var(--text-medium);
    }
    
    /* Skeleton loader with shimmer */
    .skeleton {
      background: linear-gradient(90deg, 
        rgba(243,244,246,1) 25%, 
        rgba(229,231,235,1) 50%, 
        rgba(243,244,246,1) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      border-radius: 12px;
      height: 24px;
      margin: 10px 0;
    }
    
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    [data-theme="dark"] .skeleton {
      background: linear-gradient(90deg, 
        rgba(55,65,81,1) 25%, 
        rgba(75,85,99,1) 50%, 
        rgba(55,65,81,1) 75%);
      background-size: 200% 100%;
    }
    
    /* Premium confetti */
    @keyframes confetti-fall {
      to { 
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }
    
    .confetti {
      position: fixed;
      width: 12px;
      height: 12px;
      top: -20px;
      animation: confetti-fall 3s linear;
      z-index: 99999;
      border-radius: 2px;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.3);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.5);
    }
    
    /* Responsive */
    @media (max-width: 640px) {
      body { padding: 12px; padding-bottom: 50px; }
      .container { padding: 0; }
      .card { padding: 22px; border-radius: 20px; }
      .app-header h1 { font-size: 28px; }
      .toast { 
        right: 12px; 
        bottom: 12px; 
        max-width: calc(100vw - 24px);
        padding: 14px 18px;
      }
      .theme-toggle { top: 12px; right: 12px; }
      .balance-amount { font-size: 22px; }
      .category-icon { width: 44px; height: 44px; font-size: 24px; }
    }
    
    /* Mobile touch improvements */
    @media (max-width: 640px) {
      input, select, button { min-height: 48px; }
      .contact-chip { min-height: 48px; padding: 10px 16px; }
      .icon-btn { width: 44px; height: 44px; min-height: 44px; }
    }
  </style>
</head>
<body>
  <!-- Dark mode toggle -->
  <div class="theme-toggle" id="themeToggle" title="Toggle dark mode">
    <span id="themeIcon">üåô</span>
  </div>

  <!-- Welcome Modal -->
  <div id="welcomeModal" class="modal-overlay hidden">
    <div class="modal">
      <h2>üëã Welcome to Settle Up!</h2>
      <div class="modal-content">
        <p><strong>Split bills fairly with friends using USDC on Base blockchain.</strong></p>
        <ul>
          <li>üí∞ <strong>Add Expenses:</strong> Enter the total, select who paid, and who shared the bill</li>
          <li>üìä <strong>Track Balances:</strong> See who owes what, organized by category</li>
          <li>üí≥ <strong>Settle Up:</strong> Pay directly with USDC in one click</li>
          <li>‚úèÔ∏è <strong>Adjust Anytime:</strong> Made a mistake? Edit balances easily</li>
        </ul>
        <p style="margin-top: 18px; font-size: 13px; color: var(--text-light);">Your data is stored locally. Transactions are secured on Base blockchain.</p>
      </div>
      <button class="btn-primary" id="closeWelcomeBtn">Get Started</button>
    </div>
  </div>

  <div class="container">
    <div class="app-header">
      <h1>üí∞ Settle Up</h1>
    </div>

    <!-- Connect Wallet -->
    <div class="card" id="connectCard">
      <h2>üîó Connect Wallet</h2>
      <button class="btn-primary" id="connectBtn">Connect MetaMask</button>
      <div id="connectStatus"></div>
    </div>

    <!-- Wallet Info -->
    <div class="card hidden" id="walletCard">
      <h2>üëõ Wallet Connected</h2>
      <div id="walletInfo"></div>
    </div>

    <!-- Add Expense -->
    <div class="card hidden" id="expenseCard">
      <h2>üìù Add Expense</h2>
      
      <div class="info-box">
        <strong>How it works:</strong> Enter the total bill. Select who paid. Select everyone who shared the expense (including the payer). The cost is split equally.
      </div>
      
      <div class="form-group">
        <label>Total Amount (USDC)</label>
        <input type="number" id="expenseAmount" placeholder="100.00" step="0.01" max="1000000" />
      </div>
      
      <div class="form-group">
        <label>Category</label>
        <select id="expenseCategory">
          <option value="Food">üçï Food</option>
          <option value="Transport">üöó Transport</option>
          <option value="Entertainment">üé¨ Entertainment</option>
          <option value="Utilities">üí° Utilities</option>
          <option value="Other">üì¶ Other</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>
          Who Paid? 
          <span class="label-hint">(click one)</span>
        </label>
        <div id="payerChips"></div>
      </div>
      
      <div class="form-group">
        <label>
          Who Shared the Bill? 
          <span class="label-hint">(click all who participated, including payer)</span>
        </label>
        <div id="participantChips"></div>
      </div>
      
      <div id="splitPreview" style="background:linear-gradient(135deg, #f0fdf4, #dcfce7);border:2px solid #86efac;border-radius:12px;padding:14px;margin-bottom:18px;font-size:14px;display:none;"></div>
      
      <button class="btn-primary" id="addExpenseBtn">üí≥ Record Expense</button>
      <div id="expenseStatus"></div>
    </div>

    <!-- Balances -->
    <div class="card hidden" id="balancesCard">
      <h2>
        üíµ Balances
        <span id="balanceBadge" class="badge hidden">0</span>
        <button class="btn-secondary" id="refreshBtn" style="width:auto;margin-left:auto;padding:10px 18px;margin-top:0;">üîÑ Refresh</button>
      </h2>
      <div style="clear:both;"></div>
      <div id="balancesList" style="margin-top:18px;"></div>
    </div>

    <!-- Contacts -->
    <div class="card hidden" id="contactsCard">
      <h2>üë• Contacts</h2>
      <div id="contactsList"></div>
      <div class="form-group" style="margin-top:18px;">
        <input type="text" id="newContactAddr" placeholder="Address (0x...)" />
        <input type="text" id="newContactName" placeholder="Name" style="margin-top:10px;" />
        <button class="btn-green" id="addContactBtn" style="margin-top:10px;">+ Add Contact</button>
      </div>
    </div>
  </div>

  <script>
    // ========== CONFIGURATION ==========
    const CONTRACT_ADDRESS = "0x87DE5D58F0d25Db2A7F3E8af264AFCd82e9e87dC";
    const USDC_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
    const CATEGORIES = ["Food", "Transport", "Entertainment", "Utilities", "Other"];
    
    const CATEGORY_ICONS = {
      "Food": "üçï",
      "Transport": "üöó",
      "Entertainment": "üé¨",
      "Utilities": "üí°",
      "Other": "üì¶"
    };

    // ========== CONTRACT ABI ==========
    const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"usdcAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"creditor","type":"address"},{"indexed":true,"internalType":"address","name":"debtor","type":"address"},{"indexed":false,"internalType":"uint256","name":"oldAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"newAmount","type":"uint256"},{"indexed":false,"internalType":"string","name":"category","type":"string"}],"name":"BalanceAdjusted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"totalAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"sharePerPerson","type":"uint256"},{"indexed":false,"internalType":"address[]","name":"participants","type":"address[]"},{"indexed":false,"internalType":"string","name":"category","type":"string"}],"name":"ExpenseAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"debtor","type":"address"},{"indexed":true,"internalType":"address","name":"creditor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"category","type":"string"}],"name":"Settled","type":"event"},{"inputs":[],"name":"MAX_BALANCE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_PARTICIPANTS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"address","name":"payer","type":"address"},{"internalType":"address[]","name":"participants","type":"address[]"},{"internalType":"string","name":"category","type":"string"}],"name":"addExpense","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"debtor","type":"address"},{"internalType":"uint256","name":"newAmount","type":"uint256"},{"internalType":"string","name":"category","type":"string"}],"name":"adjustBalance","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"},{"internalType":"string","name":"","type":"string"}],"name":"balances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"debtor","type":"address"},{"internalType":"string","name":"category","type":"string"}],"name":"creditFrom","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"creditor","type":"address"},{"internalType":"string","name":"category","type":"string"}],"name":"debtTo","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"debtor","type":"address"},{"internalType":"address","name":"creditor","type":"address"},{"internalType":"string","name":"category","type":"string"}],"name":"getBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getConstants","outputs":[{"internalType":"uint256","name":"maxBalance","type":"uint256"},{"internalType":"uint256","name":"maxParticipants","type":"uint256"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"address","name":"creditor","type":"address"},{"internalType":"string","name":"category","type":"string"}],"name":"settle","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"usdc","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"}];

    const USDC_ABI = ["function balanceOf(address) view returns (uint256)","function allowance(address,address) view returns (uint256)","function approve(address,uint256) returns (bool)"];

    // ========== STATE ==========
    let provider, signer, contract, usdcContract;
    let account = null;
    let contacts = {};
    let selectedPayer = null;
    let selectedSplitters = [];

    // ========== DARK MODE ==========
    function initTheme() {
      const saved = localStorage.getItem('settleup_theme');
      if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
      }
    }
    
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const newTheme = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      document.getElementById('themeIcon').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem('settleup_theme', newTheme);
    }

    // ========== UTILITIES ==========
    function shortAddr(addr) {
      return addr ? addr.slice(0, 6) + "..." + addr.slice(-4) : "";
    }

    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.className = `status ${type}`;
      el.innerHTML = `${type === 'info' ? '<span class="spinner"></span>' : ''}${message}`;
    }
    
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
      toast.innerHTML = `<span style="font-size:26px;">${icon}</span><span style="font-weight:600;">${message}</span>`;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(400px)';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }
    
    function triggerConfetti() {
      const colors = ['#667eea', '#764ba2', '#10b981', '#ef4444', '#f59e0b', '#ec4899', '#8b5cf6'];
      for (let i = 0; i < 80; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
          confetti.style.animationDelay = Math.random() * 0.5 + 's';
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 5000);
        }, i * 20);
      }
    }

    function getContactName(addr) {
      const normalized = addr.toLowerCase();
      if (normalized === account?.toLowerCase()) return "Me";
      return contacts[normalized] || shortAddr(addr);
    }
    
    function closeWelcome() {
      const modal = document.getElementById('welcomeModal');
      if (modal) {
        modal.style.opacity = '0';
        setTimeout(() => modal.classList.add('hidden'), 300);
        localStorage.setItem('settleup_welcome_seen', 'true');
      }
    }
    
    function showWelcomeIfNeeded() {
      if (!localStorage.getItem('settleup_welcome_seen')) {
        const modal = document.getElementById('welcomeModal');
        if (modal) {
          modal.classList.remove('hidden');
        }
      }
    }

    // ========== CONTACTS ==========
    function loadContacts() {
      const stored = localStorage.getItem("settleup_contacts_v6");
      if (stored) {
        try { contacts = JSON.parse(stored); }
        catch (e) { contacts = {}; }
      }
    }

    function saveContacts() {
      localStorage.setItem("settleup_contacts_v6", JSON.stringify(contacts));
    }

    function addContact(addr, name) {
      if (!ethers.utils.isAddress(addr)) {
        showToast("Invalid address", "error");
        return;
      }
      const normalized = addr.toLowerCase();
      if (normalized === account?.toLowerCase()) {
        showToast("You can't add yourself as a contact!", "error");
        return;
      }
      contacts[normalized] = name || shortAddr(addr);
      saveContacts();
      renderAll();
      showToast(`Added ${name || shortAddr(addr)}`, "success");
    }

    function renderContacts() {
      const list = document.getElementById("contactsList");
      list.innerHTML = "";
      const otherContacts = Object.entries(contacts).filter(
        ([addr]) => addr !== account?.toLowerCase()
      );

      if (otherContacts.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üë•</div>
            <div class="empty-state-title">No contacts yet</div>
            <div class="empty-state-text">Add friends to start splitting bills!</div>
          </div>
        `;
        return;
      }

      otherContacts.forEach(([addr, name]) => {
        const wrapper = document.createElement("div");
        wrapper.className = "contact-item";

        const info = document.createElement("div");
        info.className = "contact-info";

        const nameRow = document.createElement("div");
        nameRow.className = "contact-name-row";

        const nameEl = document.createElement("span");
        nameEl.className = "contact-name";
        nameEl.textContent = name;

        nameRow.appendChild(nameEl);

        const addrEl = document.createElement("div");
        addrEl.className = "contact-address";
        addrEl.textContent = shortAddr(addr);

        info.appendChild(nameRow);
        info.appendChild(addrEl);

        const actions = document.createElement("div");
        actions.className = "contact-actions";

        const editBtn = document.createElement("button");
        editBtn.className = "icon-btn";
        editBtn.type = "button";
        editBtn.title = "Edit name";
        editBtn.innerHTML = "‚úèÔ∏è";
        editBtn.onclick = () => startEditContact(addr, nameEl);

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "icon-btn delete-btn";
        deleteBtn.type = "button";
        deleteBtn.title = "Remove contact";
        deleteBtn.innerHTML = "üóë";
        deleteBtn.onclick = () => deleteContact(addr);

        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);

        wrapper.appendChild(info);
        wrapper.appendChild(actions);
        list.appendChild(wrapper);
      });
    }

    function startEditContact(addr, nameElement) {
      const currentName = contacts[addr.toLowerCase()] || nameElement.textContent;
      const input = document.createElement("input");
      input.type = "text";
      input.value = currentName;
      input.className = "contact-edit-input";

      const parent = nameElement.parentNode;
      parent.replaceChild(input, nameElement);
      input.focus();
      input.select();

      const finish = () => finishEditContact(addr, input, nameElement);

      input.addEventListener("blur", finish);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") finish();
        if (e.key === "Escape") {
          input.value = currentName;
          finish();
        }
      });
    }

    function finishEditContact(addr, input, nameElement) {
      const newName = input.value.trim() || shortAddr(addr);
      contacts[addr.toLowerCase()] = newName;
      saveContacts();

      nameElement.textContent = newName;
      const parent = input.parentNode;
      parent.replaceChild(nameElement, input);
      
      showToast(`Updated to ${newName}`, "success");
    }

    function deleteContact(addr) {
      const name = contacts[addr.toLowerCase()] || shortAddr(addr);
      const confirmed = confirm(
        `Remove ${name} from your contacts?\n\nThis does NOT affect any on-chain balances or debts.`
      );
      if (!confirmed) return;

      delete contacts[addr.toLowerCase()];
      saveContacts();
      renderAll();
      showToast(`Removed ${name}`, "info");
    }

    // ========== CHIPS ==========
    function renderPayerChips() {
      const container = document.getElementById("payerChips");
      container.innerHTML = "";
      if (account) {
        const meChip = document.createElement("span");
        meChip.className = "contact-chip" + (selectedPayer === account.toLowerCase() ? " selected" : "");
        meChip.textContent = "üë§ Me";
        meChip.onclick = () => { selectedPayer = account.toLowerCase(); renderAll(); };
        container.appendChild(meChip);
      }
      Object.entries(contacts).forEach(([addr, name]) => {
        if (addr === account?.toLowerCase()) return;
        const chip = document.createElement("span");
        chip.className = "contact-chip" + (selectedPayer === addr ? " selected" : "");
        chip.textContent = name;
        chip.onclick = () => { selectedPayer = addr; renderAll(); };
        container.appendChild(chip);
      });
    }

    function renderSplitterChips() {
      const container = document.getElementById("participantChips");
      container.innerHTML = "";
      if (account) {
        const meChip = document.createElement("span");
        meChip.className = "contact-chip" + (selectedSplitters.includes(account.toLowerCase()) ? " selected" : "");
        meChip.textContent = "üë§ Me";
        meChip.onclick = () => toggleSplitter(account.toLowerCase());
        container.appendChild(meChip);
      }
      Object.entries(contacts).forEach(([addr, name]) => {
        if (addr === account?.toLowerCase()) return;
        const chip = document.createElement("span");
        chip.className = "contact-chip" + (selectedSplitters.includes(addr) ? " selected" : "");
        chip.textContent = name;
        chip.onclick = () => toggleSplitter(addr);
        container.appendChild(chip);
      });
    }

    function toggleSplitter(addr) {
      const idx = selectedSplitters.indexOf(addr);
      if (idx >= 0) selectedSplitters.splice(idx, 1);
      else selectedSplitters.push(addr);
      renderAll();
    }

    function updateSplitPreview() {
      const preview = document.getElementById("splitPreview");
      const amountInput = document.getElementById("expenseAmount").value;
      const amount = parseFloat(amountInput) || 0;
      if (amount <= 0 || !selectedPayer || selectedSplitters.length === 0) {
        preview.style.display = "none";
        return;
      }
      if (amount > 1000000) {
        preview.innerHTML = `<strong>‚ö†Ô∏è Amount exceeds 1M USDC limit</strong>`;
        preview.style.display = "block";
        return;
      }
      const share = amount / selectedSplitters.length;
      const payerName = getContactName(selectedPayer);
      const debtors = selectedSplitters.filter(addr => addr !== selectedPayer);
      if (debtors.length === 0) {
        preview.innerHTML = `<strong>‚ö†Ô∏è No one owes anything</strong><br>Select at least one other person who shared the bill.`;
        preview.style.display = "block";
        return;
      }
      let html = `<strong style="font-size:15px;">üí° Split Preview:</strong><br>Total: <strong>$${amount.toFixed(2)}</strong> √∑ ${selectedSplitters.length} people = <strong>$${share.toFixed(2)}</strong> each<br><br>`;
      debtors.forEach(addr => {
        html += `‚Ä¢ ${getContactName(addr)} owes ${payerName}: <strong>$${share.toFixed(2)}</strong><br>`;
      });
      preview.innerHTML = html;
      preview.style.display = "block";
    }

    function renderAll() {
      renderContacts();
      renderPayerChips();
      renderSplitterChips();
      updateSplitPreview();
    }

    // ========== WALLET CONNECTION ==========
    async function connectWallet() {
      if (!window.ethereum) {
        showStatus("connectStatus", "MetaMask not found!", "error");
        showToast("Please install MetaMask", "error");
        return;
      }
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        account = await signer.getAddress();
        const network = await provider.getNetwork();
        if (network.chainId !== 8453) {
          try {
            await window.ethereum.request({
              method: "wallet_switchEthereumChain",
              params: [{ chainId: "0x2105" }]
            });
            location.reload();
            return;
          } catch (e) {
            showStatus("connectStatus", "Please switch to Base Mainnet!", "error");
            return;
          }
        }
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        usdcContract = new ethers.Contract(USDC_ADDRESS, USDC_ABI, signer);
        loadContacts();
        const myAddr = account.toLowerCase();
        if (contacts[myAddr]) {
          delete contacts[myAddr];
          saveContacts();
        }
        selectedPayer = account.toLowerCase();
        selectedSplitters = [account.toLowerCase()];
        document.getElementById("connectCard").classList.add("hidden");
        document.getElementById("walletCard").classList.remove("hidden");
        document.getElementById("expenseCard").classList.remove("hidden");
        document.getElementById("balancesCard").classList.remove("hidden");
        document.getElementById("contactsCard").classList.remove("hidden");
        const usdcBal = await usdcContract.balanceOf(account);
        document.getElementById("walletInfo").innerHTML = `<p style="font-size:15px;"><strong>Address:</strong> <span style="font-family:monospace;">${shortAddr(account)}</span></p><p style="font-size:20px;font-weight:700;margin-top:8px;"><strong>USDC Balance:</strong> <span style="color:var(--primary);">${parseFloat(ethers.utils.formatUnits(usdcBal, 6)).toFixed(2)} USDC</span></p>`;
        renderAll();
        await refreshBalances();
        showToast("Wallet connected successfully!", "success");
      } catch (e) {
        showStatus("connectStatus", e.message, "error");
      }
    }

    // ========== ADD EXPENSE ==========
    async function addExpense() {
      const amountInput = document.getElementById("expenseAmount").value;
      const category = document.getElementById("expenseCategory").value;
      if (!amountInput || parseFloat(amountInput) <= 0) {
        showStatus("expenseStatus", "Enter a valid amount", "error");
        return;
      }
      if (parseFloat(amountInput) > 1000000) {
        showStatus("expenseStatus", "Amount exceeds 1M USDC limit", "error");
        return;
      }
      if (!selectedPayer) {
        showStatus("expenseStatus", "Select who paid", "error");
        return;
      }
      if (selectedSplitters.length < 2) {
        showStatus("expenseStatus", "Select at least 2 people who shared the bill", "error");
        return;
      }
      if (selectedSplitters.length > 50) {
        showStatus("expenseStatus", "Maximum 50 participants allowed", "error");
        return;
      }
      const participants = selectedSplitters.filter(addr => addr !== selectedPayer);
      if (participants.length === 0) {
        showStatus("expenseStatus", "No one owes the payer! Select others who shared the bill.", "error");
        return;
      }
      const amount = ethers.utils.parseUnits(amountInput, 6);
      const payerChecksum = ethers.utils.getAddress(selectedPayer);
      const participantsChecksum = participants.map(p => ethers.utils.getAddress(p));
      const btn = document.getElementById("addExpenseBtn");
      btn.disabled = true;
      showStatus("expenseStatus", "Sending transaction...", "info");
      try {
        const tx = await contract.addExpense(amount, payerChecksum, participantsChecksum, category);
        showStatus("expenseStatus", "Waiting for confirmation...", "info");
        showToast("Transaction sent! Waiting for confirmation...", "info");
        await tx.wait();
        showStatus("expenseStatus", `‚úÖ Expense recorded!`, "success");
        showToast(`Expense recorded successfully!`, "success");
        document.getElementById("expenseAmount").value = "";
        selectedSplitters = [account.toLowerCase()];
        renderAll();
        for (const p of participants) {
          if (!contacts[p.toLowerCase()]) {
            const name = prompt(`Save ${shortAddr(p)} as contact:`, shortAddr(p));
            if (name && name.trim()) addContact(p, name.trim());
          }
        }
        await new Promise(r => setTimeout(r, 3000));
        await refreshBalances();
      } catch (e) {
        showStatus("expenseStatus", `Error: ${e.reason || e.message}`, "error");
        showToast(`Transaction failed: ${e.reason || e.message}`, "error");
      } finally {
        btn.disabled = false;
      }
    }

    // ========== REFRESH BALANCES ==========
    async function refreshBalances() {
      const list = document.getElementById("balancesList");
      list.innerHTML = `
        <div class="skeleton" style="height:70px;margin:10px 0;"></div>
        <div class="skeleton" style="height:70px;margin:10px 0;"></div>
        <div class="skeleton" style="height:70px;margin:10px 0;"></div>
      `;
      
      const balances = [];
      const contactAddrs = Object.keys(contacts).filter(a => a !== account.toLowerCase());
      
      if (contactAddrs.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üí∏</div>
            <div class="empty-state-title">No contacts added</div>
            <div class="empty-state-text">Add contacts to see balances with them</div>
          </div>
        `;
        return;
      }
      
      for (const contactAddr of contactAddrs) {
        for (const category of CATEGORIES) {
          try {
            await new Promise(r => setTimeout(r, 100));
            const contactChecksum = ethers.utils.getAddress(contactAddr);
            const accountChecksum = ethers.utils.getAddress(account);
            const theyOweUs = await contract.getBalance(contactChecksum, accountChecksum, category);
            const weOweThem = await contract.getBalance(accountChecksum, contactChecksum, category);
            if (!theyOweUs.isZero()) {
              balances.push({ contact: contactAddr, category, type: "credit", amount: theyOweUs });
            }
            if (!weOweThem.isZero()) {
              balances.push({ contact: contactAddr, category, type: "debt", amount: weOweThem });
            }
          } catch (e) {
            console.error(`Error checking ${contactAddr}/${category}:`, e);
          }
        }
      }
      
      const badge = document.getElementById('balanceBadge');
      if (balances.length > 0) {
        badge.textContent = balances.length;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
      
      if (balances.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ú®</div>
            <div class="empty-state-title">All settled up!</div>
            <div class="empty-state-text">No outstanding balances</div>
          </div>
        `;
        triggerConfetti();
        return;
      }
      
      list.innerHTML = "";
      for (const b of balances) {
        const contactName = getContactName(b.contact);
        const amountStr = parseFloat(ethers.utils.formatUnits(b.amount, 6)).toFixed(2);
        const card = document.createElement("div");
        card.className = "balance-card";
        
        const icon = CATEGORY_ICONS[b.category] || "üì¶";
        
        if (b.type === "credit") {
          card.innerHTML = `
            <div class="balance-header">
              <div class="category-icon">${icon}</div>
              <div class="balance-amount positive">+${amountStr} USDC</div>
            </div>
            <div class="balance-details">${contactName} owes you ‚Ä¢ ${b.category}</div>
            <button class="btn-secondary" style="margin-top:12px;width:auto;padding:10px 18px;" onclick="adjustBalancePrompt('${b.contact}', '${b.category}', '${amountStr}')">‚úèÔ∏è Adjust</button>
          `;
        } else {
          card.innerHTML = `
            <div class="balance-header">
              <div class="category-icon">${icon}</div>
              <div class="balance-amount negative">-${amountStr} USDC</div>
            </div>
            <div class="balance-details">You owe ${contactName} ‚Ä¢ ${b.category}</div>
            <button class="btn-green" style="margin-top:12px;width:auto;padding:10px 18px;" onclick="settleBalance('${b.contact}', '${b.category}')">üí≥ Pay Now</button>
          `;
        }
        list.appendChild(card);
      }
    }

    // ========== ADJUST BALANCE ==========
    async function adjustBalancePrompt(debtor, category, currentAmountStr) {
      const name = getContactName(debtor);
      const input = prompt(`Set new amount that ${name} owes you for ${category}.\n(Current: ${currentAmountStr} USDC)\nEnter 0 to clear:`, currentAmountStr);
      if (input === null) return;
      const value = parseFloat(input);
      if (isNaN(value) || value < 0) {
        showToast("Enter a non-negative number", "error");
        return;
      }
      if (value > 1000000) {
        showToast("Amount exceeds 1M USDC limit", "error");
        return;
      }
      try {
        const debtorChecksum = ethers.utils.getAddress(debtor);
        const newAmount = ethers.utils.parseUnits(value.toString(), 6);
        showToast("Sending adjustment...", "info");
        const tx = await contract.adjustBalance(debtorChecksum, newAmount, category);
        await tx.wait();
        showToast("Balance adjusted successfully!", "success");
        await new Promise(r => setTimeout(r, 2000));
        await refreshBalances();
      } catch (e) {
        showToast("Adjust failed: " + (e.reason || e.message), "error");
      }
    }

    // ========== SETTLE ==========
    async function settleBalance(creditor, category) {
      const name = getContactName(creditor);
      if (!confirm(`Pay your ${category} balance to ${name}?`)) return;
      try {
        const creditorChecksum = ethers.utils.getAddress(creditor);
        const balance = await contract.getBalance(account, creditorChecksum, category);
        if (balance.isZero()) {
          showToast("No balance to settle!", "error");
          return;
        }
        
        showToast("Checking USDC allowance...", "info");
        const allowance = await usdcContract.allowance(account, CONTRACT_ADDRESS);
        if (allowance.lt(balance)) {
          showToast("Approving USDC...", "info");
          const approveTx = await usdcContract.approve(CONTRACT_ADDRESS, balance);
          await approveTx.wait();
        }
        
        showToast("Settling payment...", "info");
        const tx = await contract.settle(creditorChecksum, category);
        await tx.wait();
        
        showToast("Payment settled successfully! üéâ", "success");
        await new Promise(r => setTimeout(r, 2000));
        await refreshBalances();
        
        const usdcBal = await usdcContract.balanceOf(account);
        document.getElementById("walletInfo").innerHTML = `<p style="font-size:15px;"><strong>Address:</strong> <span style="font-family:monospace;">${shortAddr(account)}</span></p><p style="font-size:20px;font-weight:700;margin-top:8px;"><strong>USDC Balance:</strong> <span style="color:var(--primary);">${parseFloat(ethers.utils.formatUnits(usdcBal, 6)).toFixed(2)} USDC</span></p>`;
      } catch (e) {
        showToast("Settlement failed: " + (e.reason || e.message), "error");
      }
    }

    // ========== EVENT LISTENERS ==========
    document.getElementById("connectBtn").onclick = connectWallet;
    document.getElementById("addExpenseBtn").onclick = addExpense;
    document.getElementById("refreshBtn").onclick = refreshBalances;
    document.getElementById("expenseAmount").oninput = updateSplitPreview;
    document.getElementById("addContactBtn").onclick = () => {
      const addr = document.getElementById("newContactAddr").value.trim();
      const name = document.getElementById("newContactName").value.trim();
      if (addr) {
        addContact(addr, name || shortAddr(addr));
        document.getElementById("newContactAddr").value = "";
        document.getElementById("newContactName").value = "";
      } else {
        showToast("Enter an address", "error");
      }
    };
    
    document.getElementById("closeWelcomeBtn").onclick = closeWelcome;
    document.getElementById("themeToggle").onclick = toggleTheme;
    
    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      initTheme();
      showWelcomeIfNeeded();
    });
  </script>
</body>
</html>
