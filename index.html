<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SettleUp - Split Bills in USDC</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 500px; margin: 0 auto; }
    .card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 { text-align: center; color: white; margin-bottom: 20px; font-size: 28px; }
    h2 { font-size: 18px; margin-bottom: 16px; color: #333; }
    .form-group { margin-bottom: 16px; }
    label { display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 6px; text-transform: uppercase; }
    .label-hint { font-size: 11px; color: #999; font-weight: normal; text-transform: none; }
    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.2s ease;
    }
    input:focus, select:focus { outline: none; border-color: #667eea; }
    button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.2s;
    }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: #f0f0f0; color: #333; }
    .btn-secondary:hover { background: #e0e0e0; }
    .btn-green { background: #10b981; color: white; }
    .btn-green:hover { opacity: 0.9; }
    .status { padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 14px; }
    .status.success { background: #d1fae5; color: #065f46; }
    .status.error { background: #fee2e2; color: #991b1b; }
    .status.info { background: #dbeafe; color: #1e40af; }
    .balance-card {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }
    .balance-card:hover {
      border-color: #d1d5db;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .balance-amount { font-size: 20px; font-weight: 700; }
    .balance-amount.positive { color: #059669; }
    .balance-amount.negative { color: #dc2626; }
    .balance-details { font-size: 14px; color: #6b7280; margin-top: 4px; }
    .contact-chip {
      display: inline-block;
      padding: 8px 14px;
      background: #f3f4f6;
      border: 2px solid #e5e7eb;
      border-radius: 20px;
      margin: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .contact-chip:hover { 
      border-color: #667eea; 
      background: #ede9fe;
      transform: translateY(-1px);
    }
    .contact-chip.selected { background: #667eea; color: white; border-color: #667eea; }
    .info-box {
      background: #fef3c7;
      border: 2px solid #fcd34d;
      border-radius: 10px;
      padding: 12px;
      font-size: 13px;
      color: #92400e;
      margin-bottom: 16px;
    }
    .hidden { display: none; }

    /* CONTACTS ‚Äì improved UI/UX */
    .contact-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 10px;
      transition: all 0.25s ease;
      position: relative;
    }

    .contact-item:hover {
      border-color: #6366f1;
      box-shadow: 0 6px 14px rgba(99, 102, 241, 0.12);
      transform: translateY(-2px);
    }

    .contact-info {
      flex: 1;
      min-width: 0;
    }

    .contact-name-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .contact-name {
      font-size: 15px;
      font-weight: 600;
      color: #111827;
    }

    .contact-address {
      font-size: 12px;
      color: #6b7280;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      margin-top: 3px;
      word-break: break-all;
    }

    /* Actions appear on hover only */
    .contact-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      opacity: 0;
      transform: translateX(4px);
      transition: all 0.2s ease;
    }

    .contact-item:hover .contact-actions {
      opacity: 1;
      transform: translateX(0);
    }

    /* Icon buttons (edit + delete) */
    .icon-btn {
      border: none;
      background: #f3f4f6;
      color: #4b5563;
      border-radius: 999px;
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .icon-btn:hover {
      background: #e5e7eb;
      color: #111827;
      transform: scale(1.05);
    }

    /* Softer delete (no aggressive red) */
    .icon-btn.delete-btn {
      background: #fef2f2;
      color: #b91c1c;
    }

    .icon-btn.delete-btn:hover {
      background: #fee2e2;
      color: #7f1d1d;
    }

    /* Inline edit input */
    .contact-edit-input {
      border-radius: 999px;
      border: 2px solid #d1d5db;
      padding: 4px 10px;
      font-size: 14px;
      font-weight: 600;
      width: 160px;
      transition: all 0.2s ease;
    }

    .contact-edit-input:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Empty state */
    .contacts-empty {
      color: #6b7280;
      font-size: 14px;
      padding: 12px 0;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üí∞ SettleUp</h1>

    <!-- Connect Wallet -->
    <div class="card" id="connectCard">
      <h2>üîó Connect Wallet</h2>
      <button class="btn-primary" id="connectBtn">Connect MetaMask</button>
      <div id="connectStatus"></div>
    </div>

    <!-- Wallet Info -->
    <div class="card hidden" id="walletCard">
      <h2>üëõ Wallet Connected</h2>
      <div id="walletInfo"></div>
    </div>

    <!-- Add Expense -->
    <div class="card hidden" id="expenseCard">
      <h2>üìù Add Expense</h2>
      
      <div class="info-box">
        <strong>How it works:</strong> Enter the total bill. Select who paid. Select everyone who shared the expense (including the payer). The cost is split equally.
      </div>
      
      <div class="form-group">
        <label>Total Amount (USDC)</label>
        <input type="number" id="expenseAmount" placeholder="100.00" step="0.01" max="1000000" />
      </div>
      
      <div class="form-group">
        <label>Category</label>
        <select id="expenseCategory">
          <option value="Food">üçï Food</option>
          <option value="Transport">üöó Transport</option>
          <option value="Entertainment">üé¨ Entertainment</option>
          <option value="Utilities">üí° Utilities</option>
          <option value="Other">üì¶ Other</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Who Paid? <span class="label-hint">(click one)</span></label>
        <div id="payerChips"></div>
      </div>
      
      <div class="form-group">
        <label>Who Shared the Bill? <span class="label-hint">(click all who participated, including payer)</span></label>
        <div id="participantChips"></div>
      </div>
      
      <div id="splitPreview" style="background:#f0fdf4;border:2px solid #86efac;border-radius:10px;padding:12px;margin-bottom:16px;font-size:14px;display:none;"></div>
      
      <button class="btn-primary" id="addExpenseBtn">üí≥ Record Expense</button>
      <div id="expenseStatus"></div>
    </div>

    <!-- Balances -->
    <div class="card hidden" id="balancesCard">
      <h2>üíµ Balances <button class="btn-secondary" id="refreshBtn" style="width:auto;float:right;padding:8px 16px;margin:0;">üîÑ Refresh</button></h2>
      <div style="clear:both;"></div>
      <div id="balancesList" style="margin-top:16px;"></div>
    </div>

    <!-- Contacts -->
    <div class="card hidden" id="contactsCard">
      <h2>üë• Contacts</h2>
      <div id="contactsList"></div>
      <div class="form-group" style="margin-top:16px;">
        <input type="text" id="newContactAddr" placeholder="Address (0x...)" />
        <input type="text" id="newContactName" placeholder="Name" style="margin-top:8px;" />
        <button class="btn-green" id="addContactBtn" style="margin-top:8px;">+ Add Contact</button>
      </div>
    </div>
  </div>

  <script>
    // ========== CONFIGURATION ==========
    const CONTRACT_ADDRESS = "0x87DE5D58F0d25Db2A7F3E8af264AFCd82e9e87dC";
    const USDC_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";
    const CATEGORIES = ["Food", "Transport", "Entertainment", "Utilities", "Other"];

    // ========== CONTRACT ABI ==========
    const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"usdcAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"creditor","type":"address"},{"indexed":true,"internalType":"address","name":"debtor","type":"address"},{"indexed":false,"internalType":"uint256","name":"oldAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"newAmount","type":"uint256"},{"indexed":false,"internalType":"string","name":"category","type":"string"}],"name":"BalanceAdjusted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"totalAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"sharePerPerson","type":"uint256"},{"indexed":false,"internalType":"address[]","name":"participants","type":"address[]"},{"indexed":false,"internalType":"string","name":"category","type":"string"}],"name":"ExpenseAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"debtor","type":"address"},{"indexed":true,"internalType":"address","name":"creditor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"category","type":"string"}],"name":"Settled","type":"event"},{"inputs":[],"name":"MAX_BALANCE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_PARTICIPANTS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"address","name":"payer","type":"address"},{"internalType":"address[]","name":"participants","type":"address[]"},{"internalType":"string","name":"category","type":"string"}],"name":"addExpense","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"debtor","type":"address"},{"internalType":"uint256","name":"newAmount","type":"uint256"},{"internalType":"string","name":"category","type":"string"}],"name":"adjustBalance","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"},{"internalType":"string","name":"","type":"string"}],"name":"balances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"debtor","type":"address"},{"internalType":"string","name":"category","type":"string"}],"name":"creditFrom","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"creditor","type":"address"},{"internalType":"string","name":"category","type":"string"}],"name":"debtTo","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"debtor","type":"address"},{"internalType":"address","name":"creditor","type":"address"},{"internalType":"string","name":"category","type":"string"}],"name":"getBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getConstants","outputs":[{"internalType":"uint256","name":"maxBalance","type":"uint256"},{"internalType":"uint256","name":"maxParticipants","type":"uint256"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"address","name":"creditor","type":"address"},{"internalType":"string","name":"category","type":"string"}],"name":"settle","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"usdc","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"}];

    const USDC_ABI = ["function balanceOf(address) view returns (uint256)","function allowance(address,address) view returns (uint256)","function approve(address,uint256) returns (bool)"];

    // ========== STATE ==========
    let provider, signer, contract, usdcContract;
    let account = null;
    let contacts = {};
    let selectedPayer = null;
    let selectedSplitters = [];

    // ========== UTILITIES ==========
    function shortAddr(addr) {
      return addr ? addr.slice(0, 6) + "..." + addr.slice(-4) : "";
    }

    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.className = `status ${type}`;
      el.textContent = message;
    }

    function getContactName(addr) {
      const normalized = addr.toLowerCase();
      if (normalized === account?.toLowerCase()) return "Me";
      return contacts[normalized] || shortAddr(addr);
    }

    // ========== CONTACTS ==========
    function loadContacts() {
      const stored = localStorage.getItem("settleup_contacts_v6");
      if (stored) {
        try { contacts = JSON.parse(stored); }
        catch (e) { contacts = {}; }
      }
    }

    function saveContacts() {
      localStorage.setItem("settleup_contacts_v6", JSON.stringify(contacts));
    }

    function addContact(addr, name) {
      if (!ethers.utils.isAddress(addr)) {
        alert("Invalid address");
        return;
      }
      const normalized = addr.toLowerCase();
      if (normalized === account?.toLowerCase()) {
        alert("You can't add yourself as a contact!");
        return;
      }
      contacts[normalized] = name || shortAddr(addr);
      saveContacts();
      renderAll();
    }

    function renderContacts() {
      const list = document.getElementById("contactsList");
      list.innerHTML = "";
      const otherContacts = Object.entries(contacts).filter(
        ([addr]) => addr !== account?.toLowerCase()
      );

      if (otherContacts.length === 0) {
        list.innerHTML =
          "<p class='contacts-empty'>No contacts yet. Add friends to split bills with!</p>";
        return;
      }

      otherContacts.forEach(([addr, name]) => {
        const wrapper = document.createElement("div");
        wrapper.className = "contact-item";

        const info = document.createElement("div");
        info.className = "contact-info";

        const nameRow = document.createElement("div");
        nameRow.className = "contact-name-row";

        const nameEl = document.createElement("span");
        nameEl.className = "contact-name";
        nameEl.textContent = name;

        nameRow.appendChild(nameEl);

        const addrEl = document.createElement("div");
        addrEl.className = "contact-address";
        addrEl.textContent = shortAddr(addr);

        info.appendChild(nameRow);
        info.appendChild(addrEl);

        const actions = document.createElement("div");
        actions.className = "contact-actions";

        const editBtn = document.createElement("button");
        editBtn.className = "icon-btn";
        editBtn.type = "button";
        editBtn.title = "Edit name";
        editBtn.innerHTML = "‚úèÔ∏è";
        editBtn.onclick = () => startEditContact(addr, nameEl);

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "icon-btn delete-btn";
        deleteBtn.type = "button";
        deleteBtn.title = "Remove contact";
        deleteBtn.innerHTML = "üóë";
        deleteBtn.onclick = () => deleteContact(addr);

        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);

        wrapper.appendChild(info);
        wrapper.appendChild(actions);
        list.appendChild(wrapper);
      });
    }

    function startEditContact(addr, nameElement) {
      const currentName = contacts[addr.toLowerCase()] || nameElement.textContent;
      const input = document.createElement("input");
      input.type = "text";
      input.value = currentName;
      input.className = "contact-edit-input";

      // Replace text span with input
      const parent = nameElement.parentNode;
      parent.replaceChild(input, nameElement);
      input.focus();
      input.select();

      const finish = () => finishEditContact(addr, input, nameElement);

      input.addEventListener("blur", finish);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") finish();
        if (e.key === "Escape") {
          input.value = currentName;
          finish();
        }
      });
    }

    function finishEditContact(addr, input, nameElement) {
      const newName = input.value.trim() || shortAddr(addr);
      contacts[addr.toLowerCase()] = newName;
      saveContacts();

      nameElement.textContent = newName;
      const parent = input.parentNode;
      parent.replaceChild(nameElement, input);
    }

    function deleteContact(addr) {
      const name = contacts[addr.toLowerCase()] || shortAddr(addr);
      const confirmed = confirm(
        `Remove ${name} from your contacts?\n\nThis does NOT affect any on-chain balances or debts.`
      );
      if (!confirmed) return;

      delete contacts[addr.toLowerCase()];
      saveContacts();
      renderAll();
    }

    // ========== CHIPS ==========
    function renderPayerChips() {
      const container = document.getElementById("payerChips");
      container.innerHTML = "";
      if (account) {
        const meChip = document.createElement("span");
        meChip.className = "contact-chip" + (selectedPayer === account.toLowerCase() ? " selected" : "");
        meChip.textContent = "üë§ Me";
        meChip.onclick = () => { selectedPayer = account.toLowerCase(); renderAll(); };
        container.appendChild(meChip);
      }
      Object.entries(contacts).forEach(([addr, name]) => {
        if (addr === account?.toLowerCase()) return;
        const chip = document.createElement("span");
        chip.className = "contact-chip" + (selectedPayer === addr ? " selected" : "");
        chip.textContent = name;
        chip.onclick = () => { selectedPayer = addr; renderAll(); };
        container.appendChild(chip);
      });
    }

    function renderSplitterChips() {
      const container = document.getElementById("participantChips");
      container.innerHTML = "";
      if (account) {
        const meChip = document.createElement("span");
        meChip.className = "contact-chip" + (selectedSplitters.includes(account.toLowerCase()) ? " selected" : "");
        meChip.textContent = "üë§ Me";
        meChip.onclick = () => toggleSplitter(account.toLowerCase());
        container.appendChild(meChip);
      }
      Object.entries(contacts).forEach(([addr, name]) => {
        if (addr === account?.toLowerCase()) return;
        const chip = document.createElement("span");
        chip.className = "contact-chip" + (selectedSplitters.includes(addr) ? " selected" : "");
        chip.textContent = name;
        chip.onclick = () => toggleSplitter(addr);
        container.appendChild(chip);
      });
    }

    function toggleSplitter(addr) {
      const idx = selectedSplitters.indexOf(addr);
      if (idx >= 0) selectedSplitters.splice(idx, 1);
      else selectedSplitters.push(addr);
      renderAll();
    }

    function updateSplitPreview() {
      const preview = document.getElementById("splitPreview");
      const amountInput = document.getElementById("expenseAmount").value;
      const amount = parseFloat(amountInput) || 0;
      if (amount <= 0 || !selectedPayer || selectedSplitters.length === 0) {
        preview.style.display = "none";
        return;
      }
      if (amount > 1000000) {
        preview.innerHTML = `<strong>‚ö†Ô∏è Amount exceeds 1M USDC limit</strong>`;
        preview.style.display = "block";
        return;
      }
      const share = amount / selectedSplitters.length;
      const payerName = getContactName(selectedPayer);
      const debtors = selectedSplitters.filter(addr => addr !== selectedPayer);
      if (debtors.length === 0) {
        preview.innerHTML = `<strong>‚ö†Ô∏è No one owes anything</strong><br>Select at least one other person who shared the bill.`;
        preview.style.display = "block";
        return;
      }
      let html = `<strong>üí° Split Preview:</strong><br>Total: $${amount.toFixed(2)} √∑ ${selectedSplitters.length} people = $${share.toFixed(2)} each<br><br>`;
      debtors.forEach(addr => {
        html += `‚Ä¢ ${getContactName(addr)} owes ${payerName}: <strong>$${share.toFixed(2)}</strong><br>`;
      });
      preview.innerHTML = html;
      preview.style.display = "block";
    }

    function renderAll() {
      renderContacts();
      renderPayerChips();
      renderSplitterChips();
      updateSplitPreview();
    }

    // ========== WALLET CONNECTION ==========
    async function connectWallet() {
      if (!window.ethereum) {
        showStatus("connectStatus", "MetaMask not found!", "error");
        return;
      }
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        account = await signer.getAddress();
        const network = await provider.getNetwork();
        if (network.chainId !== 8453) {
          try {
            await window.ethereum.request({
              method: "wallet_switchEthereumChain",
              params: [{ chainId: "0x2105" }]
            });
            location.reload();
            return;
          } catch (e) {
            showStatus("connectStatus", "Please switch to Base Mainnet!", "error");
            return;
          }
        }
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        usdcContract = new ethers.Contract(USDC_ADDRESS, USDC_ABI, signer);
        loadContacts();
        const myAddr = account.toLowerCase();
        if (contacts[myAddr]) {
          delete contacts[myAddr];
          saveContacts();
        }
        selectedPayer = account.toLowerCase();
        selectedSplitters = [account.toLowerCase()];
        document.getElementById("connectCard").classList.add("hidden");
        document.getElementById("walletCard").classList.remove("hidden");
        document.getElementById("expenseCard").classList.remove("hidden");
        document.getElementById("balancesCard").classList.remove("hidden");
        document.getElementById("contactsCard").classList.remove("hidden");
        const usdcBal = await usdcContract.balanceOf(account);
        document.getElementById("walletInfo").innerHTML = `<p><strong>Address:</strong> ${shortAddr(account)}</p><p><strong>USDC Balance:</strong> ${parseFloat(ethers.utils.formatUnits(usdcBal, 6)).toFixed(2)} USDC</p>`;
        renderAll();
        await refreshBalances();
      } catch (e) {
        showStatus("connectStatus", e.message, "error");
      }
    }

    // ========== ADD EXPENSE ==========
    async function addExpense() {
      const amountInput = document.getElementById("expenseAmount").value;
      const category = document.getElementById("expenseCategory").value;
      if (!amountInput || parseFloat(amountInput) <= 0) {
        showStatus("expenseStatus", "Enter a valid amount", "error");
        return;
      }
      if (parseFloat(amountInput) > 1000000) {
        showStatus("expenseStatus", "Amount exceeds 1M USDC limit", "error");
        return;
      }
      if (!selectedPayer) {
        showStatus("expenseStatus", "Select who paid", "error");
        return;
      }
      if (selectedSplitters.length < 2) {
        showStatus("expenseStatus", "Select at least 2 people who shared the bill", "error");
        return;
      }
      if (selectedSplitters.length > 50) {
        showStatus("expenseStatus", "Maximum 50 participants allowed", "error");
        return;
      }
      const participants = selectedSplitters.filter(addr => addr !== selectedPayer);
      if (participants.length === 0) {
        showStatus("expenseStatus", "No one owes the payer! Select others who shared the bill.", "error");
        return;
      }
      const amount = ethers.utils.parseUnits(amountInput, 6);
      const payerChecksum = ethers.utils.getAddress(selectedPayer);
      const participantsChecksum = participants.map(p => ethers.utils.getAddress(p));
      const btn = document.getElementById("addExpenseBtn");
      btn.disabled = true;
      showStatus("expenseStatus", "Sending transaction...", "info");
      try {
        const tx = await contract.addExpense(amount, payerChecksum, participantsChecksum, category);
        showStatus("expenseStatus", "Waiting for confirmation...", "info");
        await tx.wait();
        showStatus("expenseStatus", `‚úÖ Expense recorded!`, "success");
        document.getElementById("expenseAmount").value = "";
        selectedSplitters = [account.toLowerCase()];
        renderAll();
        for (const p of participants) {
          if (!contacts[p.toLowerCase()]) {
            const name = prompt(`Save ${shortAddr(p)} as contact:`, shortAddr(p));
            if (name && name.trim()) addContact(p, name.trim());
          }
        }
        await new Promise(r => setTimeout(r, 3000));
        await refreshBalances();
      } catch (e) {
        showStatus("expenseStatus", `Error: ${e.reason || e.message}`, "error");
      } finally {
        btn.disabled = false;
      }
    }

    // ========== REFRESH BALANCES ==========
    async function refreshBalances() {
      const list = document.getElementById("balancesList");
      list.innerHTML = "<p>Loading...</p>";
      const balances = [];
      const contactAddrs = Object.keys(contacts).filter(a => a !== account.toLowerCase());
      if (contactAddrs.length === 0) {
        list.innerHTML = "<p style='color:#888;'>Add contacts to see balances with them.</p>";
        return;
      }
      for (const contactAddr of contactAddrs) {
        for (const category of CATEGORIES) {
          try {
            await new Promise(r => setTimeout(r, 100));
            const contactChecksum = ethers.utils.getAddress(contactAddr);
            const accountChecksum = ethers.utils.getAddress(account);
            const theyOweUs = await contract.getBalance(contactChecksum, accountChecksum, category);
            const weOweThem = await contract.getBalance(accountChecksum, contactChecksum, category);
            if (!theyOweUs.isZero()) {
              balances.push({ contact: contactAddr, category, type: "credit", amount: theyOweUs });
            }
            if (!weOweThem.isZero()) {
              balances.push({ contact: contactAddr, category, type: "debt", amount: weOweThem });
            }
          } catch (e) {
            console.error(`Error checking ${contactAddr}/${category}:`, e);
          }
        }
      }
      if (balances.length === 0) {
        list.innerHTML = "<p style='color:#888;'>‚ú® All settled up! No outstanding balances.</p>";
        return;
      }
      list.innerHTML = "";
      for (const b of balances) {
        const contactName = getContactName(b.contact);
        const amountStr = parseFloat(ethers.utils.formatUnits(b.amount, 6)).toFixed(2);
        const card = document.createElement("div");
        card.className = "balance-card";
        if (b.type === "credit") {
          card.innerHTML = `<div class="balance-amount positive">+ ${amountStr} USDC</div><div class="balance-details">${contactName} owes you ‚Ä¢ ${b.category}</div><button class="btn-secondary" style="margin-top:10px;width:auto;padding:8px 16px;" onclick="adjustBalancePrompt('${b.contact}', '${b.category}', '${amountStr}')">‚úèÔ∏è Adjust</button>`;
        } else {
          card.innerHTML = `<div class="balance-amount negative">- ${amountStr} USDC</div><div class="balance-details">You owe ${contactName} ‚Ä¢ ${b.category}</div><button class="btn-green" style="margin-top:10px;width:auto;padding:8px 16px;" onclick="settleBalance('${b.contact}', '${b.category}')">üí≥ Pay Now</button>`;
        }
        list.appendChild(card);
      }
    }

    // ========== ADJUST BALANCE ==========
    async function adjustBalancePrompt(debtor, category, currentAmountStr) {
      const name = getContactName(debtor);
      const input = prompt(`Set new amount that ${name} owes you for ${category}.\n(Current: ${currentAmountStr} USDC)\nEnter 0 to clear:`, currentAmountStr);
      if (input === null) return;
      const value = parseFloat(input);
      if (isNaN(value) || value < 0) {
        alert("Enter a non-negative number.");
        return;
      }
      if (value > 1000000) {
        alert("Amount exceeds 1M USDC limit.");
        return;
      }
      try {
        const debtorChecksum = ethers.utils.getAddress(debtor);
        const newAmount = ethers.utils.parseUnits(value.toString(), 6);
        const tx = await contract.adjustBalance(debtorChecksum, newAmount, category);
        await tx.wait();
        await new Promise(r => setTimeout(r, 2000));
        await refreshBalances();
      } catch (e) {
        alert("Adjust failed: " + (e.reason || e.message));
      }
    }

    // ========== SETTLE ==========
    async function settleBalance(creditor, category) {
      const name = getContactName(creditor);
      if (!confirm(`Pay your ${category} balance to ${name}?`)) return;
      try {
        const creditorChecksum = ethers.utils.getAddress(creditor);
        const balance = await contract.getBalance(account, creditorChecksum, category);
        if (balance.isZero()) {
          alert("No balance to settle!");
          return;
        }
        const allowance = await usdcContract.allowance(account, CONTRACT_ADDRESS);
        if (allowance.lt(balance)) {
          const approveTx = await usdcContract.approve(CONTRACT_ADDRESS, balance);
          await approveTx.wait();
        }
        const tx = await contract.settle(creditorChecksum, category);
        await tx.wait();
        await new Promise(r => setTimeout(r, 2000));
        await refreshBalances();
        const usdcBal = await usdcContract.balanceOf(account);
        document.getElementById("walletInfo").innerHTML = `<p><strong>Address:</strong> ${shortAddr(account)}</p><p><strong>USDC Balance:</strong> ${parseFloat(ethers.utils.formatUnits(usdcBal, 6)).toFixed(2)} USDC</p>`;
      } catch (e) {
        alert("Settlement failed: " + (e.reason || e.message));
      }
    }

    // ========== EVENT LISTENERS ==========
    document.getElementById("connectBtn").onclick = connectWallet;
    document.getElementById("addExpenseBtn").onclick = addExpense;
    document.getElementById("refreshBtn").onclick = refreshBalances;
    document.getElementById("expenseAmount").oninput = updateSplitPreview;
    document.getElementById("addContactBtn").onclick = () => {
      const addr = document.getElementById("newContactAddr").value.trim();
      const name = document.getElementById("newContactName").value.trim();
      if (addr) {
        addContact(addr, name || shortAddr(addr));
        document.getElementById("newContactAddr").value = "";
        document.getElementById("newContactName").value = "";
      } else {
        alert("Enter an address");
      }
    };
  </script>
</body>
</html>
